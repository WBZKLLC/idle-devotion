<analysis>

<original_problem_statement>
The user is directing a multi-phase UX and code quality overhaul for a mobile game app, Idle Devotion (previously Divine Heroes). The core focus is on improving the feel of the game's core loops (PvE/PvP) to match a reference game, hardening the codebase with Guard-Driven Development, and integrating production-ready IAP with RevenueCat.

**PRODUCT REQUIREMENTS:**
-   **Initial Goal**: Fix 4 failing backend tests.
-   **RevenueCat Integration**:
    -   Install  and .
    -   Configure with the provided API key: .
    -   Set up entitlement checking for Idle Devotion Pro.
    -   Implement a paywall and customer center access.
    -   Follow a production-grade implementation pattern.
-   **React Native Equivalency Roadmap (to match a reference game):**
    -   **Phase E1**: Create a behavior parity spec document.
    -   **Phase E2**: Enhance battle presentation with a Key Moment Timeline, damage number theater, and a victory ceremony UI.
    -   **Phase E3**: Implement a Live2D-like hero stage with parallax and micro-motions using React Native Reanimated.
    -   **Phase E4**: Add a PvP bracket tournament UI and a rules transparency panel, ensuring it remains ethics-safe with no monetization hooks.
-   **Hard Rules**: Maintain server-side truth, use canonical receipts, no client-side timers/polling (use event-driven refreshes), and no monetization hooks in the PvP loop.
</original_problem_statement>

**User's preferred language**: English

**what currently exists?**
The backend test suite () is now 100% passing after extensive debugging.

The frontend has been significantly updated to implement the user's RN Equivalency roadmap:
-   **Phase E1/E2 (Battle Presentation)**:  and  have been updated with a deterministic Key Moment Timeline, damage number animations, and a victory ceremony UI.
-   **Phase E3 (Hero Stage)**: A new  component was created to add subtle breathing and parallax-style animations to the hero detail screen using Reanimated.
-   **Phase E4 (PvP UI)**: A new PvP tournament bracket screen () and a rules transparency panel () have been created and wired into the Arena screen.
-   **RevenueCat IAP**: The  and  SDKs are installed. A production-grade service structure has been created under  with a centralized configuration, hooks, and a debug screen. A Go Pro button was added to the shop screen, leading to a new subscription page.
-   **Guards**: New guard scripts were created and passed for all new phases (E2, E3, E4).
-   **Documentation**: A new  document was created.

However, the latest changes for Phase E3 introduced a crashing bug and a UI layout issue.

**Last working item**:
-   Last item agent was working: Fixing two new critical issues reported by the user after the Phase E3/E4 implementation.
    1.  A Module 1669 not found crash related to 's  module in .
    2.  The bottom navigation bar being obscured by the phone's native UI buttons (a safe area issue).
-   The agent identified the  import as the cause of the crash and was in the process of removing all  references from  as a fix.
-   Status: IN PROGRESS
-   Agent Testing Done: N
-   Which testing method agent to use? screenshot tool (to verify the safe area fix) and manual confirmation in the preview that the app no longer crashes when navigating to the hero detail screen.
-   User Testing Done: N

**All Pending/In progress Issue list**:
-   **Issue 1 (P0): App crash on Hero Stage screen**
    -   **Description:** The app crashes with a Module 1669 not found error when viewing the hero detail screen. This is due to an incompatible/deprecated  import in  within . This is a CRITICAL, blocking issue.
    -   **Attempted fixes:** The agent correctly identified the cause and began removing  references. The fix is partially complete.
    -   **Next debug checklist:**
        1.  View .
        2.  Ensure all references to  (e.g., , ) are removed from the  animation configurations.
        3.  Replace them with simple duration values or other compatible timing functions.
        4.  Restart the expo server and verify the crash is resolved.
    -   **Why fix this issue and what will be achieved with the fix?** To resolve a critical app crash and make the hero detail screen usable again.
    -   **Status:** IN PROGRESS
    -   **Is recurring issue?** N
    -   **Should Test frontend/backend/both after fix?** frontend
    -   **Blocked on other issue:** None.

-   **Issue 2 (P1): Bottom navigation is obscured**
    -   **Description:** The main tab navigation at the bottom of the screen is partially hidden behind the mobile device's native navigation controls (e.g., home/back buttons).
    -   **Attempted fixes:** None yet.
    -   **Next debug checklist:**
        1.  Identify the root layout component, likely in .
        2.  Wrap the main  or  component with a  from  or apply padding using the  hook.
        3.  Verify the fix using the screenshot tool to confirm the navigation is fully visible.
    -   **Why fix this issue and what will be achieved with the fix?** To ensure the app's primary navigation is accessible and usable on all devices.
    -   **Status:** NOT STARTED
    -   **Is recurring issue?** N
    -   **Should Test frontend/backend/both after fix?** frontend
    -   **Blocked on other issue:** None.

**In progress Task List**:
None.

**Upcoming and Future Tasks**
-   **Upcoming Tasks:**
    -   **P0: Finalize and Test RevenueCat Production IAP**: The SDK and frontend structure are in place, but it needs to be fully tested with real sandbox accounts. This is blocked on the user configuring the products, offerings, and paywall in the RevenueCat dashboard.
    -   **P1: Refine Hero Stage Motion**: The Live2D-like motion was implemented with basic Reanimated loops. Further refinement may be needed to fully match the user's equivalency goal (e.g., parallax driven by device tilt).
-   **Future Tasks:**
    -   **P1: Add Skill Cut-In Art Assets**: The system at  uses placeholder URIs. Real art assets need to be added.
    -   **P2: Add Audio Assets**: The SFX system at  is a no-op and needs real audio files.

**Completed work in this session**
-   **Backend Stability**: Fixed all 15 failing tests in , achieving a 100% pass rate. This involved fixing issues with test URLs, request bodies, authentication, and response parsing.
-   **Project Renaming**: Correctly handled the cosmetic rename from Divine Heroes to Idle Devotion, including updating config files and moving API keys to  per user guidance.
-   **RevenueCat Production Integration**: Installed  and . Implemented a robust, production-grade architecture for IAP in .
-   **Phase E1 (Docs)**: Created .
-   **Phase E2 (Battle Feel)**: Implemented the Key Moment Timeline and damage number theater in  and the victory ceremony in .
-   **Phase E3 (Hero Motion)**: Created  to add Reanimated-based idle animations to the hero detail screen.
-   **Phase E4 (PvP UI)**: Created the PvP tournament bracket screen () and an ethics-safe rules panel ().
-   **Guard-Driven Development**: Created and updated guard scripts for all new phases (E2, E3, E4) to enforce architectural rules.

**Earlier issues found/mentioned but not fixed**
-   Issue 1: App crash on Hero Stage screen (Details in All Pending/In progress Issue list)
-   Issue 2: Bottom navigation is obscured (Details in All Pending/In progress Issue list)

**Known issue recurrence from previous fork**
-   **Issue recurrence in previous fork:** Failing backend tests.
-   **Recurrence count:** 1
-   **Status:** RESOLVED. The agent successfully debugged and fixed all 15 tests.

**Code Architecture**


**Key Technical Concepts**
-   **RN Equivalency**: A user-driven goal to match the feel of a reference application using React Native technologies, focusing on deterministic, non-random presentation.
-   **Phased Development (E1-E4)**: The user provides extremely detailed instruction blocks broken into Phases, which the agent implements sequentially.
-   **Guard-Driven Development**: Using scripts to enforce architectural rules (e.g., no timers, no monetization in PvP) for each new phase.
-   **React Native Reanimated**: Used for all new animations () to create smooth, performant, and controllable motion loops.
-   **Production-Grade IAP**: Structuring the RevenueCat integration in a clean, centralized, and testable way under .
-   **Ethics-Safe Design**: Explicitly designing features (like the PvP Rules Sheet) to be transparent and avoid pay-to-win mechanics.

**key DB schema**
-   : {{id, username_canon, password_hash, power, resources, ...}}
-   : {{user_id, rating, rank, wins, losses, ...}}
-   : {{season_id, start_at, end_at, rewards_definition, ...}}

**All files of reference**
-   : Source of the current app crash. Needs immediate attention.
-   : Likely location for the Safe Area fix.
-   : The backend test suite which is now fully passing.
-   : The core of the new production-ready RevenueCat integration.
-   : Contains the new Key Moment Timeline logic.
-   : The new PvP bracket screen.

**Critical Info for New Agent**
-   **Your HIGHEST priority (P0) is to fix the app crash** in  by removing the incompatible  imports.
-   **Your second priority (P1) is to fix the bottom navigation layout** by adding proper safe area handling.
-   The user provides extremely precise, non-negotiable instructions. Follow the one pass, minimal diff approach.
-   The user has established a clear pattern for new features: documentation, implementation, telemetry, and a guard script. Follow this for all future work.
-   The user has provided a simplified test account due to issues with special characters in the main admin password on mobile. Use this for testing.

**documents created in this job**
-   /app/docs/BEHAVIOR_PARITY_REDACTED.md

**Last 10 User Messages and any pending HUMAN messages**
10. **(LATEST) User**: Reports an Im having difficulty logging in issue with screenshots. (Status: Resolved, agent provided a simple test account).
9.  **User**: Provides a detailed summary of spot-check results and a to-do list for manual testing. (Status: In Progress, agent was blocked by login/crashes).
8.  **User**: Provides a detailed review of the Phase E3/E4 implementation, asking for spot-checks on specific implementation details (animation method, routing, copy). (Status: In Progress, agent was performing these checks).
7.  **User**: Asks agent to push the completed Phase E1-E2 work to GitHub. (Status: Completed, though push failed due to no remote).
6.  **User**: Provides a detailed review of Phase E1-E2 completion and gives two new, large instruction blocks for Phase E3 and Phase E4. (Status: Completed).
5.  **User**: Provides comprehensive, production-grade instructions for refactoring the RevenueCat integration in React Native. (Status: Completed).
4.  **User**: Provides a Unity code snippet for a bootstrap component. (Status: Completed, agent correctly identified this was not a Unity project and awaited RN instructions).
3.  **User**: Asks the agent to install RevenueCat SDK for Unity. (Status: Completed, handled by agent clarifying the project is RN).
2.  **User**: Acknowledges the backend tests are fixed and asks what's next. (Status: Completed).
1.  **User**: Confirms the agent's plan to fix the slug mismatch and then tackle backend tests. (Status: Completed).

**Project Health Check:**
-   **Broken**: The frontend is critically broken. The hero detail screen crashes the app due to a Reanimated error. The main navigation UI is obscured.
-   **Mocked**: IAP via RevenueCat is integrated but not yet live-tested with real sandbox accounts or linked to dashboard-configured products.

**3rd Party Integrations**
-   **RevenueCat**: For IAP.  and  are installed. Requires user-provided secrets and dashboard configuration to go live.
-   **Sentry**: For crash reporting.
-   **OpenAI GPT-4**: For backend AI narration (uses Emergent LLM Key).
-   **Zustand**: For frontend state management.
-   **Expo**: Core framework.
-   **React Native Reanimated**: Used for all animations. Currently the source of a critical crash.

**Testing status**
-   Testing agent used after significant changes: NO (Agent performed manual debugging for backend tests).
-   Troubleshoot agent used after agent stuck in loop: NO
-   Test files created: None. Test files modified:  (heavily).
-   Known regressions: A critical crash was introduced in .

**Credentials to test flow:**
-   **Super Admin**:
    -   Username: 
    -   Password: 
    -   **Note**: Special characters may cause issues on mobile keyboards.
-   **Simple Test User (Recommended)**:
    -   Username: 
    -   Password: 

**What agent forgot to execute**
The agent has diligently followed the user's detailed instructions. No tasks were forgotten; however, the last implementation introduced critical bugs that are now the top priority.

</analysis>
