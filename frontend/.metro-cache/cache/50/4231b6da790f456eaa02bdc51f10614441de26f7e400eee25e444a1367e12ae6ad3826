{"dependencies":[{"name":"react-native-web/dist/exports/Alert","data":{"asyncType":null,"isESMImport":false,"locs":[],"key":"PEUC6jrQVoAGZ2qYkvimljMOyJI=","exportNames":["*"],"imports":1}},{"name":"./api","data":{"asyncType":null,"isESMImport":true,"locs":[{"start":{"line":7,"column":0,"index":251},"end":{"line":7,"column":47,"index":298}}],"key":"FbKPDeRJ9TF3vg1eKYKz12urgic=","exportNames":["*"],"imports":1}},{"name":"../stores/networkStore","data":{"asyncType":null,"isESMImport":true,"locs":[{"start":{"line":8,"column":0,"index":299},"end":{"line":8,"column":57,"index":356}}],"key":"ixdoEhjLNW8i2Hfhg3SedQ7tLZs=","exportNames":["*"],"imports":1}}],"output":[{"data":{"code":"__d(function (global, require, _$$_IMPORT_DEFAULT, _$$_IMPORT_ALL, module, exports, _dependencyMap) {\n  \"use strict\";\n\n  Object.defineProperty(exports, '__esModule', {\n    value: true\n  });\n  function _interopDefault(e) {\n    return e && e.__esModule ? e : {\n      default: e\n    };\n  }\n  exports.isOnline = isOnline;\n  exports.safeMutation = safeMutation;\n  exports.isMutationSuccess = isMutationSuccess;\n  exports.createMutationExecutor = createMutationExecutor;\n  exports.preventOptimisticUpdate = preventOptimisticUpdate;\n  var _reactNativeWebDistExportsAlert = require(_dependencyMap[0], \"react-native-web/dist/exports/Alert\");\n  var Alert = _interopDefault(_reactNativeWebDistExportsAlert);\n  var _api = require(_dependencyMap[1], \"./api\");\n  var _storesNetworkStore = require(_dependencyMap[2], \"../stores/networkStore\");\n  // /app/frontend/lib/safeMutation.ts\n  // SAFE MUTATION WRAPPER\n  // Enforces consistent loading/success/failure patterns for all state mutations\n  // Prevents optimistic updates and ensures server-authoritative state\n\n  /**\n   * Check if device is online\n   */\n  function isOnline() {\n    return _storesNetworkStore.useNetworkStore.getState().isOnline;\n  }\n\n  /**\n   * Structured result type for safeMutation\n   * Preserves server error details while providing consistent interface\n   */\n\n  /**\n   * Options for safeMutation\n   */\n\n  /**\n   * Extract error detail from various error formats\n   */\n  function getErrorDetail(error) {\n    return error?.response?.data?.detail || error?.message || 'Something went wrong';\n  }\n\n  /**\n   * Safe mutation wrapper that enforces consistent patterns:\n   * 1. Always awaits the server response\n   * 2. Optionally refreshes user state after success\n   * 3. Returns structured result { ok, data } or { ok, error, detail }\n   * 4. Never assumes success - state only updates after server confirms\n   * 5. Respects global error handling - won't duplicate alerts\n   * \n   * @param actionName - Name of the action for logging\n   * @param fn - The async mutation function to execute\n   * @param opts - Options for customizing behavior\n   * @returns Structured result with ok/data or ok/error/detail\n   * \n   * @example\n   * ```tsx\n   * const result = await safeMutation(\n   *   'pullGacha',\n   *   () => apiPullGacha(username, 'single', 'coins'),\n   *   { \n   *     refreshUser: true, \n   *     fetchUserFn: fetchUser,\n   *     onSuccess: (data) => setHeroes(data.heroes)\n   *   }\n   * );\n   * \n   * if (result.ok) {\n   *   // Use result.data\n   * } else {\n   *   // result.error and result.detail available\n   * }\n   * ```\n   */\n  async function safeMutation(actionName, fn, opts = {}) {\n    const {\n      onSuccess,\n      onError,\n      refreshUser = true,\n      fetchUserFn,\n      showErrorAlert = true,\n      errorMessage\n    } = opts;\n\n    // Fast-fail if offline - don't attempt network calls\n    if (!isOnline()) {\n      const offlineError = new Error('OFFLINE');\n      const detail = 'No internet connection. Please check your connection and try again.';\n      if (showErrorAlert) {\n        Alert.default.alert('Offline', detail);\n      }\n      if (onError) onError(offlineError);\n      return {\n        ok: false,\n        error: offlineError,\n        detail\n      };\n    }\n    try {\n      if (__DEV__) console.log(`[safeMutation] Starting: ${actionName}`);\n\n      // Execute the mutation - ALWAYS await server response\n      const data = await fn();\n      if (__DEV__) console.log(`[safeMutation] Success: ${actionName}`);\n\n      // Refresh user state from server (authoritative source)\n      if (refreshUser && fetchUserFn) {\n        try {\n          await fetchUserFn();\n        } catch (refreshError) {\n          console.error(`[safeMutation] Failed to refresh user after ${actionName}:`, refreshError);\n          // Don't fail the mutation if refresh fails - the mutation succeeded\n        }\n      }\n\n      // Call success callback\n      if (onSuccess) {\n        await onSuccess(data);\n      }\n      return {\n        ok: true,\n        data\n      };\n    } catch (error) {\n      const detail = getErrorDetail(error);\n      console.error(`[safeMutation] Failed: ${actionName}`, error);\n\n      // Call error callback\n      if (onError) {\n        onError(error);\n      }\n\n      // Only show alert if:\n      // 1. showErrorAlert is true\n      // 2. Error was NOT already handled by global interceptor\n      if (showErrorAlert && !(0, _api.isErrorHandledGlobally)(error)) {\n        Alert.default.alert('Error', errorMessage || detail);\n      }\n      return {\n        ok: false,\n        error,\n        detail\n      };\n    }\n  }\n\n  /**\n   * Helper to check if a mutation result succeeded\n   * Useful for TypeScript narrowing\n   */\n  function isMutationSuccess(result) {\n    return result.ok === true;\n  }\n\n  /**\n   * Hook-friendly version that creates a bound executor\n   * \n   * @example\n   * ```tsx\n   * const execute = createMutationExecutor(fetchUser);\n   * const result = await execute('pullGacha', () => pullGacha('single', 'coins'));\n   * ```\n   */\n  function createMutationExecutor(fetchUserFn) {\n    return async function executeMutation(actionName, fn, opts = {}) {\n      return safeMutation(actionName, fn, {\n        ...opts,\n        fetchUserFn\n      });\n    };\n  }\n\n  /**\n   * NO-OP optimistic update prevention\n   * Use this to wrap any attempted optimistic updates during refactoring\n   * \n   * @deprecated Remove once all optimistic updates are eliminated\n   */\n  function preventOptimisticUpdate(actionName, _setter) {\n    console.warn(`[BLOCKED] Optimistic update attempted for \"${actionName}\". ` + `State should only update after server confirms. Use safeMutation instead.`);\n    // Do NOT call the setter - this is intentional\n  }\n});","lineCount":189,"map":[[12,2,13,0,"exports"],[12,9,13,0],[12,10,13,0,"isOnline"],[12,18,13,0],[12,21,13,0,"isOnline"],[12,29,13,0],[13,2,95,0,"exports"],[13,9,95,0],[13,10,95,0,"safeMutation"],[13,22,95,0],[13,25,95,0,"safeMutation"],[13,37,95,0],[14,2,172,0,"exports"],[14,9,172,0],[14,10,172,0,"isMutationSuccess"],[14,27,172,0],[14,30,172,0,"isMutationSuccess"],[14,47,172,0],[15,2,185,0,"exports"],[15,9,185,0],[15,10,185,0,"createMutationExecutor"],[15,32,185,0],[15,35,185,0,"createMutationExecutor"],[15,57,185,0],[16,2,204,0,"exports"],[16,9,204,0],[16,10,204,0,"preventOptimisticUpdate"],[16,33,204,0],[16,36,204,0,"preventOptimisticUpdate"],[16,59,204,0],[17,2,213,1],[17,6,213,1,"_reactNativeWebDistExportsAlert"],[17,37,213,1],[17,40,213,1,"require"],[17,47,213,1],[17,48,213,1,"_dependencyMap"],[17,62,213,1],[18,2,213,1],[18,6,213,1,"Alert"],[18,11,213,1],[18,14,213,1,"_interopDefault"],[18,29,213,1],[18,30,213,1,"_reactNativeWebDistExportsAlert"],[18,61,213,1],[19,2,7,0],[19,6,7,0,"_api"],[19,10,7,0],[19,13,7,0,"require"],[19,20,7,0],[19,21,7,0,"_dependencyMap"],[19,35,7,0],[20,2,8,0],[20,6,8,0,"_storesNetworkStore"],[20,25,8,0],[20,28,8,0,"require"],[20,35,8,0],[20,36,8,0,"_dependencyMap"],[20,50,8,0],[21,2,1,0],[22,2,2,0],[23,2,3,0],[24,2,4,0],[26,2,10,0],[27,0,11,0],[28,0,12,0],[29,2,13,7],[29,11,13,16,"isOnline"],[29,19,13,24,"isOnline"],[29,20,13,24],[29,22,13,36],[30,4,14,2],[30,11,14,9,"useNetworkStore"],[30,30,14,24],[30,31,14,24,"useNetworkStore"],[30,46,14,24],[30,47,14,25,"getState"],[30,55,14,33],[30,56,14,34],[30,57,14,35],[30,58,14,36,"isOnline"],[30,66,14,44],[31,2,15,0],[33,2,17,0],[34,0,18,0],[35,0,19,0],[36,0,20,0],[38,2,25,0],[39,0,26,0],[40,0,27,0],[42,2,54,0],[43,0,55,0],[44,0,56,0],[45,2,57,0],[45,11,57,9,"getErrorDetail"],[45,25,57,23,"getErrorDetail"],[45,26,57,24,"error"],[45,31,57,34],[45,33,57,44],[46,4,58,2],[46,11,58,9,"error"],[46,16,58,14],[46,18,58,16,"response"],[46,26,58,24],[46,28,58,26,"data"],[46,32,58,30],[46,34,58,32,"detail"],[46,40,58,38],[46,44,59,7,"error"],[46,49,59,12],[46,51,59,14,"message"],[46,58,59,21],[46,62,60,7],[46,84,60,29],[47,2,61,0],[49,2,63,0],[50,0,64,0],[51,0,65,0],[52,0,66,0],[53,0,67,0],[54,0,68,0],[55,0,69,0],[56,0,70,0],[57,0,71,0],[58,0,72,0],[59,0,73,0],[60,0,74,0],[61,0,75,0],[62,0,76,0],[63,0,77,0],[64,0,78,0],[65,0,79,0],[66,0,80,0],[67,0,81,0],[68,0,82,0],[69,0,83,0],[70,0,84,0],[71,0,85,0],[72,0,86,0],[73,0,87,0],[74,0,88,0],[75,0,89,0],[76,0,90,0],[77,0,91,0],[78,0,92,0],[79,0,93,0],[80,0,94,0],[81,2,95,7],[81,17,95,22,"safeMutation"],[81,29,95,34,"safeMutation"],[81,30,96,2,"actionName"],[81,40,96,20],[81,42,97,2,"fn"],[81,44,97,22],[81,46,98,2,"opts"],[81,50,98,30],[81,53,98,33],[81,54,98,34],[81,55,98,35],[81,57,99,30],[82,4,100,2],[82,10,100,8],[83,6,101,4,"onSuccess"],[83,15,101,13],[84,6,102,4,"onError"],[84,13,102,11],[85,6,103,4,"refreshUser"],[85,17,103,15],[85,20,103,18],[85,24,103,22],[86,6,104,4,"fetchUserFn"],[86,17,104,15],[87,6,105,4,"showErrorAlert"],[87,20,105,18],[87,23,105,21],[87,27,105,25],[88,6,106,4,"errorMessage"],[89,4,107,2],[89,5,107,3],[89,8,107,6,"opts"],[89,12,107,10],[91,4,109,2],[92,4,110,2],[92,8,110,6],[92,9,110,7,"isOnline"],[92,17,110,15],[92,18,110,16],[92,19,110,17],[92,21,110,19],[93,6,111,4],[93,12,111,10,"offlineError"],[93,24,111,22],[93,27,111,25],[93,31,111,29,"Error"],[93,36,111,34],[93,37,111,35],[93,46,111,44],[93,47,111,45],[94,6,112,4],[94,12,112,10,"detail"],[94,18,112,16],[94,21,112,19],[94,90,112,88],[95,6,114,4],[95,10,114,8,"showErrorAlert"],[95,24,114,22],[95,26,114,24],[96,8,115,6,"Alert"],[96,13,115,11],[96,14,115,11,"default"],[96,21,115,11],[96,22,115,12,"alert"],[96,27,115,17],[96,28,115,18],[96,37,115,27],[96,39,115,29,"detail"],[96,45,115,35],[96,46,115,36],[97,6,116,4],[98,6,118,4],[98,10,118,8,"onError"],[98,17,118,15],[98,19,118,17,"onError"],[98,26,118,24],[98,27,118,25,"offlineError"],[98,39,118,37],[98,40,118,38],[99,6,120,4],[99,13,120,11],[100,8,120,13,"ok"],[100,10,120,15],[100,12,120,17],[100,17,120,22],[101,8,120,24,"error"],[101,13,120,29],[101,15,120,31,"offlineError"],[101,27,120,43],[102,8,120,45,"detail"],[103,6,120,52],[103,7,120,53],[104,4,121,2],[105,4,123,2],[105,8,123,6],[106,6,124,4],[106,10,124,8,"__DEV__"],[106,17,124,15],[106,19,124,17,"console"],[106,26,124,24],[106,27,124,25,"log"],[106,30,124,28],[106,31,124,29],[106,59,124,57,"actionName"],[106,69,124,67],[106,71,124,69],[106,72,124,70],[108,6,126,4],[109,6,127,4],[109,12,127,10,"data"],[109,16,127,14],[109,19,127,17],[109,25,127,23,"fn"],[109,27,127,25],[109,28,127,26],[109,29,127,27],[110,6,129,4],[110,10,129,8,"__DEV__"],[110,17,129,15],[110,19,129,17,"console"],[110,26,129,24],[110,27,129,25,"log"],[110,30,129,28],[110,31,129,29],[110,58,129,56,"actionName"],[110,68,129,66],[110,70,129,68],[110,71,129,69],[112,6,131,4],[113,6,132,4],[113,10,132,8,"refreshUser"],[113,21,132,19],[113,25,132,23,"fetchUserFn"],[113,36,132,34],[113,38,132,36],[114,8,133,6],[114,12,133,10],[115,10,134,8],[115,16,134,14,"fetchUserFn"],[115,27,134,25],[115,28,134,26],[115,29,134,27],[116,8,135,6],[116,9,135,7],[116,10,135,8],[116,17,135,15,"refreshError"],[116,29,135,27],[116,31,135,29],[117,10,136,8,"console"],[117,17,136,15],[117,18,136,16,"error"],[117,23,136,21],[117,24,136,22],[117,71,136,69,"actionName"],[117,81,136,79],[117,84,136,82],[117,86,136,84,"refreshError"],[117,98,136,96],[117,99,136,97],[118,10,137,8],[119,8,138,6],[120,6,139,4],[122,6,141,4],[123,6,142,4],[123,10,142,8,"onSuccess"],[123,19,142,17],[123,21,142,19],[124,8,143,6],[124,14,143,12,"onSuccess"],[124,23,143,21],[124,24,143,22,"data"],[124,28,143,26],[124,29,143,27],[125,6,144,4],[126,6,146,4],[126,13,146,11],[127,8,146,13,"ok"],[127,10,146,15],[127,12,146,17],[127,16,146,21],[128,8,146,23,"data"],[129,6,146,28],[129,7,146,29],[130,4,148,2],[130,5,148,3],[130,6,148,4],[130,13,148,11,"error"],[130,18,148,21],[130,20,148,23],[131,6,149,4],[131,12,149,10,"detail"],[131,18,149,16],[131,21,149,19,"getErrorDetail"],[131,35,149,33],[131,36,149,34,"error"],[131,41,149,39],[131,42,149,40],[132,6,150,4,"console"],[132,13,150,11],[132,14,150,12,"error"],[132,19,150,17],[132,20,150,18],[132,46,150,44,"actionName"],[132,56,150,54],[132,58,150,56],[132,60,150,58,"error"],[132,65,150,63],[132,66,150,64],[134,6,152,4],[135,6,153,4],[135,10,153,8,"onError"],[135,17,153,15],[135,19,153,17],[136,8,154,6,"onError"],[136,15,154,13],[136,16,154,14,"error"],[136,21,154,19],[136,22,154,20],[137,6,155,4],[139,6,157,4],[140,6,158,4],[141,6,159,4],[142,6,160,4],[142,10,160,8,"showErrorAlert"],[142,24,160,22],[142,28,160,26],[142,29,160,27],[142,33,160,27,"isErrorHandledGlobally"],[142,37,160,49],[142,38,160,49,"isErrorHandledGlobally"],[142,60,160,49],[142,62,160,50,"error"],[142,67,160,55],[142,68,160,56],[142,70,160,58],[143,8,161,6,"Alert"],[143,13,161,11],[143,14,161,11,"default"],[143,21,161,11],[143,22,161,12,"alert"],[143,27,161,17],[143,28,161,18],[143,35,161,25],[143,37,161,27,"errorMessage"],[143,49,161,39],[143,53,161,43,"detail"],[143,59,161,49],[143,60,161,50],[144,6,162,4],[145,6,164,4],[145,13,164,11],[146,8,164,13,"ok"],[146,10,164,15],[146,12,164,17],[146,17,164,22],[147,8,164,24,"error"],[147,13,164,29],[148,8,164,31,"detail"],[149,6,164,38],[149,7,164,39],[150,4,165,2],[151,2,166,0],[153,2,168,0],[154,0,169,0],[155,0,170,0],[156,0,171,0],[157,2,172,7],[157,11,172,16,"isMutationSuccess"],[157,28,172,33,"isMutationSuccess"],[157,29,172,37,"result"],[157,35,172,62],[157,37,172,97],[158,4,173,2],[158,11,173,9,"result"],[158,17,173,15],[158,18,173,16,"ok"],[158,20,173,18],[158,25,173,23],[158,29,173,27],[159,2,174,0],[161,2,176,0],[162,0,177,0],[163,0,178,0],[164,0,179,0],[165,0,180,0],[166,0,181,0],[167,0,182,0],[168,0,183,0],[169,0,184,0],[170,2,185,7],[170,11,185,16,"createMutationExecutor"],[170,33,185,38,"createMutationExecutor"],[170,34,185,39,"fetchUserFn"],[170,45,185,72],[170,47,185,74],[171,4,186,2],[171,11,186,9],[171,26,186,24,"executeMutation"],[171,41,186,39,"executeMutation"],[171,42,187,4,"actionName"],[171,52,187,22],[171,54,188,4,"fn"],[171,56,188,24],[171,58,189,4,"opts"],[171,62,189,53],[171,65,189,56],[171,66,189,57],[171,67,189,58],[171,69,190,32],[172,6,191,4],[172,13,191,11,"safeMutation"],[172,25,191,23],[172,26,191,24,"actionName"],[172,36,191,34],[172,38,191,36,"fn"],[172,40,191,38],[172,42,191,40],[173,8,192,6],[173,11,192,9,"opts"],[173,15,192,13],[174,8,193,6,"fetchUserFn"],[175,6,194,4],[175,7,194,5],[175,8,194,6],[176,4,195,2],[176,5,195,3],[177,2,196,0],[179,2,198,0],[180,0,199,0],[181,0,200,0],[182,0,201,0],[183,0,202,0],[184,0,203,0],[185,2,204,7],[185,11,204,16,"preventOptimisticUpdate"],[185,34,204,39,"preventOptimisticUpdate"],[185,35,205,2,"actionName"],[185,45,205,20],[185,47,206,2,"_setter"],[185,54,206,21],[185,56,207,8],[186,4,208,2,"console"],[186,11,208,9],[186,12,208,10,"warn"],[186,16,208,14],[186,17,209,4],[186,63,209,50,"actionName"],[186,73,209,60],[186,78,209,65],[186,81,210,4],[186,156,211,2],[186,157,211,3],[187,4,212,2],[188,2,213,0],[189,0,213,1],[189,3]],"functionMap":{"names":["<global>","isOnline","getErrorDetail","safeMutation","isMutationSuccess","createMutationExecutor","executeMutation","preventOptimisticUpdate"],"mappings":"AAA;OCY;CDE;AE0C;CFI;OGkC;CHuE;OIM;CJE;OKW;SCC;GDS;CLC;OOQ;CPS"},"hasCjsExports":false},"type":"js/module"}]}