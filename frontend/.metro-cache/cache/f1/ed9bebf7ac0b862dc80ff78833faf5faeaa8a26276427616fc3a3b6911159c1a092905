{"dependencies":[{"name":"./api","data":{"asyncType":null,"isESMImport":true,"locs":[{"start":{"line":7,"column":0,"index":277},"end":{"line":7,"column":47,"index":324}}],"key":"FbKPDeRJ9TF3vg1eKYKz12urgic=","exportNames":["*"],"imports":1}},{"name":"../stores/networkStore","data":{"asyncType":null,"isESMImport":true,"locs":[{"start":{"line":8,"column":0,"index":325},"end":{"line":8,"column":57,"index":382}}],"key":"ixdoEhjLNW8i2Hfhg3SedQ7tLZs=","exportNames":["*"],"imports":1}},{"name":"../components/ui/Toast","data":{"asyncType":null,"isESMImport":true,"locs":[{"start":{"line":9,"column":0,"index":383},"end":{"line":9,"column":47,"index":430}}],"key":"+eKK60h+OqRZMnow7eVpFTSPGUs=","exportNames":["*"],"imports":1}}],"output":[{"data":{"code":"__d(function (global, require, _$$_IMPORT_DEFAULT, _$$_IMPORT_ALL, module, exports, _dependencyMap) {\n  \"use strict\";\n\n  Object.defineProperty(exports, '__esModule', {\n    value: true\n  });\n  exports.isOnline = isOnline;\n  exports.safeMutation = safeMutation;\n  exports.isMutationSuccess = isMutationSuccess;\n  exports.createMutationExecutor = createMutationExecutor;\n  exports.preventOptimisticUpdate = preventOptimisticUpdate;\n  var _api = require(_dependencyMap[0], \"./api\");\n  var _storesNetworkStore = require(_dependencyMap[1], \"../stores/networkStore\");\n  var _componentsUiToast = require(_dependencyMap[2], \"../components/ui/Toast\");\n  // /app/frontend/lib/safeMutation.ts\n  // SAFE MUTATION WRAPPER\n  // Enforces consistent loading/success/failure patterns for all state mutations\n  // Prevents optimistic updates and ensures server-authoritative state\n  // Phase 3.18.4: Uses toast instead of Alert for error feedback\n\n  /**\n   * Check if device is online\n   */\n  function isOnline() {\n    return _storesNetworkStore.useNetworkStore.getState().isOnline;\n  }\n\n  /**\n   * Structured result type for safeMutation\n   * Preserves server error details while providing consistent interface\n   */\n\n  /**\n   * Options for safeMutation\n   */\n\n  /**\n   * Extract error detail from various error formats\n   */\n  function getErrorDetail(error) {\n    return error?.response?.data?.detail || error?.message || 'Something went wrong';\n  }\n\n  /**\n   * Safe mutation wrapper that enforces consistent patterns:\n   * 1. Always awaits the server response\n   * 2. Optionally refreshes user state after success\n   * 3. Returns structured result { ok, data } or { ok, error, detail }\n   * 4. Never assumes success - state only updates after server confirms\n   * 5. Respects global error handling - won't duplicate alerts\n   * \n   * @param actionName - Name of the action for logging\n   * @param fn - The async mutation function to execute\n   * @param opts - Options for customizing behavior\n   * @returns Structured result with ok/data or ok/error/detail\n   * \n   * @example\n   * ```tsx\n   * const result = await safeMutation(\n   *   'pullGacha',\n   *   () => apiPullGacha(username, 'single', 'coins'),\n   *   { \n   *     refreshUser: true, \n   *     fetchUserFn: fetchUser,\n   *     onSuccess: (data) => setHeroes(data.heroes)\n   *   }\n   * );\n   * \n   * if (result.ok) {\n   *   // Use result.data\n   * } else {\n   *   // result.error and result.detail available\n   * }\n   * ```\n   */\n  async function safeMutation(actionName, fn, opts = {}) {\n    const {\n      onSuccess,\n      onError,\n      refreshUser = true,\n      fetchUserFn,\n      showErrorAlert = true,\n      errorMessage\n    } = opts;\n\n    // Fast-fail if offline - don't attempt network calls\n    // Fast-fail if offline - NO alert (offline banner is the UX)\n    if (!isOnline()) {\n      const offlineError = new Error('OFFLINE');\n      const detail = 'No internet connection';\n      if (onError) onError(offlineError);\n\n      // Return silently - OfflineBanner is the global UX for this\n      return {\n        ok: false,\n        error: offlineError,\n        detail\n      };\n    }\n    try {\n      if (__DEV__) console.log(`[safeMutation] Starting: ${actionName}`);\n\n      // Execute the mutation - ALWAYS await server response\n      const data = await fn();\n      if (__DEV__) console.log(`[safeMutation] Success: ${actionName}`);\n\n      // Refresh user state from server (authoritative source)\n      if (refreshUser && fetchUserFn) {\n        try {\n          await fetchUserFn();\n        } catch (refreshError) {\n          console.error(`[safeMutation] Failed to refresh user after ${actionName}:`, refreshError);\n          // Don't fail the mutation if refresh fails - the mutation succeeded\n        }\n      }\n\n      // Call success callback\n      if (onSuccess) {\n        await onSuccess(data);\n      }\n      return {\n        ok: true,\n        data\n      };\n    } catch (error) {\n      const detail = getErrorDetail(error);\n      console.error(`[safeMutation] Failed: ${actionName}`, error);\n\n      // Call error callback\n      if (onError) {\n        onError(error);\n      }\n\n      // Only show toast if:\n      // 1. showErrorAlert is true\n      // 2. Error was NOT already handled by global interceptor\n      // Phase 3.18.4: Use toast instead of blocking Alert\n      if (showErrorAlert && !(0, _api.isErrorHandledGlobally)(error)) {\n        _componentsUiToast.toast.error(errorMessage || detail);\n      }\n      return {\n        ok: false,\n        error,\n        detail\n      };\n    }\n  }\n\n  /**\n   * Helper to check if a mutation result succeeded\n   * Useful for TypeScript narrowing\n   */\n  function isMutationSuccess(result) {\n    return result.ok === true;\n  }\n\n  /**\n   * Hook-friendly version that creates a bound executor\n   * \n   * @example\n   * ```tsx\n   * const execute = createMutationExecutor(fetchUser);\n   * const result = await execute('pullGacha', () => pullGacha('single', 'coins'));\n   * ```\n   */\n  function createMutationExecutor(fetchUserFn) {\n    return async function executeMutation(actionName, fn, opts = {}) {\n      return safeMutation(actionName, fn, Object.assign({}, opts, {\n        fetchUserFn\n      }));\n    };\n  }\n\n  /**\n   * NO-OP optimistic update prevention\n   * Use this to wrap any attempted optimistic updates during refactoring\n   * \n   * @deprecated Remove once all optimistic updates are eliminated\n   */\n  function preventOptimisticUpdate(actionName, _setter) {\n    console.warn(`[BLOCKED] Optimistic update attempted for \"${actionName}\". ` + `State should only update after server confirms. Use safeMutation instead.`);\n    // Do NOT call the setter - this is intentional\n  }\n});","lineCount":184,"map":[[7,2,14,0,"exports"],[7,9,14,0],[7,10,14,0,"isOnline"],[7,18,14,0],[7,21,14,0,"isOnline"],[7,29,14,0],[8,2,96,0,"exports"],[8,9,96,0],[8,10,96,0,"safeMutation"],[8,22,96,0],[8,25,96,0,"safeMutation"],[8,37,96,0],[9,2,172,0,"exports"],[9,9,172,0],[9,10,172,0,"isMutationSuccess"],[9,27,172,0],[9,30,172,0,"isMutationSuccess"],[9,47,172,0],[10,2,185,0,"exports"],[10,9,185,0],[10,10,185,0,"createMutationExecutor"],[10,32,185,0],[10,35,185,0,"createMutationExecutor"],[10,57,185,0],[11,2,204,0,"exports"],[11,9,204,0],[11,10,204,0,"preventOptimisticUpdate"],[11,33,204,0],[11,36,204,0,"preventOptimisticUpdate"],[11,59,204,0],[12,2,7,0],[12,6,7,0,"_api"],[12,10,7,0],[12,13,7,0,"require"],[12,20,7,0],[12,21,7,0,"_dependencyMap"],[12,35,7,0],[13,2,8,0],[13,6,8,0,"_storesNetworkStore"],[13,25,8,0],[13,28,8,0,"require"],[13,35,8,0],[13,36,8,0,"_dependencyMap"],[13,50,8,0],[14,2,9,0],[14,6,9,0,"_componentsUiToast"],[14,24,9,0],[14,27,9,0,"require"],[14,34,9,0],[14,35,9,0,"_dependencyMap"],[14,49,9,0],[15,2,1,0],[16,2,2,0],[17,2,3,0],[18,2,4,0],[19,2,5,0],[21,2,11,0],[22,0,12,0],[23,0,13,0],[24,2,14,7],[24,11,14,16,"isOnline"],[24,19,14,24,"isOnline"],[24,20,14,24],[24,22,14,36],[25,4,15,2],[25,11,15,9,"useNetworkStore"],[25,30,15,24],[25,31,15,24,"useNetworkStore"],[25,46,15,24],[25,47,15,25,"getState"],[25,55,15,33],[25,56,15,34],[25,57,15,35],[25,58,15,36,"isOnline"],[25,66,15,44],[26,2,16,0],[28,2,18,0],[29,0,19,0],[30,0,20,0],[31,0,21,0],[33,2,26,0],[34,0,27,0],[35,0,28,0],[37,2,55,0],[38,0,56,0],[39,0,57,0],[40,2,58,0],[40,11,58,9,"getErrorDetail"],[40,25,58,23,"getErrorDetail"],[40,26,58,24,"error"],[40,31,58,34],[40,33,58,44],[41,4,59,2],[41,11,59,9,"error"],[41,16,59,14],[41,18,59,16,"response"],[41,26,59,24],[41,28,59,26,"data"],[41,32,59,30],[41,34,59,32,"detail"],[41,40,59,38],[41,44,60,7,"error"],[41,49,60,12],[41,51,60,14,"message"],[41,58,60,21],[41,62,61,7],[41,84,61,29],[42,2,62,0],[44,2,64,0],[45,0,65,0],[46,0,66,0],[47,0,67,0],[48,0,68,0],[49,0,69,0],[50,0,70,0],[51,0,71,0],[52,0,72,0],[53,0,73,0],[54,0,74,0],[55,0,75,0],[56,0,76,0],[57,0,77,0],[58,0,78,0],[59,0,79,0],[60,0,80,0],[61,0,81,0],[62,0,82,0],[63,0,83,0],[64,0,84,0],[65,0,85,0],[66,0,86,0],[67,0,87,0],[68,0,88,0],[69,0,89,0],[70,0,90,0],[71,0,91,0],[72,0,92,0],[73,0,93,0],[74,0,94,0],[75,0,95,0],[76,2,96,7],[76,17,96,22,"safeMutation"],[76,29,96,34,"safeMutation"],[76,30,97,2,"actionName"],[76,40,97,20],[76,42,98,2,"fn"],[76,44,98,22],[76,46,99,2,"opts"],[76,50,99,30],[76,53,99,33],[76,54,99,34],[76,55,99,35],[76,57,100,30],[77,4,101,2],[77,10,101,8],[78,6,102,4,"onSuccess"],[78,15,102,13],[79,6,103,4,"onError"],[79,13,103,11],[80,6,104,4,"refreshUser"],[80,17,104,15],[80,20,104,18],[80,24,104,22],[81,6,105,4,"fetchUserFn"],[81,17,105,15],[82,6,106,4,"showErrorAlert"],[82,20,106,18],[82,23,106,21],[82,27,106,25],[83,6,107,4,"errorMessage"],[84,4,108,2],[84,5,108,3],[84,8,108,6,"opts"],[84,12,108,10],[86,4,110,2],[87,4,111,2],[88,4,112,2],[88,8,112,6],[88,9,112,7,"isOnline"],[88,17,112,15],[88,18,112,16],[88,19,112,17],[88,21,112,19],[89,6,113,4],[89,12,113,10,"offlineError"],[89,24,113,22],[89,27,113,25],[89,31,113,29,"Error"],[89,36,113,34],[89,37,113,35],[89,46,113,44],[89,47,113,45],[90,6,114,4],[90,12,114,10,"detail"],[90,18,114,16],[90,21,114,19],[90,45,114,43],[91,6,116,4],[91,10,116,8,"onError"],[91,17,116,15],[91,19,116,17,"onError"],[91,26,116,24],[91,27,116,25,"offlineError"],[91,39,116,37],[91,40,116,38],[93,6,118,4],[94,6,119,4],[94,13,119,11],[95,8,119,13,"ok"],[95,10,119,15],[95,12,119,17],[95,17,119,22],[96,8,119,24,"error"],[96,13,119,29],[96,15,119,31,"offlineError"],[96,27,119,43],[97,8,119,45,"detail"],[98,6,119,52],[98,7,119,53],[99,4,120,2],[100,4,122,2],[100,8,122,6],[101,6,123,4],[101,10,123,8,"__DEV__"],[101,17,123,15],[101,19,123,17,"console"],[101,26,123,24],[101,27,123,25,"log"],[101,30,123,28],[101,31,123,29],[101,59,123,57,"actionName"],[101,69,123,67],[101,71,123,69],[101,72,123,70],[103,6,125,4],[104,6,126,4],[104,12,126,10,"data"],[104,16,126,14],[104,19,126,17],[104,25,126,23,"fn"],[104,27,126,25],[104,28,126,26],[104,29,126,27],[105,6,128,4],[105,10,128,8,"__DEV__"],[105,17,128,15],[105,19,128,17,"console"],[105,26,128,24],[105,27,128,25,"log"],[105,30,128,28],[105,31,128,29],[105,58,128,56,"actionName"],[105,68,128,66],[105,70,128,68],[105,71,128,69],[107,6,130,4],[108,6,131,4],[108,10,131,8,"refreshUser"],[108,21,131,19],[108,25,131,23,"fetchUserFn"],[108,36,131,34],[108,38,131,36],[109,8,132,6],[109,12,132,10],[110,10,133,8],[110,16,133,14,"fetchUserFn"],[110,27,133,25],[110,28,133,26],[110,29,133,27],[111,8,134,6],[111,9,134,7],[111,10,134,8],[111,17,134,15,"refreshError"],[111,29,134,27],[111,31,134,29],[112,10,135,8,"console"],[112,17,135,15],[112,18,135,16,"error"],[112,23,135,21],[112,24,135,22],[112,71,135,69,"actionName"],[112,81,135,79],[112,84,135,82],[112,86,135,84,"refreshError"],[112,98,135,96],[112,99,135,97],[113,10,136,8],[114,8,137,6],[115,6,138,4],[117,6,140,4],[118,6,141,4],[118,10,141,8,"onSuccess"],[118,19,141,17],[118,21,141,19],[119,8,142,6],[119,14,142,12,"onSuccess"],[119,23,142,21],[119,24,142,22,"data"],[119,28,142,26],[119,29,142,27],[120,6,143,4],[121,6,145,4],[121,13,145,11],[122,8,145,13,"ok"],[122,10,145,15],[122,12,145,17],[122,16,145,21],[123,8,145,23,"data"],[124,6,145,28],[124,7,145,29],[125,4,147,2],[125,5,147,3],[125,6,147,4],[125,13,147,11,"error"],[125,18,147,21],[125,20,147,23],[126,6,148,4],[126,12,148,10,"detail"],[126,18,148,16],[126,21,148,19,"getErrorDetail"],[126,35,148,33],[126,36,148,34,"error"],[126,41,148,39],[126,42,148,40],[127,6,149,4,"console"],[127,13,149,11],[127,14,149,12,"error"],[127,19,149,17],[127,20,149,18],[127,46,149,44,"actionName"],[127,56,149,54],[127,58,149,56],[127,60,149,58,"error"],[127,65,149,63],[127,66,149,64],[129,6,151,4],[130,6,152,4],[130,10,152,8,"onError"],[130,17,152,15],[130,19,152,17],[131,8,153,6,"onError"],[131,15,153,13],[131,16,153,14,"error"],[131,21,153,19],[131,22,153,20],[132,6,154,4],[134,6,156,4],[135,6,157,4],[136,6,158,4],[137,6,159,4],[138,6,160,4],[138,10,160,8,"showErrorAlert"],[138,24,160,22],[138,28,160,26],[138,29,160,27],[138,33,160,27,"isErrorHandledGlobally"],[138,37,160,49],[138,38,160,49,"isErrorHandledGlobally"],[138,60,160,49],[138,62,160,50,"error"],[138,67,160,55],[138,68,160,56],[138,70,160,58],[139,8,161,6,"toast"],[139,26,161,11],[139,27,161,11,"toast"],[139,32,161,11],[139,33,161,12,"error"],[139,38,161,17],[139,39,161,18,"errorMessage"],[139,51,161,30],[139,55,161,34,"detail"],[139,61,161,40],[139,62,161,41],[140,6,162,4],[141,6,164,4],[141,13,164,11],[142,8,164,13,"ok"],[142,10,164,15],[142,12,164,17],[142,17,164,22],[143,8,164,24,"error"],[143,13,164,29],[144,8,164,31,"detail"],[145,6,164,38],[145,7,164,39],[146,4,165,2],[147,2,166,0],[149,2,168,0],[150,0,169,0],[151,0,170,0],[152,0,171,0],[153,2,172,7],[153,11,172,16,"isMutationSuccess"],[153,28,172,33,"isMutationSuccess"],[153,29,172,37,"result"],[153,35,172,62],[153,37,172,97],[154,4,173,2],[154,11,173,9,"result"],[154,17,173,15],[154,18,173,16,"ok"],[154,20,173,18],[154,25,173,23],[154,29,173,27],[155,2,174,0],[157,2,176,0],[158,0,177,0],[159,0,178,0],[160,0,179,0],[161,0,180,0],[162,0,181,0],[163,0,182,0],[164,0,183,0],[165,0,184,0],[166,2,185,7],[166,11,185,16,"createMutationExecutor"],[166,33,185,38,"createMutationExecutor"],[166,34,185,39,"fetchUserFn"],[166,45,185,72],[166,47,185,74],[167,4,186,2],[167,11,186,9],[167,26,186,24,"executeMutation"],[167,41,186,39,"executeMutation"],[167,42,187,4,"actionName"],[167,52,187,22],[167,54,188,4,"fn"],[167,56,188,24],[167,58,189,4,"opts"],[167,62,189,53],[167,65,189,56],[167,66,189,57],[167,67,189,58],[167,69,190,32],[168,6,191,4],[168,13,191,11,"safeMutation"],[168,25,191,23],[168,26,191,24,"actionName"],[168,36,191,34],[168,38,191,36,"fn"],[168,40,191,38],[168,42,191,38,"Object"],[168,48,191,38],[168,49,191,38,"assign"],[168,55,191,38],[168,60,192,9,"opts"],[168,64,192,13],[169,8,193,6,"fetchUserFn"],[170,6,193,17],[170,8,194,5],[170,9,194,6],[171,4,195,2],[171,5,195,3],[172,2,196,0],[174,2,198,0],[175,0,199,0],[176,0,200,0],[177,0,201,0],[178,0,202,0],[179,0,203,0],[180,2,204,7],[180,11,204,16,"preventOptimisticUpdate"],[180,34,204,39,"preventOptimisticUpdate"],[180,35,205,2,"actionName"],[180,45,205,20],[180,47,206,2,"_setter"],[180,54,206,21],[180,56,207,8],[181,4,208,2,"console"],[181,11,208,9],[181,12,208,10,"warn"],[181,16,208,14],[181,17,209,4],[181,63,209,50,"actionName"],[181,73,209,60],[181,78,209,65],[181,81,210,4],[181,156,211,2],[181,157,211,3],[182,4,212,2],[183,2,213,0],[184,0,213,1],[184,3]],"functionMap":{"names":["<global>","isOnline","getErrorDetail","safeMutation","isMutationSuccess","createMutationExecutor","executeMutation","preventOptimisticUpdate"],"mappings":"AAA;OCa;CDE;AE0C;CFI;OGkC;CHsE;OIM;CJE;OKW;SCC;GDS;CLC;OOQ;CPS"},"hasCjsExports":false},"type":"js/module"}]}