{"dependencies":[{"name":"react-native-web/dist/exports/Alert","data":{"asyncType":null,"isESMImport":false,"locs":[],"key":"PEUC6jrQVoAGZ2qYkvimljMOyJI=","exportNames":["*"],"imports":1}},{"name":"./api","data":{"asyncType":null,"isESMImport":true,"locs":[{"start":{"line":7,"column":0,"index":251},"end":{"line":7,"column":47,"index":298}}],"key":"FbKPDeRJ9TF3vg1eKYKz12urgic=","exportNames":["*"],"imports":1}}],"output":[{"data":{"code":"__d(function (global, require, _$$_IMPORT_DEFAULT, _$$_IMPORT_ALL, module, exports, _dependencyMap) {\n  \"use strict\";\n\n  Object.defineProperty(exports, '__esModule', {\n    value: true\n  });\n  function _interopDefault(e) {\n    return e && e.__esModule ? e : {\n      default: e\n    };\n  }\n  exports.safeMutation = safeMutation;\n  exports.isMutationSuccess = isMutationSuccess;\n  exports.createMutationExecutor = createMutationExecutor;\n  exports.preventOptimisticUpdate = preventOptimisticUpdate;\n  var _reactNativeWebDistExportsAlert = require(_dependencyMap[0], \"react-native-web/dist/exports/Alert\");\n  var Alert = _interopDefault(_reactNativeWebDistExportsAlert);\n  var _api = require(_dependencyMap[1], \"./api\");\n  // /app/frontend/lib/safeMutation.ts\n  // SAFE MUTATION WRAPPER\n  // Enforces consistent loading/success/failure patterns for all state mutations\n  // Prevents optimistic updates and ensures server-authoritative state\n\n  /**\n   * Structured result type for safeMutation\n   * Preserves server error details while providing consistent interface\n   */\n\n  /**\n   * Options for safeMutation\n   */\n\n  /**\n   * Extract error detail from various error formats\n   */\n  function getErrorDetail(error) {\n    return error?.response?.data?.detail || error?.message || 'Something went wrong';\n  }\n\n  /**\n   * Safe mutation wrapper that enforces consistent patterns:\n   * 1. Always awaits the server response\n   * 2. Optionally refreshes user state after success\n   * 3. Returns structured result { ok, data } or { ok, error, detail }\n   * 4. Never assumes success - state only updates after server confirms\n   * 5. Respects global error handling - won't duplicate alerts\n   * \n   * @param actionName - Name of the action for logging\n   * @param fn - The async mutation function to execute\n   * @param opts - Options for customizing behavior\n   * @returns Structured result with ok/data or ok/error/detail\n   * \n   * @example\n   * ```tsx\n   * const result = await safeMutation(\n   *   'pullGacha',\n   *   () => apiPullGacha(username, 'single', 'coins'),\n   *   { \n   *     refreshUser: true, \n   *     fetchUserFn: fetchUser,\n   *     onSuccess: (data) => setHeroes(data.heroes)\n   *   }\n   * );\n   * \n   * if (result.ok) {\n   *   // Use result.data\n   * } else {\n   *   // result.error and result.detail available\n   * }\n   * ```\n   */\n  async function safeMutation(actionName, fn, opts = {}) {\n    const {\n      onSuccess,\n      onError,\n      refreshUser = true,\n      fetchUserFn,\n      showErrorAlert = true,\n      errorMessage\n    } = opts;\n    try {\n      if (__DEV__) console.log(`[safeMutation] Starting: ${actionName}`);\n\n      // Execute the mutation - ALWAYS await server response\n      const data = await fn();\n      if (__DEV__) console.log(`[safeMutation] Success: ${actionName}`);\n\n      // Refresh user state from server (authoritative source)\n      if (refreshUser && fetchUserFn) {\n        try {\n          await fetchUserFn();\n        } catch (refreshError) {\n          console.error(`[safeMutation] Failed to refresh user after ${actionName}:`, refreshError);\n          // Don't fail the mutation if refresh fails - the mutation succeeded\n        }\n      }\n\n      // Call success callback\n      if (onSuccess) {\n        await onSuccess(data);\n      }\n      return {\n        ok: true,\n        data\n      };\n    } catch (error) {\n      const detail = getErrorDetail(error);\n      console.error(`[safeMutation] Failed: ${actionName}`, error);\n\n      // Call error callback\n      if (onError) {\n        onError(error);\n      }\n\n      // Only show alert if:\n      // 1. showErrorAlert is true\n      // 2. Error was NOT already handled by global interceptor\n      if (showErrorAlert && !(0, _api.isErrorHandledGlobally)(error)) {\n        Alert.default.alert('Error', errorMessage || detail);\n      }\n      return {\n        ok: false,\n        error,\n        detail\n      };\n    }\n  }\n\n  /**\n   * Helper to check if a mutation result succeeded\n   * Useful for TypeScript narrowing\n   */\n  function isMutationSuccess(result) {\n    return result.ok === true;\n  }\n\n  /**\n   * Hook-friendly version that creates a bound executor\n   * \n   * @example\n   * ```tsx\n   * const execute = createMutationExecutor(fetchUser);\n   * const result = await execute('pullGacha', () => pullGacha('single', 'coins'));\n   * ```\n   */\n  function createMutationExecutor(fetchUserFn) {\n    return async function executeMutation(actionName, fn, opts = {}) {\n      return safeMutation(actionName, fn, {\n        ...opts,\n        fetchUserFn\n      });\n    };\n  }\n\n  /**\n   * NO-OP optimistic update prevention\n   * Use this to wrap any attempted optimistic updates during refactoring\n   * \n   * @deprecated Remove once all optimistic updates are eliminated\n   */\n  function preventOptimisticUpdate(actionName, _setter) {\n    console.warn(`[BLOCKED] Optimistic update attempted for \"${actionName}\". ` + `State should only update after server confirms. Use safeMutation instead.`);\n    // Do NOT call the setter - this is intentional\n  }\n});","lineCount":165,"map":[[12,2,87,0,"exports"],[12,9,87,0],[12,10,87,0,"safeMutation"],[12,22,87,0],[12,25,87,0,"safeMutation"],[12,37,87,0],[13,2,150,0,"exports"],[13,9,150,0],[13,10,150,0,"isMutationSuccess"],[13,27,150,0],[13,30,150,0,"isMutationSuccess"],[13,47,150,0],[14,2,163,0,"exports"],[14,9,163,0],[14,10,163,0,"createMutationExecutor"],[14,32,163,0],[14,35,163,0,"createMutationExecutor"],[14,57,163,0],[15,2,182,0,"exports"],[15,9,182,0],[15,10,182,0,"preventOptimisticUpdate"],[15,33,182,0],[15,36,182,0,"preventOptimisticUpdate"],[15,59,182,0],[16,2,191,1],[16,6,191,1,"_reactNativeWebDistExportsAlert"],[16,37,191,1],[16,40,191,1,"require"],[16,47,191,1],[16,48,191,1,"_dependencyMap"],[16,62,191,1],[17,2,191,1],[17,6,191,1,"Alert"],[17,11,191,1],[17,14,191,1,"_interopDefault"],[17,29,191,1],[17,30,191,1,"_reactNativeWebDistExportsAlert"],[17,61,191,1],[18,2,7,0],[18,6,7,0,"_api"],[18,10,7,0],[18,13,7,0,"require"],[18,20,7,0],[18,21,7,0,"_dependencyMap"],[18,35,7,0],[19,2,1,0],[20,2,2,0],[21,2,3,0],[22,2,4,0],[24,2,9,0],[25,0,10,0],[26,0,11,0],[27,0,12,0],[29,2,17,0],[30,0,18,0],[31,0,19,0],[33,2,46,0],[34,0,47,0],[35,0,48,0],[36,2,49,0],[36,11,49,9,"getErrorDetail"],[36,25,49,23,"getErrorDetail"],[36,26,49,24,"error"],[36,31,49,34],[36,33,49,44],[37,4,50,2],[37,11,50,9,"error"],[37,16,50,14],[37,18,50,16,"response"],[37,26,50,24],[37,28,50,26,"data"],[37,32,50,30],[37,34,50,32,"detail"],[37,40,50,38],[37,44,51,7,"error"],[37,49,51,12],[37,51,51,14,"message"],[37,58,51,21],[37,62,52,7],[37,84,52,29],[38,2,53,0],[40,2,55,0],[41,0,56,0],[42,0,57,0],[43,0,58,0],[44,0,59,0],[45,0,60,0],[46,0,61,0],[47,0,62,0],[48,0,63,0],[49,0,64,0],[50,0,65,0],[51,0,66,0],[52,0,67,0],[53,0,68,0],[54,0,69,0],[55,0,70,0],[56,0,71,0],[57,0,72,0],[58,0,73,0],[59,0,74,0],[60,0,75,0],[61,0,76,0],[62,0,77,0],[63,0,78,0],[64,0,79,0],[65,0,80,0],[66,0,81,0],[67,0,82,0],[68,0,83,0],[69,0,84,0],[70,0,85,0],[71,0,86,0],[72,2,87,7],[72,17,87,22,"safeMutation"],[72,29,87,34,"safeMutation"],[72,30,88,2,"actionName"],[72,40,88,20],[72,42,89,2,"fn"],[72,44,89,22],[72,46,90,2,"opts"],[72,50,90,30],[72,53,90,33],[72,54,90,34],[72,55,90,35],[72,57,91,30],[73,4,92,2],[73,10,92,8],[74,6,93,4,"onSuccess"],[74,15,93,13],[75,6,94,4,"onError"],[75,13,94,11],[76,6,95,4,"refreshUser"],[76,17,95,15],[76,20,95,18],[76,24,95,22],[77,6,96,4,"fetchUserFn"],[77,17,96,15],[78,6,97,4,"showErrorAlert"],[78,20,97,18],[78,23,97,21],[78,27,97,25],[79,6,98,4,"errorMessage"],[80,4,99,2],[80,5,99,3],[80,8,99,6,"opts"],[80,12,99,10],[81,4,101,2],[81,8,101,6],[82,6,102,4],[82,10,102,8,"__DEV__"],[82,17,102,15],[82,19,102,17,"console"],[82,26,102,24],[82,27,102,25,"log"],[82,30,102,28],[82,31,102,29],[82,59,102,57,"actionName"],[82,69,102,67],[82,71,102,69],[82,72,102,70],[84,6,104,4],[85,6,105,4],[85,12,105,10,"data"],[85,16,105,14],[85,19,105,17],[85,25,105,23,"fn"],[85,27,105,25],[85,28,105,26],[85,29,105,27],[86,6,107,4],[86,10,107,8,"__DEV__"],[86,17,107,15],[86,19,107,17,"console"],[86,26,107,24],[86,27,107,25,"log"],[86,30,107,28],[86,31,107,29],[86,58,107,56,"actionName"],[86,68,107,66],[86,70,107,68],[86,71,107,69],[88,6,109,4],[89,6,110,4],[89,10,110,8,"refreshUser"],[89,21,110,19],[89,25,110,23,"fetchUserFn"],[89,36,110,34],[89,38,110,36],[90,8,111,6],[90,12,111,10],[91,10,112,8],[91,16,112,14,"fetchUserFn"],[91,27,112,25],[91,28,112,26],[91,29,112,27],[92,8,113,6],[92,9,113,7],[92,10,113,8],[92,17,113,15,"refreshError"],[92,29,113,27],[92,31,113,29],[93,10,114,8,"console"],[93,17,114,15],[93,18,114,16,"error"],[93,23,114,21],[93,24,114,22],[93,71,114,69,"actionName"],[93,81,114,79],[93,84,114,82],[93,86,114,84,"refreshError"],[93,98,114,96],[93,99,114,97],[94,10,115,8],[95,8,116,6],[96,6,117,4],[98,6,119,4],[99,6,120,4],[99,10,120,8,"onSuccess"],[99,19,120,17],[99,21,120,19],[100,8,121,6],[100,14,121,12,"onSuccess"],[100,23,121,21],[100,24,121,22,"data"],[100,28,121,26],[100,29,121,27],[101,6,122,4],[102,6,124,4],[102,13,124,11],[103,8,124,13,"ok"],[103,10,124,15],[103,12,124,17],[103,16,124,21],[104,8,124,23,"data"],[105,6,124,28],[105,7,124,29],[106,4,126,2],[106,5,126,3],[106,6,126,4],[106,13,126,11,"error"],[106,18,126,21],[106,20,126,23],[107,6,127,4],[107,12,127,10,"detail"],[107,18,127,16],[107,21,127,19,"getErrorDetail"],[107,35,127,33],[107,36,127,34,"error"],[107,41,127,39],[107,42,127,40],[108,6,128,4,"console"],[108,13,128,11],[108,14,128,12,"error"],[108,19,128,17],[108,20,128,18],[108,46,128,44,"actionName"],[108,56,128,54],[108,58,128,56],[108,60,128,58,"error"],[108,65,128,63],[108,66,128,64],[110,6,130,4],[111,6,131,4],[111,10,131,8,"onError"],[111,17,131,15],[111,19,131,17],[112,8,132,6,"onError"],[112,15,132,13],[112,16,132,14,"error"],[112,21,132,19],[112,22,132,20],[113,6,133,4],[115,6,135,4],[116,6,136,4],[117,6,137,4],[118,6,138,4],[118,10,138,8,"showErrorAlert"],[118,24,138,22],[118,28,138,26],[118,29,138,27],[118,33,138,27,"isErrorHandledGlobally"],[118,37,138,49],[118,38,138,49,"isErrorHandledGlobally"],[118,60,138,49],[118,62,138,50,"error"],[118,67,138,55],[118,68,138,56],[118,70,138,58],[119,8,139,6,"Alert"],[119,13,139,11],[119,14,139,11,"default"],[119,21,139,11],[119,22,139,12,"alert"],[119,27,139,17],[119,28,139,18],[119,35,139,25],[119,37,139,27,"errorMessage"],[119,49,139,39],[119,53,139,43,"detail"],[119,59,139,49],[119,60,139,50],[120,6,140,4],[121,6,142,4],[121,13,142,11],[122,8,142,13,"ok"],[122,10,142,15],[122,12,142,17],[122,17,142,22],[123,8,142,24,"error"],[123,13,142,29],[124,8,142,31,"detail"],[125,6,142,38],[125,7,142,39],[126,4,143,2],[127,2,144,0],[129,2,146,0],[130,0,147,0],[131,0,148,0],[132,0,149,0],[133,2,150,7],[133,11,150,16,"isMutationSuccess"],[133,28,150,33,"isMutationSuccess"],[133,29,150,37,"result"],[133,35,150,62],[133,37,150,97],[134,4,151,2],[134,11,151,9,"result"],[134,17,151,15],[134,18,151,16,"ok"],[134,20,151,18],[134,25,151,23],[134,29,151,27],[135,2,152,0],[137,2,154,0],[138,0,155,0],[139,0,156,0],[140,0,157,0],[141,0,158,0],[142,0,159,0],[143,0,160,0],[144,0,161,0],[145,0,162,0],[146,2,163,7],[146,11,163,16,"createMutationExecutor"],[146,33,163,38,"createMutationExecutor"],[146,34,163,39,"fetchUserFn"],[146,45,163,72],[146,47,163,74],[147,4,164,2],[147,11,164,9],[147,26,164,24,"executeMutation"],[147,41,164,39,"executeMutation"],[147,42,165,4,"actionName"],[147,52,165,22],[147,54,166,4,"fn"],[147,56,166,24],[147,58,167,4,"opts"],[147,62,167,53],[147,65,167,56],[147,66,167,57],[147,67,167,58],[147,69,168,32],[148,6,169,4],[148,13,169,11,"safeMutation"],[148,25,169,23],[148,26,169,24,"actionName"],[148,36,169,34],[148,38,169,36,"fn"],[148,40,169,38],[148,42,169,40],[149,8,170,6],[149,11,170,9,"opts"],[149,15,170,13],[150,8,171,6,"fetchUserFn"],[151,6,172,4],[151,7,172,5],[151,8,172,6],[152,4,173,2],[152,5,173,3],[153,2,174,0],[155,2,176,0],[156,0,177,0],[157,0,178,0],[158,0,179,0],[159,0,180,0],[160,0,181,0],[161,2,182,7],[161,11,182,16,"preventOptimisticUpdate"],[161,34,182,39,"preventOptimisticUpdate"],[161,35,183,2,"actionName"],[161,45,183,20],[161,47,184,2,"_setter"],[161,54,184,21],[161,56,185,8],[162,4,186,2,"console"],[162,11,186,9],[162,12,186,10,"warn"],[162,16,186,14],[162,17,187,4],[162,63,187,50,"actionName"],[162,73,187,60],[162,78,187,65],[162,81,188,4],[162,156,189,2],[162,157,189,3],[163,4,190,2],[164,2,191,0],[165,0,191,1],[165,3]],"functionMap":{"names":["<global>","getErrorDetail","safeMutation","isMutationSuccess","createMutationExecutor","executeMutation","preventOptimisticUpdate"],"mappings":"AAA;ACgD;CDI;OEkC;CFyD;OGM;CHE;OIW;SCC;GDS;CJC;OMQ;CNS"},"hasCjsExports":false},"type":"js/module"}]}