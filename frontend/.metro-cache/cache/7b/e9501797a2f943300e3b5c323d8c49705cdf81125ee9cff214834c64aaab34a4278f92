{"dependencies":[{"name":"@sentry/utils","data":{"asyncType":null,"isESMImport":true,"locs":[{"start":{"line":1,"column":0,"index":0},"end":{"line":1,"column":50,"index":50}}],"key":"m+kcirlwHAgMIuUoyR2vCxbhWD4=","exportNames":["*"],"imports":1}},{"name":"./hub.js","data":{"asyncType":null,"isESMImport":true,"locs":[{"start":{"line":2,"column":0,"index":51},"end":{"line":2,"column":41,"index":92}}],"key":"6RgB7tUvXHErUrTKklgivQjAfZc=","exportNames":["*"],"imports":1}}],"output":[{"data":{"code":"__d(function (global, require, _$$_IMPORT_DEFAULT, _$$_IMPORT_ALL, module, exports, _dependencyMap) {\n  \"use strict\";\n\n  Object.defineProperty(exports, '__esModule', {\n    value: true\n  });\n  Object.defineProperty(exports, \"SessionFlusher\", {\n    enumerable: true,\n    get: function () {\n      return SessionFlusher;\n    }\n  });\n  var _sentryUtils = require(_dependencyMap[0], \"@sentry/utils\");\n  var _hubJs = require(_dependencyMap[1], \"./hub.js\");\n  /**\n   * @inheritdoc\n   */\n  class SessionFlusher {\n    constructor(client, attrs) {\n      this._client = client;\n      this.flushTimeout = 60;\n      this._pendingAggregates = {};\n      this._isEnabled = true;\n\n      // Call to setInterval, so that flush is called every 60 seconds\n      this._intervalId = setInterval(() => this.flush(), this.flushTimeout * 1000);\n      this._sessionAttrs = attrs;\n    }\n\n    /** Checks if `pendingAggregates` has entries, and if it does flushes them by calling `sendSession` */\n    flush() {\n      const sessionAggregates = this.getSessionAggregates();\n      if (sessionAggregates.aggregates.length === 0) {\n        return;\n      }\n      this._pendingAggregates = {};\n      this._client.sendSession(sessionAggregates);\n    }\n\n    /** Massages the entries in `pendingAggregates` and returns aggregated sessions */\n    getSessionAggregates() {\n      const aggregates = Object.keys(this._pendingAggregates).map(key => {\n        return this._pendingAggregates[parseInt(key)];\n      });\n      const sessionAggregates = {\n        attrs: this._sessionAttrs,\n        aggregates\n      };\n      return (0, _sentryUtils.dropUndefinedKeys)(sessionAggregates);\n    }\n\n    /** JSDoc */\n    close() {\n      clearInterval(this._intervalId);\n      this._isEnabled = false;\n      this.flush();\n    }\n\n    /**\n     * Wrapper function for _incrementSessionStatusCount that checks if the instance of SessionFlusher is enabled then\n     * fetches the session status of the request from `Scope.getRequestSession().status` on the scope and passes them to\n     * `_incrementSessionStatusCount` along with the start date\n     */\n    incrementSessionStatusCount() {\n      if (!this._isEnabled) {\n        return;\n      }\n      const scope = (0, _hubJs.getCurrentHub)().getScope();\n      const requestSession = scope.getRequestSession();\n      if (requestSession && requestSession.status) {\n        this._incrementSessionStatusCount(requestSession.status, new Date());\n        // This is not entirely necessarily but is added as a safe guard to indicate the bounds of a request and so in\n        // case captureRequestSession is called more than once to prevent double count\n        scope.setRequestSession(undefined);\n        /* eslint-enable @typescript-eslint/no-unsafe-member-access */\n      }\n    }\n\n    /**\n     * Increments status bucket in pendingAggregates buffer (internal state) corresponding to status of\n     * the session received\n     */\n    _incrementSessionStatusCount(status, date) {\n      // Truncate minutes and seconds on Session Started attribute to have one minute bucket keys\n      const sessionStartedTrunc = new Date(date).setSeconds(0, 0);\n      this._pendingAggregates[sessionStartedTrunc] = this._pendingAggregates[sessionStartedTrunc] || {};\n\n      // corresponds to aggregated sessions in one specific minute bucket\n      // for example, {\"started\":\"2021-03-16T08:00:00.000Z\",\"exited\":4, \"errored\": 1}\n      const aggregationCounts = this._pendingAggregates[sessionStartedTrunc];\n      if (!aggregationCounts.started) {\n        aggregationCounts.started = new Date(sessionStartedTrunc).toISOString();\n      }\n      switch (status) {\n        case 'errored':\n          aggregationCounts.errored = (aggregationCounts.errored || 0) + 1;\n          return aggregationCounts.errored;\n        case 'ok':\n          aggregationCounts.exited = (aggregationCounts.exited || 0) + 1;\n          return aggregationCounts.exited;\n        default:\n          aggregationCounts.crashed = (aggregationCounts.crashed || 0) + 1;\n          return aggregationCounts.crashed;\n      }\n    }\n  }\n});","lineCount":107,"map":[[7,2,101,0,"Object"],[7,8,101,0],[7,9,101,0,"defineProperty"],[7,23,101,0],[7,24,101,0,"exports"],[7,31,101,0],[8,4,101,0,"enumerable"],[8,14,101,0],[9,4,101,0,"get"],[9,7,101,0],[9,18,101,0,"get"],[9,19,101,0],[10,6,101,0],[10,13,101,9,"SessionFlusher"],[10,27,101,23],[11,4,101,23],[12,2,101,23],[13,2,1,0],[13,6,1,0,"_sentryUtils"],[13,18,1,0],[13,21,1,0,"require"],[13,28,1,0],[13,29,1,0,"_dependencyMap"],[13,43,1,0],[14,2,2,0],[14,6,2,0,"_hubJs"],[14,12,2,0],[14,15,2,0,"require"],[14,22,2,0],[14,23,2,0,"_dependencyMap"],[14,37,2,0],[15,2,4,0],[16,0,5,0],[17,0,6,0],[18,2,7,0],[18,8,7,6,"SessionFlusher"],[18,22,7,20],[18,23,7,22],[19,4,9,3,"constructor"],[19,15,9,14,"constructor"],[19,16,9,15,"client"],[19,22,9,21],[19,24,9,23,"attrs"],[19,29,9,28],[19,31,9,30],[20,6,10,4],[20,10,10,8],[20,11,10,9,"_client"],[20,18,10,16],[20,21,10,19,"client"],[20,27,10,25],[21,6,11,4],[21,10,11,8],[21,11,11,9,"flushTimeout"],[21,23,11,21],[21,26,11,24],[21,28,11,26],[22,6,12,4],[22,10,12,8],[22,11,12,9,"_pendingAggregates"],[22,29,12,27],[22,32,12,30],[22,33,12,31],[22,34,12,32],[23,6,13,4],[23,10,13,8],[23,11,13,9,"_isEnabled"],[23,21,13,19],[23,24,13,22],[23,28,13,26],[25,6,15,4],[26,6,16,4],[26,10,16,8],[26,11,16,9,"_intervalId"],[26,22,16,20],[26,25,16,23,"setInterval"],[26,36,16,34],[26,37,16,35],[26,43,16,41],[26,47,16,45],[26,48,16,46,"flush"],[26,53,16,51],[26,54,16,52],[26,55,16,53],[26,57,16,55],[26,61,16,59],[26,62,16,60,"flushTimeout"],[26,74,16,72],[26,77,16,75],[26,81,16,79],[26,82,16,80],[27,6,17,4],[27,10,17,8],[27,11,17,9,"_sessionAttrs"],[27,24,17,22],[27,27,17,25,"attrs"],[27,32,17,30],[28,4,18,2],[30,4,20,2],[31,4,21,3,"flush"],[31,9,21,8,"flush"],[31,10,21,8],[31,12,21,11],[32,6,22,4],[32,12,22,10,"sessionAggregates"],[32,29,22,27],[32,32,22,30],[32,36,22,34],[32,37,22,35,"getSessionAggregates"],[32,57,22,55],[32,58,22,56],[32,59,22,57],[33,6,23,4],[33,10,23,8,"sessionAggregates"],[33,27,23,25],[33,28,23,26,"aggregates"],[33,38,23,36],[33,39,23,37,"length"],[33,45,23,43],[33,50,23,48],[33,51,23,49],[33,53,23,51],[34,8,24,6],[35,6,25,4],[36,6,26,4],[36,10,26,8],[36,11,26,9,"_pendingAggregates"],[36,29,26,27],[36,32,26,30],[36,33,26,31],[36,34,26,32],[37,6,27,4],[37,10,27,8],[37,11,27,9,"_client"],[37,18,27,16],[37,19,27,17,"sendSession"],[37,30,27,28],[37,31,27,29,"sessionAggregates"],[37,48,27,46],[37,49,27,47],[38,4,28,2],[40,4,30,2],[41,4,31,3,"getSessionAggregates"],[41,24,31,23,"getSessionAggregates"],[41,25,31,23],[41,27,31,26],[42,6,32,4],[42,12,32,10,"aggregates"],[42,22,32,20],[42,25,32,23,"Object"],[42,31,32,29],[42,32,32,30,"keys"],[42,36,32,34],[42,37,32,35],[42,41,32,39],[42,42,32,40,"_pendingAggregates"],[42,60,32,58],[42,61,32,59],[42,62,32,60,"map"],[42,65,32,63],[42,66,32,65,"key"],[42,69,32,68],[42,73,32,73],[43,8,33,6],[43,15,33,13],[43,19,33,17],[43,20,33,18,"_pendingAggregates"],[43,38,33,36],[43,39,33,37,"parseInt"],[43,47,33,45],[43,48,33,46,"key"],[43,51,33,49],[43,52,33,50],[43,53,33,51],[44,6,34,4],[44,7,34,5],[44,8,34,6],[45,6,36,4],[45,12,36,10,"sessionAggregates"],[45,29,36,27],[45,32,36,30],[46,8,37,6,"attrs"],[46,13,37,11],[46,15,37,13],[46,19,37,17],[46,20,37,18,"_sessionAttrs"],[46,33,37,31],[47,8,38,6,"aggregates"],[48,6,39,4],[48,7,39,5],[49,6,40,4],[49,13,40,11],[49,17,40,11,"dropUndefinedKeys"],[49,29,40,28],[49,30,40,28,"dropUndefinedKeys"],[49,47,40,28],[49,49,40,29,"sessionAggregates"],[49,66,40,46],[49,67,40,47],[50,4,41,2],[52,4,43,2],[53,4,44,3,"close"],[53,9,44,8,"close"],[53,10,44,8],[53,12,44,11],[54,6,45,4,"clearInterval"],[54,19,45,17],[54,20,45,18],[54,24,45,22],[54,25,45,23,"_intervalId"],[54,36,45,34],[54,37,45,35],[55,6,46,4],[55,10,46,8],[55,11,46,9,"_isEnabled"],[55,21,46,19],[55,24,46,22],[55,29,46,27],[56,6,47,4],[56,10,47,8],[56,11,47,9,"flush"],[56,16,47,14],[56,17,47,15],[56,18,47,16],[57,4,48,2],[59,4,50,2],[60,0,51,0],[61,0,52,0],[62,0,53,0],[63,0,54,0],[64,4,55,3,"incrementSessionStatusCount"],[64,31,55,30,"incrementSessionStatusCount"],[64,32,55,30],[64,34,55,33],[65,6,56,4],[65,10,56,8],[65,11,56,9],[65,15,56,13],[65,16,56,14,"_isEnabled"],[65,26,56,24],[65,28,56,26],[66,8,57,6],[67,6,58,4],[68,6,59,4],[68,12,59,10,"scope"],[68,17,59,15],[68,20,59,18],[68,24,59,18,"getCurrentHub"],[68,30,59,31],[68,31,59,31,"getCurrentHub"],[68,44,59,31],[68,46,59,32],[68,47,59,33],[68,48,59,34,"getScope"],[68,56,59,42],[68,57,59,43],[68,58,59,44],[69,6,60,4],[69,12,60,10,"requestSession"],[69,26,60,24],[69,29,60,27,"scope"],[69,34,60,32],[69,35,60,33,"getRequestSession"],[69,52,60,50],[69,53,60,51],[69,54,60,52],[70,6,62,4],[70,10,62,8,"requestSession"],[70,24,62,22],[70,28,62,26,"requestSession"],[70,42,62,40],[70,43,62,41,"status"],[70,49,62,47],[70,51,62,49],[71,8,63,6],[71,12,63,10],[71,13,63,11,"_incrementSessionStatusCount"],[71,41,63,39],[71,42,63,40,"requestSession"],[71,56,63,54],[71,57,63,55,"status"],[71,63,63,61],[71,65,63,63],[71,69,63,67,"Date"],[71,73,63,71],[71,74,63,72],[71,75,63,73],[71,76,63,74],[72,8,64,6],[73,8,65,6],[74,8,66,6,"scope"],[74,13,66,11],[74,14,66,12,"setRequestSession"],[74,31,66,29],[74,32,66,30,"undefined"],[74,41,66,39],[74,42,66,40],[75,8,67,6],[76,6,68,4],[77,4,69,2],[79,4,71,2],[80,0,72,0],[81,0,73,0],[82,0,74,0],[83,4,75,3,"_incrementSessionStatusCount"],[83,32,75,31,"_incrementSessionStatusCount"],[83,33,75,32,"status"],[83,39,75,38],[83,41,75,40,"date"],[83,45,75,44],[83,47,75,46],[84,6,76,4],[85,6,77,4],[85,12,77,10,"sessionStartedTrunc"],[85,31,77,29],[85,34,77,32],[85,38,77,36,"Date"],[85,42,77,40],[85,43,77,41,"date"],[85,47,77,45],[85,48,77,46],[85,49,77,47,"setSeconds"],[85,59,77,57],[85,60,77,58],[85,61,77,59],[85,63,77,61],[85,64,77,62],[85,65,77,63],[86,6,78,4],[86,10,78,8],[86,11,78,9,"_pendingAggregates"],[86,29,78,27],[86,30,78,28,"sessionStartedTrunc"],[86,49,78,47],[86,50,78,48],[86,53,78,51],[86,57,78,55],[86,58,78,56,"_pendingAggregates"],[86,76,78,74],[86,77,78,75,"sessionStartedTrunc"],[86,96,78,94],[86,97,78,95],[86,101,78,99],[86,102,78,100],[86,103,78,101],[88,6,80,4],[89,6,81,4],[90,6,82,4],[90,12,82,10,"aggregationCounts"],[90,29,82,27],[90,32,82,30],[90,36,82,34],[90,37,82,35,"_pendingAggregates"],[90,55,82,53],[90,56,82,54,"sessionStartedTrunc"],[90,75,82,73],[90,76,82,74],[91,6,83,4],[91,10,83,8],[91,11,83,9,"aggregationCounts"],[91,28,83,26],[91,29,83,27,"started"],[91,36,83,34],[91,38,83,36],[92,8,84,6,"aggregationCounts"],[92,25,84,23],[92,26,84,24,"started"],[92,33,84,31],[92,36,84,34],[92,40,84,38,"Date"],[92,44,84,42],[92,45,84,43,"sessionStartedTrunc"],[92,64,84,62],[92,65,84,63],[92,66,84,64,"toISOString"],[92,77,84,75],[92,78,84,76],[92,79,84,77],[93,6,85,4],[94,6,87,4],[94,14,87,12,"status"],[94,20,87,18],[95,8,88,6],[95,13,88,11],[95,22,88,20],[96,10,89,8,"aggregationCounts"],[96,27,89,25],[96,28,89,26,"errored"],[96,35,89,33],[96,38,89,36],[96,39,89,37,"aggregationCounts"],[96,56,89,54],[96,57,89,55,"errored"],[96,64,89,62],[96,68,89,66],[96,69,89,67],[96,73,89,71],[96,74,89,72],[97,10,90,8],[97,17,90,15,"aggregationCounts"],[97,34,90,32],[97,35,90,33,"errored"],[97,42,90,40],[98,8,91,6],[98,13,91,11],[98,17,91,15],[99,10,92,8,"aggregationCounts"],[99,27,92,25],[99,28,92,26,"exited"],[99,34,92,32],[99,37,92,35],[99,38,92,36,"aggregationCounts"],[99,55,92,53],[99,56,92,54,"exited"],[99,62,92,60],[99,66,92,64],[99,67,92,65],[99,71,92,69],[99,72,92,70],[100,10,93,8],[100,17,93,15,"aggregationCounts"],[100,34,93,32],[100,35,93,33,"exited"],[100,41,93,39],[101,8,94,6],[102,10,95,8,"aggregationCounts"],[102,27,95,25],[102,28,95,26,"crashed"],[102,35,95,33],[102,38,95,36],[102,39,95,37,"aggregationCounts"],[102,56,95,54],[102,57,95,55,"crashed"],[102,64,95,62],[102,68,95,66],[102,69,95,67],[102,73,95,71],[102,74,95,72],[103,10,96,8],[103,17,96,15,"aggregationCounts"],[103,34,96,32],[103,35,96,33,"crashed"],[103,42,96,40],[104,6,97,4],[105,4,98,2],[106,2,99,0],[107,0,99,1],[107,3]],"functionMap":{"names":["<global>","SessionFlusher","SessionFlusher#constructor","setInterval$argument_0","SessionFlusher#flush","SessionFlusher#getSessionAggregates","Object.keys.map$argument_0","SessionFlusher#close","SessionFlusher#incrementSessionStatusCount","SessionFlusher#_incrementSessionStatusCount"],"mappings":"AAA;ACM;GCE;mCCO,kBD;GDE;GGG;GHO;GIG;gECC;KDE;GJO;GMG;GNI;GOO;GPc;GQM;GRuB;CDC"},"hasCjsExports":false},"type":"js/module"}]}