<analysis>

**original_problem_statement**:
The user's primary goal was to perform a comprehensive security and stability overhaul of the application's identity, authentication, administration, and error handling systems. This involved:
1.  **Identity Hardening (Backend)**: Fixing critical identity vulnerabilities by using canonical usernames, immutable user IDs in JWTs, and securing the super-admin account.
2.  **GOD MODE Implementation (Backend)**: Implementing a full suite of powerful, server-authoritative administrative endpoints, secured with robust access control and detailed audit logging.
3.  **Token Revocation (Backend)**: Implementing a secure and performant two-layer token revocation system (surgical and mass revocation).
4.  **Code Quality and Refactoring (Backend)**: Centralizing auth logic, ensuring all datetime handling is timezone-aware (UTC), and making DB indexes production-safe.
5.  **Crash Containment & Safe Failure (Frontend)**: Implementing a global, centralized system for handling API errors (4xx/5xx), standardizing the logic for all data mutations to prevent inconsistent states, and eliminating optimistic UI updates for critical data like currency.

**User's preferred language**: English

**what currently exists?**
The application has undergone a complete, production-grade security and stability hardening on both the backend and frontend.
- **Backend**: The auth system is fully hardened with canonical usernames, immutable UUIDs in JWTs, integer-based timestamps, and timezone-aware logic. A comprehensive suite of GOD MODE admin endpoints exists, protected by a global middleware and a  dependency. A two-layer token revocation system is active and all admin actions are captured in a detailed audit log. All mutation endpoints now correctly check for frozen accounts via a  helper, effectively making frozen accounts read-only.
- **Frontend**: A global error handling system has been implemented.
    - An Axios response interceptor in  centrally handles all major HTTP error codes (401, 403, 429, 400, 404, 5xx), preventing crashes and providing consistent user feedback.
    - A  wrapper in  enforces a standard, safe pattern for all API calls that change data, including consistent loading/success/error states and server data refreshing.
    - The 401 (Unauthorized) flow is now deterministic, triggering a full logout that clears persisted  data to prevent inconsistent UI states.
    - Logic is in place to prevent duplicate error alerts (e.g., from both the global interceptor and a local screen).

**Last working item**:
    - Last item agent was working: The agent completed a final production polish pass on the newly created frontend stability features. This involved refining the Axios interceptor and  wrapper to prevent double alerts, preserve server error details correctly, improve 4xx error coverage, and make the forced 401 logout flow fully deterministic by ensuring it clears persisted storage () first.
    - Status: USER VERIFICATION PENDING
    - Agent Testing Done: Y
    - Which testing method agent to use? both
    - User Testing Done: N

**All Pending/In progress Issue list**:
There are no pending or in-progress issues. The entire security and stability overhaul is functionally complete, pending final user review.

**In progress Task List**:
There are no in-progress tasks.

**Upcoming and Future Tasks**
*   **Upcoming Tasks:**
    *   **P0: Implement Network Instability Handling (Frontend)**: As mentioned by the user as the NEXT step, this involves adding:
        *   Request retry/backoff logic for idempotent GET requests.
        *   Idempotency keys for critical POST requests to prevent duplicate actions.
        *   An offline banner and a tap to retry mechanism for failed requests.
    *   **P1: Implement Server-Side Entitlements & IAP Flow**: The task from the original problem statement to make entitlements server-authoritative and wire up a real purchase flow (e.g., with RevenueCat) has not been started.
    *   **P1: Re-introduce Cinematic Playback Behind Paywall**: The original plan to add a Play Cinematic button back to , guarded by entitlement checks, is still pending.

*   **Future Tasks:**
    *   **P2: Enable MFA for Admin Account**: The database fields (, ) exist, but the full implementation (setup, verification) needs to be built.
    *   **P2: Fix Web Video Asset Compatibility**: The cinematic video files in  use a codec unsupported by web browsers. The  script needs to be run and verified.
    *   **P2: Consolidate and Refactor **: The main backend file, , is a large monolith and is a candidate for a file-level refactor to improve maintainability.

**Completed work in this session**
- **Complete Backend Security Overhaul:**
    - Finalized JWT claims to use integer timestamps and made all datetime handling UTC-aware.
    - Made database indexes (, ) non-sparse and startup-safe.
    - Added rate-limiting to the  endpoint.
    - Implemented a global middleware to guard all  routes.
    - **Systematically applied frozen account checks to all 60+ mutation endpoints**, making frozen accounts read-only across the entire backend.
- **Complete Frontend Stability Overhaul:**
    - **Implemented a global Axios response interceptor** in  to centrally handle 401, 403, 429, 400, 404, and 5xx errors.
    - **Created a  wrapper** in  to standardize mutation logic (loading states, error handling, data refresh). The wrapper now returns a structured result  to preserve server details.
    - **Made the 401 force logout flow fully deterministic**, ensuring it clears  to prevent auth race conditions.
    - **Implemented logic to prevent duplicate error alerts** from the global interceptor and local screens.
    - Refactored key mutations in  (gacha, upgrades, etc.) to use the new  pattern.
    - Audited and confirmed there are no optimistic currency/XP updates in the frontend.

**Earlier issues found/mentioned but not fixed**
   - **Issue 1:** The cinematic video feature for 5+ star heroes is known to be broken. The video files fail to load due to an incompatible codec. The frontend gracefully handles the error, but the feature is non-functional.
     - **Why to solve this issue and what will be achieved with this?** Fixing this will restore a premium cosmetic feature for players who have acquired high-tier heroes.
     - **Should Test frontend/backend/both after fix:** frontend
     - **Is recurring issue?** N

**Known issue recurrence from previous fork**
  - The main backend file, , remains a large monolith. The file has grown even larger during the security hardening, making it a prime candidate for future refactoring to improve maintainability.

**Code Architecture**
safeMutationsafeMutation

**Key Technical Concepts**
- **Backend:**
    - **Canonical Usernames & Immutable JWTs**: Core of the hardened identity system.
    - **Centralized Auth Logic**: All auth checks flow through .
    - **Two-Layer Token Revocation**: Surgical () and mass () revocation.
    - **Production-Grade Audit Logging**: Detailed, immutable logs for all admin actions.
    - **Timezone-Aware Datetimes (UTC)**: Prevents time-related bugs.
    - **Production-Safe DB Migrations**:  calls are guarded to not fail on already exists.
- **Frontend:**
    - **Global API Error Handling (Axios Interceptors)**: A single source of truth for handling HTTP error codes (4xx/5xx) and providing consistent user feedback.
    - **Safe Mutation Wrapper**: A higher-order function pattern () that enforces consistent logic for API calls that mutate data, including loading states, success/failure handling, and data refreshing.
    - **Deterministic Auth State Management**: A robust flow for handling forced logouts (401) that clears persisted storage () before in-memory state to prevent race conditions.
    - **Duplicate UX Prevention**: Using flags on error objects () to coordinate between global (interceptor) and local (screen) error UI.

**key DB schema**
  - **users**: 
  - **revoked_tokens**:  (with a TTL index on )
  - **admin_audit_log**: 

**All files of reference**
- : The monolithic backend file containing all security logic.
- : Key frontend file containing the Axios instance and the new global response interceptor.
- : New frontend file with the  wrapper function.
- : The main Zustand store, now integrated with the new stability patterns.
- : The root layout file, responsible for initializing the force logout callback.

**Critical Info for New Agent**
- The backend and frontend have been significantly hardened for security and stability. **Do not add new logic that bypasses these systems.**
- **Backend**: All new mutation endpoints MUST use the  helper to enforce frozen account checks.
- **Frontend**: All new mutations SHOULD use the  wrapper from  to ensure consistent error handling and state management. New global error logic should be added to the interceptor in .
- The user is a security and stability expert who performs deep code audits. Adherence to the established patterns for security, validation, logging, and error handling is critical.
- The next high-priority task, as indicated by the user, is to implement frontend network instability handling (retries, offline banners, etc.).

**documents created in this job**
- /app/frontend/lib/safeMutation.ts

**Last 10 User Messages and any pending HUMAN messages**
1.  **User (LATEST)**: Provided a final, refined diff for the frontend stability polish, focusing on making the error handling even more robust and deterministic. (RESOLVED, agent applied the diff).
2.  **User**: Requested the diff for the polish pass to review it. (RESOLVED, agent provided it).
3.  **User**: Reviewed the agent's first polish pass and identified 4 high-risk issues (double alerts, error swallowing, non-deterministic logout, incomplete 4xx handling) and requested a final patch. (RESOLVED, agent implemented fixes).
4.  **User**: Requested the diff of the initial stability fixes (interceptor, safeMutation) to review. (RESOLVED, agent provided code blocks).
5.  **User**: Provided instructions to implement the three keystone frontend stability fixes: a global interceptor, a  wrapper, and an audit to kill optimistic updates. (COMPLETED).
6.  **User**: Audited the frontend error handling, confirmed it was partial and inconsistent, and requested fixes. (COMPLETED).
7.  **User**: Completed the backend security finalization by ensuring ALL mutation endpoints had frozen account checks. (COMPLETED).
8.  **User**: Requested the agent to systematically find and fix all mutation endpoints that were missing frozen account checks. (COMPLETED).
9.  **User**: Provided instructions for the final backend security hardening: add a global admin middleware, audit for auth bypasses, and enforce frozen account checks on mutations. (COMPLETED).
10. **User**: Confirmed the entire backend auth/audit hardening arc was complete and requested a final verification sequence with . (COMPLETED).

**Project Health Check:**
- **Broken**:
    - Web video playback for cinematics (due to incompatible video codecs).
- **Hardened**:
    - The entire backend identity, authentication, authorization, and administration system.
    - The entire frontend API error handling and mutation logic.
- **Mocked**:
    - The In-App Purchase (IAP) flow is not implemented.

**3rd Party Integrations**
*   **OpenAI GPT-4**: For backend AI narration (via Emergent LLM Key).
*   **RevenueCat**: Packages installed, but the integration is functionally disabled.
*   **expo-av**: Used for video playback.
*   **ffmpeg**: Installed in the environment for video processing.
*   **axios**: Used for frontend API calls.
*   **zustand**: For frontend state management.

**Testing status**
  - Testing agent used after significant changes: NO (Agent used extensive custom scripts and manual verification in this session).
  - Troubleshoot agent used after agent stuck in loop: YES (Agent self-corrected from a recursion error caused by a faulty  replacement).
  - Test files created: None.
  - Known regressions: None.

**Credentials to test flow:**
- **Super Admin**:
    - Username: 
    - Password: 

**What agent forgot to execute**
- The agent successfully executed all user requests in this session. The forgotten items are the larger-scope tasks from the initial handover summary that were intentionally deferred to focus on the security/stability overhaul (e.g., IAP flow, MFA). These are correctly captured in Upcoming and Future Tasks.

</analysis>
