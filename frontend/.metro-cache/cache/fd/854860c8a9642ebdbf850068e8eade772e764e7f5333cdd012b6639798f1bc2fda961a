{"dependencies":[{"name":"../telemetry/events","data":{"asyncType":null,"isESMImport":true,"locs":[{"start":{"line":9,"column":0,"index":252},"end":{"line":9,"column":52,"index":304}}],"key":"k7LZwhoWMWET/ud396YGvDlODrM=","exportNames":["*"],"imports":1}},{"name":"./config","data":{"asyncType":null,"isESMImport":true,"locs":[{"start":{"line":10,"column":0,"index":305},"end":{"line":10,"column":50,"index":355}}],"key":"apL7GyCxHQJfXSypmIMW0g+q+wo=","exportNames":["*"],"imports":1}},{"name":"../ids/sourceId","data":{"asyncType":null,"isESMImport":true,"locs":[{"start":{"line":12,"column":0,"index":398},"end":{"line":12,"column":47,"index":445}}],"key":"8+/shoGzc074iuptzaKMztUCXgY=","exportNames":["*"],"imports":1}}],"output":[{"data":{"code":"__d(function (global, require, _$$_IMPORT_DEFAULT, _$$_IMPORT_ALL, module, exports, _dependencyMap) {\n  \"use strict\";\n\n  Object.defineProperty(exports, '__esModule', {\n    value: true\n  });\n  exports.isInsufficientShardsError = isInsufficientShardsError;\n  exports.getProgressionTable = getProgressionTable;\n  exports.getHeroStats = getHeroStats;\n  exports.promoteHero = promoteHero;\n  exports.generatePromotionSourceId = generatePromotionSourceId;\n  var _telemetryEvents = require(_dependencyMap[0], \"../telemetry/events\");\n  var _config = require(_dependencyMap[1], \"./config\");\n  var _idsSourceId = require(_dependencyMap[2], \"../ids/sourceId\");\n  // /app/frontend/lib/api/heroProgression.ts\n  // Phase 3.39-3.41: Hero Progression API\n  //\n  // Server-authoritative hero star/stat system.\n  // All mutations go through canonical receipts.\n  // NO CLIENT-SIDE STAR/STAT MUTATIONS.\n\n  // Auth handled by config.ts\n\n  // Phase 3.49: Robust sourceId generation\n\n  // =============================================================================\n  // TYPES\n  // =============================================================================\n\n  function isInsufficientShardsError(error) {\n    if (!error || typeof error !== 'object') return false;\n    return error.code === 'INSUFFICIENT_SHARDS';\n  }\n\n  // =============================================================================\n  // API FUNCTIONS\n  // =============================================================================\n\n  /**\n   * Get the locked progression table (read-only)\n   */\n  async function getProgressionTable() {\n    const res = await fetch((0, _config.apiUrl)('/api/hero/progression-table'));\n    if (!res.ok) {\n      throw new Error('Failed to fetch progression table');\n    }\n    return await res.json();\n  }\n\n  /**\n   * Get server-derived stats for a hero (Phase 3.41)\n   */\n  async function getHeroStats(heroId) {\n    const headers = await (0, _config.getJsonHeaders)();\n    (0, _telemetryEvents.track)(_telemetryEvents.Events.HERO_STATS_VIEWED, {\n      heroId\n    });\n    const res = await fetch((0, _config.apiUrl)(`/api/hero/${heroId}/stats`), {\n      headers\n    });\n    if (!res.ok) {\n      throw new Error('Failed to fetch hero stats');\n    }\n    return await res.json();\n  }\n\n  /**\n   * Promote hero to next star (Phase 3.39)\n   * \n   * @param heroId - Hero to promote\n   * @param sourceId - Client-generated ID for idempotency\n   */\n  async function promoteHero(heroId, sourceId) {\n    const headers = await (0, _config.getJsonHeaders)();\n    (0, _telemetryEvents.track)(_telemetryEvents.Events.HERO_PROMOTION_SUBMITTED, {\n      heroId,\n      sourceId\n    });\n    const res = await fetch((0, _config.apiUrl)('/api/hero/promote'), {\n      method: 'POST',\n      headers,\n      body: JSON.stringify({\n        hero_id: heroId,\n        source_id: sourceId\n      })\n    });\n    if (!res.ok) {\n      const errorData = await res.json().catch(() => ({}));\n      if (errorData.code === 'INSUFFICIENT_SHARDS') {\n        (0, _telemetryEvents.track)(_telemetryEvents.Events.HERO_PROMOTION_INSUFFICIENT_SHARDS, {\n          heroId,\n          required: errorData.required,\n          available: errorData.available\n        });\n      } else {\n        (0, _telemetryEvents.track)(_telemetryEvents.Events.HERO_PROMOTION_FAILED, {\n          heroId,\n          error: errorData.code || errorData.detail || 'Unknown error'\n        });\n      }\n      throw errorData;\n    }\n    const receipt = await res.json();\n    (0, _telemetryEvents.track)(_telemetryEvents.Events.HERO_PROMOTION_SUCCESS, {\n      heroId,\n      starBefore: receipt.heroDelta.starBefore,\n      starAfter: receipt.heroDelta.starAfter,\n      shardsSpent: receipt.shardsSpent\n    });\n    return receipt;\n  }\n\n  /**\n   * Generate a robust sourceId for hero promotion.\n   * Uses makeSourceId for collision-resistant idempotency.\n   */\n  function generatePromotionSourceId(heroId) {\n    return (0, _idsSourceId.makeSourceId)(`promote_${heroId}`);\n  }\n});","lineCount":120,"map":[[7,2,77,0,"exports"],[7,9,77,0],[7,10,77,0,"isInsufficientShardsError"],[7,35,77,0],[7,38,77,0,"isInsufficientShardsError"],[7,63,77,0],[8,2,89,0,"exports"],[8,9,89,0],[8,10,89,0,"getProgressionTable"],[8,29,89,0],[8,32,89,0,"getProgressionTable"],[8,51,89,0],[9,2,102,0,"exports"],[9,9,102,0],[9,10,102,0,"getHeroStats"],[9,22,102,0],[9,25,102,0,"getHeroStats"],[9,37,102,0],[10,2,122,0,"exports"],[10,9,122,0],[10,10,122,0,"promoteHero"],[10,21,122,0],[10,24,122,0,"promoteHero"],[10,35,122,0],[11,2,174,0,"exports"],[11,9,174,0],[11,10,174,0,"generatePromotionSourceId"],[11,35,174,0],[11,38,174,0,"generatePromotionSourceId"],[11,63,174,0],[12,2,9,0],[12,6,9,0,"_telemetryEvents"],[12,22,9,0],[12,25,9,0,"require"],[12,32,9,0],[12,33,9,0,"_dependencyMap"],[12,47,9,0],[13,2,10,0],[13,6,10,0,"_config"],[13,13,10,0],[13,16,10,0,"require"],[13,23,10,0],[13,24,10,0,"_dependencyMap"],[13,38,10,0],[14,2,12,0],[14,6,12,0,"_idsSourceId"],[14,18,12,0],[14,21,12,0,"require"],[14,28,12,0],[14,29,12,0,"_dependencyMap"],[14,43,12,0],[15,2,1,0],[16,2,2,0],[17,2,3,0],[18,2,4,0],[19,2,5,0],[20,2,6,0],[22,2,8,0],[24,2,11,0],[26,2,14,0],[27,2,15,0],[28,2,16,0],[30,2,77,7],[30,11,77,16,"isInsufficientShardsError"],[30,36,77,41,"isInsufficientShardsError"],[30,37,77,42,"error"],[30,42,77,56],[30,44,77,92],[31,4,78,2],[31,8,78,6],[31,9,78,7,"error"],[31,14,78,12],[31,18,78,16],[31,25,78,23,"error"],[31,30,78,28],[31,35,78,33],[31,43,78,41],[31,45,78,43],[31,52,78,50],[31,57,78,55],[32,4,79,2],[32,11,79,10,"error"],[32,16,79,15],[32,17,79,44,"code"],[32,21,79,48],[32,26,79,53],[32,47,79,74],[33,2,80,0],[35,2,82,0],[36,2,83,0],[37,2,84,0],[39,2,86,0],[40,0,87,0],[41,0,88,0],[42,2,89,7],[42,17,89,22,"getProgressionTable"],[42,36,89,41,"getProgressionTable"],[42,37,89,41],[42,39,89,71],[43,4,90,2],[43,10,90,8,"res"],[43,13,90,11],[43,16,90,14],[43,22,90,20,"fetch"],[43,27,90,25],[43,28,90,26],[43,32,90,26,"apiUrl"],[43,39,90,32],[43,40,90,32,"apiUrl"],[43,46,90,32],[43,48,90,33],[43,77,90,62],[43,78,90,63],[43,79,90,64],[44,4,92,2],[44,8,92,6],[44,9,92,7,"res"],[44,12,92,10],[44,13,92,11,"ok"],[44,15,92,13],[44,17,92,15],[45,6,93,4],[45,12,93,10],[45,16,93,14,"Error"],[45,21,93,19],[45,22,93,20],[45,57,93,55],[45,58,93,56],[46,4,94,2],[47,4,96,2],[47,11,96,9],[47,17,96,15,"res"],[47,20,96,18],[47,21,96,19,"json"],[47,25,96,23],[47,26,96,24],[47,27,96,25],[48,2,97,0],[50,2,99,0],[51,0,100,0],[52,0,101,0],[53,2,102,7],[53,17,102,22,"getHeroStats"],[53,29,102,34,"getHeroStats"],[53,30,102,35,"heroId"],[53,36,102,49],[53,38,102,79],[54,4,103,2],[54,10,103,8,"headers"],[54,17,103,15],[54,20,103,18],[54,26,103,24],[54,30,103,24,"getJsonHeaders"],[54,37,103,38],[54,38,103,38,"getJsonHeaders"],[54,52,103,38],[54,54,103,39],[54,55,103,40],[55,4,105,2],[55,8,105,2,"track"],[55,24,105,7],[55,25,105,7,"track"],[55,30,105,7],[55,32,105,8,"Events"],[55,48,105,14],[55,49,105,14,"Events"],[55,55,105,14],[55,56,105,15,"HERO_STATS_VIEWED"],[55,73,105,32],[55,75,105,34],[56,6,105,36,"heroId"],[57,4,105,43],[57,5,105,44],[57,6,105,45],[58,4,107,2],[58,10,107,8,"res"],[58,13,107,11],[58,16,107,14],[58,22,107,20,"fetch"],[58,27,107,25],[58,28,107,26],[58,32,107,26,"apiUrl"],[58,39,107,32],[58,40,107,32,"apiUrl"],[58,46,107,32],[58,48,107,33],[58,61,107,46,"heroId"],[58,67,107,52],[58,75,107,60],[58,76,107,61],[58,78,107,63],[59,6,107,65,"headers"],[60,4,107,73],[60,5,107,74],[60,6,107,75],[61,4,109,2],[61,8,109,6],[61,9,109,7,"res"],[61,12,109,10],[61,13,109,11,"ok"],[61,15,109,13],[61,17,109,15],[62,6,110,4],[62,12,110,10],[62,16,110,14,"Error"],[62,21,110,19],[62,22,110,20],[62,50,110,48],[62,51,110,49],[63,4,111,2],[64,4,113,2],[64,11,113,9],[64,17,113,15,"res"],[64,20,113,18],[64,21,113,19,"json"],[64,25,113,23],[64,26,113,24],[64,27,113,25],[65,2,114,0],[67,2,116,0],[68,0,117,0],[69,0,118,0],[70,0,119,0],[71,0,120,0],[72,0,121,0],[73,2,122,7],[73,17,122,22,"promoteHero"],[73,28,122,33,"promoteHero"],[73,29,123,2,"heroId"],[73,35,123,16],[73,37,124,2,"sourceId"],[73,45,124,18],[73,47,125,29],[74,4,126,2],[74,10,126,8,"headers"],[74,17,126,15],[74,20,126,18],[74,26,126,24],[74,30,126,24,"getJsonHeaders"],[74,37,126,38],[74,38,126,38,"getJsonHeaders"],[74,52,126,38],[74,54,126,39],[74,55,126,40],[75,4,128,2],[75,8,128,2,"track"],[75,24,128,7],[75,25,128,7,"track"],[75,30,128,7],[75,32,128,8,"Events"],[75,48,128,14],[75,49,128,14,"Events"],[75,55,128,14],[75,56,128,15,"HERO_PROMOTION_SUBMITTED"],[75,80,128,39],[75,82,128,41],[76,6,128,43,"heroId"],[76,12,128,49],[77,6,128,51,"sourceId"],[78,4,128,60],[78,5,128,61],[78,6,128,62],[79,4,130,2],[79,10,130,8,"res"],[79,13,130,11],[79,16,130,14],[79,22,130,20,"fetch"],[79,27,130,25],[79,28,130,26],[79,32,130,26,"apiUrl"],[79,39,130,32],[79,40,130,32,"apiUrl"],[79,46,130,32],[79,48,130,33],[79,67,130,52],[79,68,130,53],[79,70,130,55],[80,6,131,4,"method"],[80,12,131,10],[80,14,131,12],[80,20,131,18],[81,6,132,4,"headers"],[81,13,132,11],[82,6,133,4,"body"],[82,10,133,8],[82,12,133,10,"JSON"],[82,16,133,14],[82,17,133,15,"stringify"],[82,26,133,24],[82,27,133,25],[83,8,134,6,"hero_id"],[83,15,134,13],[83,17,134,15,"heroId"],[83,23,134,21],[84,8,135,6,"source_id"],[84,17,135,15],[84,19,135,17,"sourceId"],[85,6,136,4],[85,7,136,5],[86,4,137,2],[86,5,137,3],[86,6,137,4],[87,4,139,2],[87,8,139,6],[87,9,139,7,"res"],[87,12,139,10],[87,13,139,11,"ok"],[87,15,139,13],[87,17,139,15],[88,6,140,4],[88,12,140,10,"errorData"],[88,21,140,19],[88,24,140,22],[88,30,140,28,"res"],[88,33,140,31],[88,34,140,32,"json"],[88,38,140,36],[88,39,140,37],[88,40,140,38],[88,41,140,39,"catch"],[88,46,140,44],[88,47,140,45],[88,54,140,52],[88,55,140,53],[88,56,140,54],[88,57,140,55],[88,58,140,56],[89,6,142,4],[89,10,142,8,"errorData"],[89,19,142,17],[89,20,142,18,"code"],[89,24,142,22],[89,29,142,27],[89,50,142,48],[89,52,142,50],[90,8,143,6],[90,12,143,6,"track"],[90,28,143,11],[90,29,143,11,"track"],[90,34,143,11],[90,36,143,12,"Events"],[90,52,143,18],[90,53,143,18,"Events"],[90,59,143,18],[90,60,143,19,"HERO_PROMOTION_INSUFFICIENT_SHARDS"],[90,94,143,53],[90,96,143,55],[91,10,144,8,"heroId"],[91,16,144,14],[92,10,145,8,"required"],[92,18,145,16],[92,20,145,18,"errorData"],[92,29,145,27],[92,30,145,28,"required"],[92,38,145,36],[93,10,146,8,"available"],[93,19,146,17],[93,21,146,19,"errorData"],[93,30,146,28],[93,31,146,29,"available"],[94,8,147,6],[94,9,147,7],[94,10,147,8],[95,6,148,4],[95,7,148,5],[95,13,148,11],[96,8,149,6],[96,12,149,6,"track"],[96,28,149,11],[96,29,149,11,"track"],[96,34,149,11],[96,36,149,12,"Events"],[96,52,149,18],[96,53,149,18,"Events"],[96,59,149,18],[96,60,149,19,"HERO_PROMOTION_FAILED"],[96,81,149,40],[96,83,149,42],[97,10,150,8,"heroId"],[97,16,150,14],[98,10,151,8,"error"],[98,15,151,13],[98,17,151,15,"errorData"],[98,26,151,24],[98,27,151,25,"code"],[98,31,151,29],[98,35,151,33,"errorData"],[98,44,151,42],[98,45,151,43,"detail"],[98,51,151,49],[98,55,151,53],[99,8,152,6],[99,9,152,7],[99,10,152,8],[100,6,153,4],[101,6,155,4],[101,12,155,10,"errorData"],[101,21,155,19],[102,4,156,2],[103,4,158,2],[103,10,158,8,"receipt"],[103,17,158,15],[103,20,158,18],[103,26,158,24,"res"],[103,29,158,27],[103,30,158,28,"json"],[103,34,158,32],[103,35,158,33],[103,36,158,34],[104,4,160,2],[104,8,160,2,"track"],[104,24,160,7],[104,25,160,7,"track"],[104,30,160,7],[104,32,160,8,"Events"],[104,48,160,14],[104,49,160,14,"Events"],[104,55,160,14],[104,56,160,15,"HERO_PROMOTION_SUCCESS"],[104,78,160,37],[104,80,160,39],[105,6,161,4,"heroId"],[105,12,161,10],[106,6,162,4,"starBefore"],[106,16,162,14],[106,18,162,16,"receipt"],[106,25,162,23],[106,26,162,24,"heroDelta"],[106,35,162,33],[106,36,162,34,"starBefore"],[106,46,162,44],[107,6,163,4,"starAfter"],[107,15,163,13],[107,17,163,15,"receipt"],[107,24,163,22],[107,25,163,23,"heroDelta"],[107,34,163,32],[107,35,163,33,"starAfter"],[107,44,163,42],[108,6,164,4,"shardsSpent"],[108,17,164,15],[108,19,164,17,"receipt"],[108,26,164,24],[108,27,164,25,"shardsSpent"],[109,4,165,2],[109,5,165,3],[109,6,165,4],[110,4,167,2],[110,11,167,9,"receipt"],[110,18,167,16],[111,2,168,0],[113,2,170,0],[114,0,171,0],[115,0,172,0],[116,0,173,0],[117,2,174,7],[117,11,174,16,"generatePromotionSourceId"],[117,36,174,41,"generatePromotionSourceId"],[117,37,174,42,"heroId"],[117,43,174,56],[117,45,174,66],[118,4,175,2],[118,11,175,9],[118,15,175,9,"makeSourceId"],[118,27,175,21],[118,28,175,21,"makeSourceId"],[118,40,175,21],[118,42,175,22],[118,53,175,33,"heroId"],[118,59,175,39],[118,61,175,41],[118,62,175,42],[119,2,176,0],[120,0,176,1],[120,3]],"functionMap":{"names":["<global>","isInsufficientShardsError","getProgressionTable","getHeroStats","promoteHero","res.json._catch$argument_0","generatePromotionSourceId"],"mappings":"AAA;OC4E;CDG;OES;CFQ;OGK;CHY;OIQ;6CCkB,UD;CJ4B;OMM;CNE"},"hasCjsExports":false},"type":"js/module"}]}