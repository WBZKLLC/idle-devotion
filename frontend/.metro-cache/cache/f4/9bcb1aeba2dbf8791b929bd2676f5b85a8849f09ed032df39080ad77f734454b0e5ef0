{"dependencies":[{"name":"@sentry/utils","data":{"asyncType":null,"isESMImport":false,"locs":[{"start":{"line":3,"column":14,"index":78},"end":{"line":3,"column":38,"index":102}}],"key":"ud8OE6Lg8Q81+bS6ynZj2uyMPdA=","exportNames":["*"],"imports":1}},{"name":"./hub.js","data":{"asyncType":null,"isESMImport":false,"locs":[{"start":{"line":4,"column":12,"index":116},"end":{"line":4,"column":31,"index":135}}],"key":"17NUtVIQT6VGY1RVn8kjoC2kMVI=","exportNames":["*"],"imports":1}}],"output":[{"data":{"code":"__d(function (global, require, _$$_IMPORT_DEFAULT, _$$_IMPORT_ALL, module, exports, _dependencyMap) {\n  Object.defineProperty(exports, '__esModule', {\n    value: true\n  });\n  const utils = require(_dependencyMap[0], \"@sentry/utils\");\n  const hub = require(_dependencyMap[1], \"./hub.js\");\n\n  /**\n   * @inheritdoc\n   */\n  class SessionFlusher {\n    constructor(client, attrs) {\n      this._client = client;\n      this.flushTimeout = 60;\n      this._pendingAggregates = {};\n      this._isEnabled = true;\n\n      // Call to setInterval, so that flush is called every 60 seconds\n      this._intervalId = setInterval(() => this.flush(), this.flushTimeout * 1000);\n      this._sessionAttrs = attrs;\n    }\n\n    /** Checks if `pendingAggregates` has entries, and if it does flushes them by calling `sendSession` */\n    flush() {\n      const sessionAggregates = this.getSessionAggregates();\n      if (sessionAggregates.aggregates.length === 0) {\n        return;\n      }\n      this._pendingAggregates = {};\n      this._client.sendSession(sessionAggregates);\n    }\n\n    /** Massages the entries in `pendingAggregates` and returns aggregated sessions */\n    getSessionAggregates() {\n      const aggregates = Object.keys(this._pendingAggregates).map(key => {\n        return this._pendingAggregates[parseInt(key)];\n      });\n      const sessionAggregates = {\n        attrs: this._sessionAttrs,\n        aggregates\n      };\n      return utils.dropUndefinedKeys(sessionAggregates);\n    }\n\n    /** JSDoc */\n    close() {\n      clearInterval(this._intervalId);\n      this._isEnabled = false;\n      this.flush();\n    }\n\n    /**\n     * Wrapper function for _incrementSessionStatusCount that checks if the instance of SessionFlusher is enabled then\n     * fetches the session status of the request from `Scope.getRequestSession().status` on the scope and passes them to\n     * `_incrementSessionStatusCount` along with the start date\n     */\n    incrementSessionStatusCount() {\n      if (!this._isEnabled) {\n        return;\n      }\n      const scope = hub.getCurrentHub().getScope();\n      const requestSession = scope.getRequestSession();\n      if (requestSession && requestSession.status) {\n        this._incrementSessionStatusCount(requestSession.status, new Date());\n        // This is not entirely necessarily but is added as a safe guard to indicate the bounds of a request and so in\n        // case captureRequestSession is called more than once to prevent double count\n        scope.setRequestSession(undefined);\n        /* eslint-enable @typescript-eslint/no-unsafe-member-access */\n      }\n    }\n\n    /**\n     * Increments status bucket in pendingAggregates buffer (internal state) corresponding to status of\n     * the session received\n     */\n    _incrementSessionStatusCount(status, date) {\n      // Truncate minutes and seconds on Session Started attribute to have one minute bucket keys\n      const sessionStartedTrunc = new Date(date).setSeconds(0, 0);\n      this._pendingAggregates[sessionStartedTrunc] = this._pendingAggregates[sessionStartedTrunc] || {};\n\n      // corresponds to aggregated sessions in one specific minute bucket\n      // for example, {\"started\":\"2021-03-16T08:00:00.000Z\",\"exited\":4, \"errored\": 1}\n      const aggregationCounts = this._pendingAggregates[sessionStartedTrunc];\n      if (!aggregationCounts.started) {\n        aggregationCounts.started = new Date(sessionStartedTrunc).toISOString();\n      }\n      switch (status) {\n        case 'errored':\n          aggregationCounts.errored = (aggregationCounts.errored || 0) + 1;\n          return aggregationCounts.errored;\n        case 'ok':\n          aggregationCounts.exited = (aggregationCounts.exited || 0) + 1;\n          return aggregationCounts.exited;\n        default:\n          aggregationCounts.crashed = (aggregationCounts.crashed || 0) + 1;\n          return aggregationCounts.crashed;\n      }\n    }\n  }\n  exports.SessionFlusher = SessionFlusher;\n});","lineCount":101,"map":[[2,2,1,0,"Object"],[2,8,1,6],[2,9,1,7,"defineProperty"],[2,23,1,21],[2,24,1,22,"exports"],[2,31,1,29],[2,33,1,31],[2,45,1,43],[2,47,1,45],[3,4,1,47,"value"],[3,9,1,52],[3,11,1,54],[4,2,1,59],[4,3,1,60],[4,4,1,61],[5,2,3,0],[5,8,3,6,"utils"],[5,13,3,11],[5,16,3,14,"require"],[5,23,3,21],[5,24,3,21,"_dependencyMap"],[5,38,3,21],[5,58,3,37],[5,59,3,38],[6,2,4,0],[6,8,4,6,"hub"],[6,11,4,9],[6,14,4,12,"require"],[6,21,4,19],[6,22,4,19,"_dependencyMap"],[6,36,4,19],[6,51,4,30],[6,52,4,31],[8,2,6,0],[9,0,7,0],[10,0,8,0],[11,2,9,0],[11,8,9,6,"SessionFlusher"],[11,22,9,20],[11,23,9,22],[12,4,11,3,"constructor"],[12,15,11,14,"constructor"],[12,16,11,15,"client"],[12,22,11,21],[12,24,11,23,"attrs"],[12,29,11,28],[12,31,11,30],[13,6,12,4],[13,10,12,8],[13,11,12,9,"_client"],[13,18,12,16],[13,21,12,19,"client"],[13,27,12,25],[14,6,13,4],[14,10,13,8],[14,11,13,9,"flushTimeout"],[14,23,13,21],[14,26,13,24],[14,28,13,26],[15,6,14,4],[15,10,14,8],[15,11,14,9,"_pendingAggregates"],[15,29,14,27],[15,32,14,30],[15,33,14,31],[15,34,14,32],[16,6,15,4],[16,10,15,8],[16,11,15,9,"_isEnabled"],[16,21,15,19],[16,24,15,22],[16,28,15,26],[18,6,17,4],[19,6,18,4],[19,10,18,8],[19,11,18,9,"_intervalId"],[19,22,18,20],[19,25,18,23,"setInterval"],[19,36,18,34],[19,37,18,35],[19,43,18,41],[19,47,18,45],[19,48,18,46,"flush"],[19,53,18,51],[19,54,18,52],[19,55,18,53],[19,57,18,55],[19,61,18,59],[19,62,18,60,"flushTimeout"],[19,74,18,72],[19,77,18,75],[19,81,18,79],[19,82,18,80],[20,6,19,4],[20,10,19,8],[20,11,19,9,"_sessionAttrs"],[20,24,19,22],[20,27,19,25,"attrs"],[20,32,19,30],[21,4,20,2],[23,4,22,2],[24,4,23,3,"flush"],[24,9,23,8,"flush"],[24,10,23,8],[24,12,23,11],[25,6,24,4],[25,12,24,10,"sessionAggregates"],[25,29,24,27],[25,32,24,30],[25,36,24,34],[25,37,24,35,"getSessionAggregates"],[25,57,24,55],[25,58,24,56],[25,59,24,57],[26,6,25,4],[26,10,25,8,"sessionAggregates"],[26,27,25,25],[26,28,25,26,"aggregates"],[26,38,25,36],[26,39,25,37,"length"],[26,45,25,43],[26,50,25,48],[26,51,25,49],[26,53,25,51],[27,8,26,6],[28,6,27,4],[29,6,28,4],[29,10,28,8],[29,11,28,9,"_pendingAggregates"],[29,29,28,27],[29,32,28,30],[29,33,28,31],[29,34,28,32],[30,6,29,4],[30,10,29,8],[30,11,29,9,"_client"],[30,18,29,16],[30,19,29,17,"sendSession"],[30,30,29,28],[30,31,29,29,"sessionAggregates"],[30,48,29,46],[30,49,29,47],[31,4,30,2],[33,4,32,2],[34,4,33,3,"getSessionAggregates"],[34,24,33,23,"getSessionAggregates"],[34,25,33,23],[34,27,33,26],[35,6,34,4],[35,12,34,10,"aggregates"],[35,22,34,20],[35,25,34,23,"Object"],[35,31,34,29],[35,32,34,30,"keys"],[35,36,34,34],[35,37,34,35],[35,41,34,39],[35,42,34,40,"_pendingAggregates"],[35,60,34,58],[35,61,34,59],[35,62,34,60,"map"],[35,65,34,63],[35,66,34,65,"key"],[35,69,34,68],[35,73,34,73],[36,8,35,6],[36,15,35,13],[36,19,35,17],[36,20,35,18,"_pendingAggregates"],[36,38,35,36],[36,39,35,37,"parseInt"],[36,47,35,45],[36,48,35,46,"key"],[36,51,35,49],[36,52,35,50],[36,53,35,51],[37,6,36,4],[37,7,36,5],[37,8,36,6],[38,6,38,4],[38,12,38,10,"sessionAggregates"],[38,29,38,27],[38,32,38,30],[39,8,39,6,"attrs"],[39,13,39,11],[39,15,39,13],[39,19,39,17],[39,20,39,18,"_sessionAttrs"],[39,33,39,31],[40,8,40,6,"aggregates"],[41,6,41,4],[41,7,41,5],[42,6,42,4],[42,13,42,11,"utils"],[42,18,42,16],[42,19,42,17,"dropUndefinedKeys"],[42,36,42,34],[42,37,42,35,"sessionAggregates"],[42,54,42,52],[42,55,42,53],[43,4,43,2],[45,4,45,2],[46,4,46,3,"close"],[46,9,46,8,"close"],[46,10,46,8],[46,12,46,11],[47,6,47,4,"clearInterval"],[47,19,47,17],[47,20,47,18],[47,24,47,22],[47,25,47,23,"_intervalId"],[47,36,47,34],[47,37,47,35],[48,6,48,4],[48,10,48,8],[48,11,48,9,"_isEnabled"],[48,21,48,19],[48,24,48,22],[48,29,48,27],[49,6,49,4],[49,10,49,8],[49,11,49,9,"flush"],[49,16,49,14],[49,17,49,15],[49,18,49,16],[50,4,50,2],[52,4,52,2],[53,0,53,0],[54,0,54,0],[55,0,55,0],[56,0,56,0],[57,4,57,3,"incrementSessionStatusCount"],[57,31,57,30,"incrementSessionStatusCount"],[57,32,57,30],[57,34,57,33],[58,6,58,4],[58,10,58,8],[58,11,58,9],[58,15,58,13],[58,16,58,14,"_isEnabled"],[58,26,58,24],[58,28,58,26],[59,8,59,6],[60,6,60,4],[61,6,61,4],[61,12,61,10,"scope"],[61,17,61,15],[61,20,61,18,"hub"],[61,23,61,21],[61,24,61,22,"getCurrentHub"],[61,37,61,35],[61,38,61,36],[61,39,61,37],[61,40,61,38,"getScope"],[61,48,61,46],[61,49,61,47],[61,50,61,48],[62,6,62,4],[62,12,62,10,"requestSession"],[62,26,62,24],[62,29,62,27,"scope"],[62,34,62,32],[62,35,62,33,"getRequestSession"],[62,52,62,50],[62,53,62,51],[62,54,62,52],[63,6,64,4],[63,10,64,8,"requestSession"],[63,24,64,22],[63,28,64,26,"requestSession"],[63,42,64,40],[63,43,64,41,"status"],[63,49,64,47],[63,51,64,49],[64,8,65,6],[64,12,65,10],[64,13,65,11,"_incrementSessionStatusCount"],[64,41,65,39],[64,42,65,40,"requestSession"],[64,56,65,54],[64,57,65,55,"status"],[64,63,65,61],[64,65,65,63],[64,69,65,67,"Date"],[64,73,65,71],[64,74,65,72],[64,75,65,73],[64,76,65,74],[65,8,66,6],[66,8,67,6],[67,8,68,6,"scope"],[67,13,68,11],[67,14,68,12,"setRequestSession"],[67,31,68,29],[67,32,68,30,"undefined"],[67,41,68,39],[67,42,68,40],[68,8,69,6],[69,6,70,4],[70,4,71,2],[72,4,73,2],[73,0,74,0],[74,0,75,0],[75,0,76,0],[76,4,77,3,"_incrementSessionStatusCount"],[76,32,77,31,"_incrementSessionStatusCount"],[76,33,77,32,"status"],[76,39,77,38],[76,41,77,40,"date"],[76,45,77,44],[76,47,77,46],[77,6,78,4],[78,6,79,4],[78,12,79,10,"sessionStartedTrunc"],[78,31,79,29],[78,34,79,32],[78,38,79,36,"Date"],[78,42,79,40],[78,43,79,41,"date"],[78,47,79,45],[78,48,79,46],[78,49,79,47,"setSeconds"],[78,59,79,57],[78,60,79,58],[78,61,79,59],[78,63,79,61],[78,64,79,62],[78,65,79,63],[79,6,80,4],[79,10,80,8],[79,11,80,9,"_pendingAggregates"],[79,29,80,27],[79,30,80,28,"sessionStartedTrunc"],[79,49,80,47],[79,50,80,48],[79,53,80,51],[79,57,80,55],[79,58,80,56,"_pendingAggregates"],[79,76,80,74],[79,77,80,75,"sessionStartedTrunc"],[79,96,80,94],[79,97,80,95],[79,101,80,99],[79,102,80,100],[79,103,80,101],[81,6,82,4],[82,6,83,4],[83,6,84,4],[83,12,84,10,"aggregationCounts"],[83,29,84,27],[83,32,84,30],[83,36,84,34],[83,37,84,35,"_pendingAggregates"],[83,55,84,53],[83,56,84,54,"sessionStartedTrunc"],[83,75,84,73],[83,76,84,74],[84,6,85,4],[84,10,85,8],[84,11,85,9,"aggregationCounts"],[84,28,85,26],[84,29,85,27,"started"],[84,36,85,34],[84,38,85,36],[85,8,86,6,"aggregationCounts"],[85,25,86,23],[85,26,86,24,"started"],[85,33,86,31],[85,36,86,34],[85,40,86,38,"Date"],[85,44,86,42],[85,45,86,43,"sessionStartedTrunc"],[85,64,86,62],[85,65,86,63],[85,66,86,64,"toISOString"],[85,77,86,75],[85,78,86,76],[85,79,86,77],[86,6,87,4],[87,6,89,4],[87,14,89,12,"status"],[87,20,89,18],[88,8,90,6],[88,13,90,11],[88,22,90,20],[89,10,91,8,"aggregationCounts"],[89,27,91,25],[89,28,91,26,"errored"],[89,35,91,33],[89,38,91,36],[89,39,91,37,"aggregationCounts"],[89,56,91,54],[89,57,91,55,"errored"],[89,64,91,62],[89,68,91,66],[89,69,91,67],[89,73,91,71],[89,74,91,72],[90,10,92,8],[90,17,92,15,"aggregationCounts"],[90,34,92,32],[90,35,92,33,"errored"],[90,42,92,40],[91,8,93,6],[91,13,93,11],[91,17,93,15],[92,10,94,8,"aggregationCounts"],[92,27,94,25],[92,28,94,26,"exited"],[92,34,94,32],[92,37,94,35],[92,38,94,36,"aggregationCounts"],[92,55,94,53],[92,56,94,54,"exited"],[92,62,94,60],[92,66,94,64],[92,67,94,65],[92,71,94,69],[92,72,94,70],[93,10,95,8],[93,17,95,15,"aggregationCounts"],[93,34,95,32],[93,35,95,33,"exited"],[93,41,95,39],[94,8,96,6],[95,10,97,8,"aggregationCounts"],[95,27,97,25],[95,28,97,26,"crashed"],[95,35,97,33],[95,38,97,36],[95,39,97,37,"aggregationCounts"],[95,56,97,54],[95,57,97,55,"crashed"],[95,64,97,62],[95,68,97,66],[95,69,97,67],[95,73,97,71],[95,74,97,72],[96,10,98,8],[96,17,98,15,"aggregationCounts"],[96,34,98,32],[96,35,98,33,"crashed"],[96,42,98,40],[97,6,99,4],[98,4,100,2],[99,2,101,0],[100,2,103,0,"exports"],[100,9,103,7],[100,10,103,8,"SessionFlusher"],[100,24,103,22],[100,27,103,25,"SessionFlusher"],[100,41,103,39],[101,0,103,40],[101,3]],"functionMap":{"names":["<global>","SessionFlusher","SessionFlusher#constructor","setInterval$argument_0","SessionFlusher#flush","SessionFlusher#getSessionAggregates","Object.keys.map$argument_0","SessionFlusher#close","SessionFlusher#incrementSessionStatusCount","SessionFlusher#_incrementSessionStatusCount"],"mappings":"AAA;ACQ;GCE;mCCO,kBD;GDE;GGG;GHO;GIG;gECC;KDE;GJO;GMG;GNI;GOO;GPc;GQM;GRuB;CDC"},"hasCjsExports":true},"type":"js/module"}]}