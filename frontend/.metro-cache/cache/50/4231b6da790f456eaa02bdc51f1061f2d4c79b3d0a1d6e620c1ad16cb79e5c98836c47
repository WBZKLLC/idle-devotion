{"dependencies":[{"name":"react-native-web/dist/exports/Alert","data":{"asyncType":null,"isESMImport":false,"locs":[],"key":"PEUC6jrQVoAGZ2qYkvimljMOyJI=","exportNames":["*"],"imports":1}},{"name":"./api","data":{"asyncType":null,"isESMImport":true,"locs":[{"start":{"line":7,"column":0,"index":251},"end":{"line":7,"column":47,"index":298}}],"key":"FbKPDeRJ9TF3vg1eKYKz12urgic=","exportNames":["*"],"imports":1}},{"name":"../stores/networkStore","data":{"asyncType":null,"isESMImport":true,"locs":[{"start":{"line":8,"column":0,"index":299},"end":{"line":8,"column":57,"index":356}}],"key":"ixdoEhjLNW8i2Hfhg3SedQ7tLZs=","exportNames":["*"],"imports":1}}],"output":[{"data":{"code":"__d(function (global, require, _$$_IMPORT_DEFAULT, _$$_IMPORT_ALL, module, exports, _dependencyMap) {\n  \"use strict\";\n\n  Object.defineProperty(exports, '__esModule', {\n    value: true\n  });\n  function _interopDefault(e) {\n    return e && e.__esModule ? e : {\n      default: e\n    };\n  }\n  exports.isOnline = isOnline;\n  exports.safeMutation = safeMutation;\n  exports.isMutationSuccess = isMutationSuccess;\n  exports.createMutationExecutor = createMutationExecutor;\n  exports.preventOptimisticUpdate = preventOptimisticUpdate;\n  var _reactNativeWebDistExportsAlert = require(_dependencyMap[0], \"react-native-web/dist/exports/Alert\");\n  var Alert = _interopDefault(_reactNativeWebDistExportsAlert);\n  var _api = require(_dependencyMap[1], \"./api\");\n  var _storesNetworkStore = require(_dependencyMap[2], \"../stores/networkStore\");\n  // /app/frontend/lib/safeMutation.ts\n  // SAFE MUTATION WRAPPER\n  // Enforces consistent loading/success/failure patterns for all state mutations\n  // Prevents optimistic updates and ensures server-authoritative state\n\n  /**\n   * Check if device is online\n   */\n  function isOnline() {\n    return _storesNetworkStore.useNetworkStore.getState().isOnline;\n  }\n\n  /**\n   * Structured result type for safeMutation\n   * Preserves server error details while providing consistent interface\n   */\n\n  /**\n   * Options for safeMutation\n   */\n\n  /**\n   * Extract error detail from various error formats\n   */\n  function getErrorDetail(error) {\n    return error?.response?.data?.detail || error?.message || 'Something went wrong';\n  }\n\n  /**\n   * Safe mutation wrapper that enforces consistent patterns:\n   * 1. Always awaits the server response\n   * 2. Optionally refreshes user state after success\n   * 3. Returns structured result { ok, data } or { ok, error, detail }\n   * 4. Never assumes success - state only updates after server confirms\n   * 5. Respects global error handling - won't duplicate alerts\n   * \n   * @param actionName - Name of the action for logging\n   * @param fn - The async mutation function to execute\n   * @param opts - Options for customizing behavior\n   * @returns Structured result with ok/data or ok/error/detail\n   * \n   * @example\n   * ```tsx\n   * const result = await safeMutation(\n   *   'pullGacha',\n   *   () => apiPullGacha(username, 'single', 'coins'),\n   *   { \n   *     refreshUser: true, \n   *     fetchUserFn: fetchUser,\n   *     onSuccess: (data) => setHeroes(data.heroes)\n   *   }\n   * );\n   * \n   * if (result.ok) {\n   *   // Use result.data\n   * } else {\n   *   // result.error and result.detail available\n   * }\n   * ```\n   */\n  async function safeMutation(actionName, fn, opts = {}) {\n    const {\n      onSuccess,\n      onError,\n      refreshUser = true,\n      fetchUserFn,\n      showErrorAlert = true,\n      errorMessage\n    } = opts;\n\n    // Fast-fail if offline - don't attempt network calls\n    // Fast-fail if offline - NO alert (offline banner is the UX)\n    if (!isOnline()) {\n      const offlineError = new Error('OFFLINE');\n      const detail = 'No internet connection';\n      if (onError) onError(offlineError);\n\n      // Return silently - OfflineBanner is the global UX for this\n      return {\n        ok: false,\n        error: offlineError,\n        detail\n      };\n    }\n    try {\n      if (__DEV__) console.log(`[safeMutation] Starting: ${actionName}`);\n\n      // Execute the mutation - ALWAYS await server response\n      const data = await fn();\n      if (__DEV__) console.log(`[safeMutation] Success: ${actionName}`);\n\n      // Refresh user state from server (authoritative source)\n      if (refreshUser && fetchUserFn) {\n        try {\n          await fetchUserFn();\n        } catch (refreshError) {\n          console.error(`[safeMutation] Failed to refresh user after ${actionName}:`, refreshError);\n          // Don't fail the mutation if refresh fails - the mutation succeeded\n        }\n      }\n\n      // Call success callback\n      if (onSuccess) {\n        await onSuccess(data);\n      }\n      return {\n        ok: true,\n        data\n      };\n    } catch (error) {\n      const detail = getErrorDetail(error);\n      console.error(`[safeMutation] Failed: ${actionName}`, error);\n\n      // Call error callback\n      if (onError) {\n        onError(error);\n      }\n\n      // Only show alert if:\n      // 1. showErrorAlert is true\n      // 2. Error was NOT already handled by global interceptor\n      if (showErrorAlert && !(0, _api.isErrorHandledGlobally)(error)) {\n        Alert.default.alert('Error', errorMessage || detail);\n      }\n      return {\n        ok: false,\n        error,\n        detail\n      };\n    }\n  }\n\n  /**\n   * Helper to check if a mutation result succeeded\n   * Useful for TypeScript narrowing\n   */\n  function isMutationSuccess(result) {\n    return result.ok === true;\n  }\n\n  /**\n   * Hook-friendly version that creates a bound executor\n   * \n   * @example\n   * ```tsx\n   * const execute = createMutationExecutor(fetchUser);\n   * const result = await execute('pullGacha', () => pullGacha('single', 'coins'));\n   * ```\n   */\n  function createMutationExecutor(fetchUserFn) {\n    return async function executeMutation(actionName, fn, opts = {}) {\n      return safeMutation(actionName, fn, {\n        ...opts,\n        fetchUserFn\n      });\n    };\n  }\n\n  /**\n   * NO-OP optimistic update prevention\n   * Use this to wrap any attempted optimistic updates during refactoring\n   * \n   * @deprecated Remove once all optimistic updates are eliminated\n   */\n  function preventOptimisticUpdate(actionName, _setter) {\n    console.warn(`[BLOCKED] Optimistic update attempted for \"${actionName}\". ` + `State should only update after server confirms. Use safeMutation instead.`);\n    // Do NOT call the setter - this is intentional\n  }\n});","lineCount":189,"map":[[12,2,13,0,"exports"],[12,9,13,0],[12,10,13,0,"isOnline"],[12,18,13,0],[12,21,13,0,"isOnline"],[12,29,13,0],[13,2,95,0,"exports"],[13,9,95,0],[13,10,95,0,"safeMutation"],[13,22,95,0],[13,25,95,0,"safeMutation"],[13,37,95,0],[14,2,170,0,"exports"],[14,9,170,0],[14,10,170,0,"isMutationSuccess"],[14,27,170,0],[14,30,170,0,"isMutationSuccess"],[14,47,170,0],[15,2,183,0,"exports"],[15,9,183,0],[15,10,183,0,"createMutationExecutor"],[15,32,183,0],[15,35,183,0,"createMutationExecutor"],[15,57,183,0],[16,2,202,0,"exports"],[16,9,202,0],[16,10,202,0,"preventOptimisticUpdate"],[16,33,202,0],[16,36,202,0,"preventOptimisticUpdate"],[16,59,202,0],[17,2,211,1],[17,6,211,1,"_reactNativeWebDistExportsAlert"],[17,37,211,1],[17,40,211,1,"require"],[17,47,211,1],[17,48,211,1,"_dependencyMap"],[17,62,211,1],[18,2,211,1],[18,6,211,1,"Alert"],[18,11,211,1],[18,14,211,1,"_interopDefault"],[18,29,211,1],[18,30,211,1,"_reactNativeWebDistExportsAlert"],[18,61,211,1],[19,2,7,0],[19,6,7,0,"_api"],[19,10,7,0],[19,13,7,0,"require"],[19,20,7,0],[19,21,7,0,"_dependencyMap"],[19,35,7,0],[20,2,8,0],[20,6,8,0,"_storesNetworkStore"],[20,25,8,0],[20,28,8,0,"require"],[20,35,8,0],[20,36,8,0,"_dependencyMap"],[20,50,8,0],[21,2,1,0],[22,2,2,0],[23,2,3,0],[24,2,4,0],[26,2,10,0],[27,0,11,0],[28,0,12,0],[29,2,13,7],[29,11,13,16,"isOnline"],[29,19,13,24,"isOnline"],[29,20,13,24],[29,22,13,36],[30,4,14,2],[30,11,14,9,"useNetworkStore"],[30,30,14,24],[30,31,14,24,"useNetworkStore"],[30,46,14,24],[30,47,14,25,"getState"],[30,55,14,33],[30,56,14,34],[30,57,14,35],[30,58,14,36,"isOnline"],[30,66,14,44],[31,2,15,0],[33,2,17,0],[34,0,18,0],[35,0,19,0],[36,0,20,0],[38,2,25,0],[39,0,26,0],[40,0,27,0],[42,2,54,0],[43,0,55,0],[44,0,56,0],[45,2,57,0],[45,11,57,9,"getErrorDetail"],[45,25,57,23,"getErrorDetail"],[45,26,57,24,"error"],[45,31,57,34],[45,33,57,44],[46,4,58,2],[46,11,58,9,"error"],[46,16,58,14],[46,18,58,16,"response"],[46,26,58,24],[46,28,58,26,"data"],[46,32,58,30],[46,34,58,32,"detail"],[46,40,58,38],[46,44,59,7,"error"],[46,49,59,12],[46,51,59,14,"message"],[46,58,59,21],[46,62,60,7],[46,84,60,29],[47,2,61,0],[49,2,63,0],[50,0,64,0],[51,0,65,0],[52,0,66,0],[53,0,67,0],[54,0,68,0],[55,0,69,0],[56,0,70,0],[57,0,71,0],[58,0,72,0],[59,0,73,0],[60,0,74,0],[61,0,75,0],[62,0,76,0],[63,0,77,0],[64,0,78,0],[65,0,79,0],[66,0,80,0],[67,0,81,0],[68,0,82,0],[69,0,83,0],[70,0,84,0],[71,0,85,0],[72,0,86,0],[73,0,87,0],[74,0,88,0],[75,0,89,0],[76,0,90,0],[77,0,91,0],[78,0,92,0],[79,0,93,0],[80,0,94,0],[81,2,95,7],[81,17,95,22,"safeMutation"],[81,29,95,34,"safeMutation"],[81,30,96,2,"actionName"],[81,40,96,20],[81,42,97,2,"fn"],[81,44,97,22],[81,46,98,2,"opts"],[81,50,98,30],[81,53,98,33],[81,54,98,34],[81,55,98,35],[81,57,99,30],[82,4,100,2],[82,10,100,8],[83,6,101,4,"onSuccess"],[83,15,101,13],[84,6,102,4,"onError"],[84,13,102,11],[85,6,103,4,"refreshUser"],[85,17,103,15],[85,20,103,18],[85,24,103,22],[86,6,104,4,"fetchUserFn"],[86,17,104,15],[87,6,105,4,"showErrorAlert"],[87,20,105,18],[87,23,105,21],[87,27,105,25],[88,6,106,4,"errorMessage"],[89,4,107,2],[89,5,107,3],[89,8,107,6,"opts"],[89,12,107,10],[91,4,109,2],[92,4,110,2],[93,4,111,2],[93,8,111,6],[93,9,111,7,"isOnline"],[93,17,111,15],[93,18,111,16],[93,19,111,17],[93,21,111,19],[94,6,112,4],[94,12,112,10,"offlineError"],[94,24,112,22],[94,27,112,25],[94,31,112,29,"Error"],[94,36,112,34],[94,37,112,35],[94,46,112,44],[94,47,112,45],[95,6,113,4],[95,12,113,10,"detail"],[95,18,113,16],[95,21,113,19],[95,45,113,43],[96,6,115,4],[96,10,115,8,"onError"],[96,17,115,15],[96,19,115,17,"onError"],[96,26,115,24],[96,27,115,25,"offlineError"],[96,39,115,37],[96,40,115,38],[98,6,117,4],[99,6,118,4],[99,13,118,11],[100,8,118,13,"ok"],[100,10,118,15],[100,12,118,17],[100,17,118,22],[101,8,118,24,"error"],[101,13,118,29],[101,15,118,31,"offlineError"],[101,27,118,43],[102,8,118,45,"detail"],[103,6,118,52],[103,7,118,53],[104,4,119,2],[105,4,121,2],[105,8,121,6],[106,6,122,4],[106,10,122,8,"__DEV__"],[106,17,122,15],[106,19,122,17,"console"],[106,26,122,24],[106,27,122,25,"log"],[106,30,122,28],[106,31,122,29],[106,59,122,57,"actionName"],[106,69,122,67],[106,71,122,69],[106,72,122,70],[108,6,124,4],[109,6,125,4],[109,12,125,10,"data"],[109,16,125,14],[109,19,125,17],[109,25,125,23,"fn"],[109,27,125,25],[109,28,125,26],[109,29,125,27],[110,6,127,4],[110,10,127,8,"__DEV__"],[110,17,127,15],[110,19,127,17,"console"],[110,26,127,24],[110,27,127,25,"log"],[110,30,127,28],[110,31,127,29],[110,58,127,56,"actionName"],[110,68,127,66],[110,70,127,68],[110,71,127,69],[112,6,129,4],[113,6,130,4],[113,10,130,8,"refreshUser"],[113,21,130,19],[113,25,130,23,"fetchUserFn"],[113,36,130,34],[113,38,130,36],[114,8,131,6],[114,12,131,10],[115,10,132,8],[115,16,132,14,"fetchUserFn"],[115,27,132,25],[115,28,132,26],[115,29,132,27],[116,8,133,6],[116,9,133,7],[116,10,133,8],[116,17,133,15,"refreshError"],[116,29,133,27],[116,31,133,29],[117,10,134,8,"console"],[117,17,134,15],[117,18,134,16,"error"],[117,23,134,21],[117,24,134,22],[117,71,134,69,"actionName"],[117,81,134,79],[117,84,134,82],[117,86,134,84,"refreshError"],[117,98,134,96],[117,99,134,97],[118,10,135,8],[119,8,136,6],[120,6,137,4],[122,6,139,4],[123,6,140,4],[123,10,140,8,"onSuccess"],[123,19,140,17],[123,21,140,19],[124,8,141,6],[124,14,141,12,"onSuccess"],[124,23,141,21],[124,24,141,22,"data"],[124,28,141,26],[124,29,141,27],[125,6,142,4],[126,6,144,4],[126,13,144,11],[127,8,144,13,"ok"],[127,10,144,15],[127,12,144,17],[127,16,144,21],[128,8,144,23,"data"],[129,6,144,28],[129,7,144,29],[130,4,146,2],[130,5,146,3],[130,6,146,4],[130,13,146,11,"error"],[130,18,146,21],[130,20,146,23],[131,6,147,4],[131,12,147,10,"detail"],[131,18,147,16],[131,21,147,19,"getErrorDetail"],[131,35,147,33],[131,36,147,34,"error"],[131,41,147,39],[131,42,147,40],[132,6,148,4,"console"],[132,13,148,11],[132,14,148,12,"error"],[132,19,148,17],[132,20,148,18],[132,46,148,44,"actionName"],[132,56,148,54],[132,58,148,56],[132,60,148,58,"error"],[132,65,148,63],[132,66,148,64],[134,6,150,4],[135,6,151,4],[135,10,151,8,"onError"],[135,17,151,15],[135,19,151,17],[136,8,152,6,"onError"],[136,15,152,13],[136,16,152,14,"error"],[136,21,152,19],[136,22,152,20],[137,6,153,4],[139,6,155,4],[140,6,156,4],[141,6,157,4],[142,6,158,4],[142,10,158,8,"showErrorAlert"],[142,24,158,22],[142,28,158,26],[142,29,158,27],[142,33,158,27,"isErrorHandledGlobally"],[142,37,158,49],[142,38,158,49,"isErrorHandledGlobally"],[142,60,158,49],[142,62,158,50,"error"],[142,67,158,55],[142,68,158,56],[142,70,158,58],[143,8,159,6,"Alert"],[143,13,159,11],[143,14,159,11,"default"],[143,21,159,11],[143,22,159,12,"alert"],[143,27,159,17],[143,28,159,18],[143,35,159,25],[143,37,159,27,"errorMessage"],[143,49,159,39],[143,53,159,43,"detail"],[143,59,159,49],[143,60,159,50],[144,6,160,4],[145,6,162,4],[145,13,162,11],[146,8,162,13,"ok"],[146,10,162,15],[146,12,162,17],[146,17,162,22],[147,8,162,24,"error"],[147,13,162,29],[148,8,162,31,"detail"],[149,6,162,38],[149,7,162,39],[150,4,163,2],[151,2,164,0],[153,2,166,0],[154,0,167,0],[155,0,168,0],[156,0,169,0],[157,2,170,7],[157,11,170,16,"isMutationSuccess"],[157,28,170,33,"isMutationSuccess"],[157,29,170,37,"result"],[157,35,170,62],[157,37,170,97],[158,4,171,2],[158,11,171,9,"result"],[158,17,171,15],[158,18,171,16,"ok"],[158,20,171,18],[158,25,171,23],[158,29,171,27],[159,2,172,0],[161,2,174,0],[162,0,175,0],[163,0,176,0],[164,0,177,0],[165,0,178,0],[166,0,179,0],[167,0,180,0],[168,0,181,0],[169,0,182,0],[170,2,183,7],[170,11,183,16,"createMutationExecutor"],[170,33,183,38,"createMutationExecutor"],[170,34,183,39,"fetchUserFn"],[170,45,183,72],[170,47,183,74],[171,4,184,2],[171,11,184,9],[171,26,184,24,"executeMutation"],[171,41,184,39,"executeMutation"],[171,42,185,4,"actionName"],[171,52,185,22],[171,54,186,4,"fn"],[171,56,186,24],[171,58,187,4,"opts"],[171,62,187,53],[171,65,187,56],[171,66,187,57],[171,67,187,58],[171,69,188,32],[172,6,189,4],[172,13,189,11,"safeMutation"],[172,25,189,23],[172,26,189,24,"actionName"],[172,36,189,34],[172,38,189,36,"fn"],[172,40,189,38],[172,42,189,40],[173,8,190,6],[173,11,190,9,"opts"],[173,15,190,13],[174,8,191,6,"fetchUserFn"],[175,6,192,4],[175,7,192,5],[175,8,192,6],[176,4,193,2],[176,5,193,3],[177,2,194,0],[179,2,196,0],[180,0,197,0],[181,0,198,0],[182,0,199,0],[183,0,200,0],[184,0,201,0],[185,2,202,7],[185,11,202,16,"preventOptimisticUpdate"],[185,34,202,39,"preventOptimisticUpdate"],[185,35,203,2,"actionName"],[185,45,203,20],[185,47,204,2,"_setter"],[185,54,204,21],[185,56,205,8],[186,4,206,2,"console"],[186,11,206,9],[186,12,206,10,"warn"],[186,16,206,14],[186,17,207,4],[186,63,207,50,"actionName"],[186,73,207,60],[186,78,207,65],[186,81,208,4],[186,156,209,2],[186,157,209,3],[187,4,210,2],[188,2,211,0],[189,0,211,1],[189,3]],"functionMap":{"names":["<global>","isOnline","getErrorDetail","safeMutation","isMutationSuccess","createMutationExecutor","executeMutation","preventOptimisticUpdate"],"mappings":"AAA;OCY;CDE;AE0C;CFI;OGkC;CHqE;OIM;CJE;OKW;SCC;GDS;CLC;OOQ;CPS"},"hasCjsExports":false},"type":"js/module"}]}