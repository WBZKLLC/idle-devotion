<analysis>
<original_problem_statement>
The user is directing a multi-phase UX and code quality overhaul for a mobile game app. The project has progressed through major architectural refactoring (routing, componentization) and a deep emotional design overhaul of the home screen, transforming it from a dashboard into a sanctuary.

The current and final phase of this overhaul is **Phase 3.23: Social + Mail Systems**. The goal is to implement fully functional Mail and Friends screens that are consistent with the new Sanctuary Home philosophy, which prioritizes a calm, immersive scene over a cluttered UI.

**PRODUCT REQUIREMENTS (Phase 3.23):**
1.  **Routes & Auth (3.23.1):** Create and consistently auth-gate new stack screens at  and .
2.  **Data Layer (3.23.2):** Create server-first API wrappers for mail and friends data (, , etc.). Replace hardcoded rail badges with real data-driven badge logic from these new APIs.
3.  **Mail Screen MVP (3.23.3):** Build the  screen with three tabs (Rewards, Messages, Gifts), using canonical  components and maintaining the app's quietly indulgent tone.
4.  **Friends Screen MVP (3.23.4):** Build the  screen with three tabs (Requests, Friends, Search), including functionality for accepting/declining requests and a debounced player search.
5.  **Interaction Safety (3.23.5):** Ensure no regressions in the Desire Engine (e.g., timers are cleaned up on navigation away from Home).
</original_problem_statement>

**User's preferred language**: English

**what currently exists?**
The application's home screen has been completely re-architected into a Sanctuary layout. The old  stack of components has been replaced by a single scene with a full-bleed background and absolutely positioned UI overlays.

Key new components forming this layout are:
-   : A compact, persistent card at the bottom of the screen for the primary idle-rewards interaction.
-   : An icons-only, scrollable rail on the right for the 7 most frequent actions (Doors, Mail, Friends, Quest, etc.).
-   : A modal sheet that contains the old grid of secondary navigation links, accessible from the side rail.

The agent has just begun **Phase 3.23**, creating the foundational files for the Mail and Friends systems, including:
-   MVP screen files:  and .
-   API wrapper stubs:  and .
-   A data-driven badge logic file: .

**Last working item**:
-   Last item agent was working: The agent was actively implementing **Phase 3.23.1 & 3.23.2**. It had scaffolded the new files and was in the process of fixing several TypeScript import errors () in the newly created  and  screens. The very last action was fixing an incorrect import path for the  utility.
-   Status: IN PROGRESS
-   Agent Testing Done: N
-   Which testing method agent to use? The agent should first run lib/api/mail.ts(7,36): error TS2307: Cannot find module '../../components/environment/EnvironmentDetector' or its corresponding type declarations. to confirm all TypeScript errors from the recent scaffolding are resolved. Afterwards, it should run 
> frontend@1.0.0 guard
> npm run guard:hero && npm run guard:tier && npm run guard:select-hero && npm run guard:user-heroes-map && npm run guard:feature-flags && npm run guard:hero-signature && npm run guard:no-free-cinematics && npm run guard:no-inline-power && npm run guard:no-paid-wording && npm run guard:entitlements-access && npm run guard:purchase-flow && npm run guard:auth-epoch && npm run guard:refresh-discipline && npm run guard:env-detection && npm run guard:no-error-alerts


> frontend@1.0.0 guard:hero
> node scripts/guard-no-hero-list-fallback.mjs

[guard:no-hero-list-fallback] âœ… Flag is true and there is no runtime path to list fetch (fallback may exist but is unreachable).

> frontend@1.0.0 guard:tier
> node scripts/guard-no-direct-tier-imports.mjs

[guard:no-direct-tier-imports] âœ… No direct tier imports found in UI.

> frontend@1.0.0 guard:select-hero
> node scripts/guard-select-user-hero-by-id.mjs

[guard:selectUserHeroById] âœ… O(1) selector enforced.

> frontend@1.0.0 guard:user-heroes-map
> node scripts/guard-user-heroes-map-sync.mjs

[guard:user-heroes-map] âœ… userHeroes/userHeroesById sync enforced.

> frontend@1.0.0 guard:feature-flags
> node scripts/guard-feature-flags.mjs

[guard:feature-flags] Checking feature flag architecture...
[guard:feature-flags] âœ… Feature flag architecture enforced (read-only UI).

> frontend@1.0.0 guard:hero-signature
> node scripts/guard-get-user-hero-signature.mjs

[guard:get-user-hero-signature] Checking getUserHeroById call signatures...
[guard:get-user-hero-signature] âœ… All getUserHeroById calls use correct signature.

> frontend@1.0.0 guard:no-free-cinematics
> node scripts/guard-no-free-cinematics.mjs

âœ… guard-no-free-cinematics: No free cinematic preview UI in app/ screens.

> frontend@1.0.0 guard:no-inline-power
> node scripts/guard-no-inline-power.mjs

âœ… guard-no-inline-power: No inline power formulas in app/ screens.

> frontend@1.0.0 guard:no-paid-wording
> node scripts/guard-no-paid-wording.mjs

âœ… guard-no-paid-wording: No forbidden paid wording found.

> frontend@1.0.0 guard:entitlements-access
> node scripts/guard-entitlements-access.mjs

ðŸ”’ Checking entitlement store access patterns...

âœ… No direct entitlement store access found.
   All screens use gating helpers correctly.


> frontend@1.0.0 guard:purchase-flow
> node scripts/guard-purchase-flow.mjs

ðŸ”’ Checking purchase flow patterns...

âœ… No purchase flow violations found.
   All screens use PurchaseButton and canonical products.


> frontend@1.0.0 guard:auth-epoch
> node scripts/guard-auth-epoch.mjs

ðŸ”’ Checking authEpoch guards in stores...

âœ… All async store actions have proper authEpoch guards.
   No race conditions from stale in-flight requests possible.


> frontend@1.0.0 guard:refresh-discipline
> node scripts/guard-entitlements-refresh-discipline.mjs

ðŸ”„ Checking entitlements refresh discipline (Phase 3.14)...

âœ… Entitlements refresh discipline is maintained.
   All refresh calls go through canonical entry points.


> frontend@1.0.0 guard:env-detection
> node scripts/guard-env-detection.mjs

ðŸŒ Checking centralized environment detection (Phase 3.17)...

âœ… Environment detection is centralized.
   All code uses getEnvironmentMode() / isProductionEnvironment() helpers.


> frontend@1.0.0 guard:no-error-alerts
> node scripts/guard-no-error-alerts.mjs

ðŸš« Checking Alert.alert patterns (Phase 3.18.4 STRICT)...

   Valid annotations: destructive_confirm, logout_confirm, purchase_confirm, rewards_modal, legacy_account_flow, dev_mode

âœ… All Alert.alert usages are properly annotated.
   No forbidden error alert patterns found..
-   User Testing Done: N

**All Pending/In progress Issue list**:
-   Issue 1: (P0) TypeScript compilation errors in newly created files.
    -   Issues Detail:
        -   **Issue 1**: The files  and  had several  errors due to incorrect import paths after being scaffolded.
        -   **Attempted fixes**: The agent fixed one import for .
        -   **Next debug checklist**:
            1.  Run lib/api/mail.ts(7,36): error TS2307: Cannot find module '../../components/environment/EnvironmentDetector' or its corresponding type declarations. to get a full list of remaining TS errors.
            2.  Systematically fix each import path error in , , and . Common issues are incorrect relative paths or missing barrel file exports.
        -   **Why fix this issue and what will be achieved with the fix?**: The app will not compile or run until these errors are fixed. Resolving them is the necessary first step to continue building the Mail and Friends features.
        -   **Status**: IN PROGRESS
        -   **Is recurring issue?**: N
        -   **Should Test frontend/backend/both after fix?**: frontend

**In progress Task List**:
-   Task 1: (P0) Finalize Phase 3.23.1/3.23.2: Auth Gates & Data Layer.
    -   **Where to resume**: After fixing all TypeScript errors, the agent needs to ensure the  hook in  and its integration in  are correct and functional.
    -   **What will be achieved with this?**: The side rail badges will be driven by (stubbed) API calls instead of being hardcoded, and the new screens will have proper authentication gates.
    -   **Status**: IN PROGRESS
    -   **Should Test frontend/backend/both after fix?**: frontend
    -   **Blocked on something**: Pending resolution of Issue 1.

**Upcoming and Future Tasks**
-   **Upcoming Tasks:**
    -   P0: **Phase 3.23.3 â€” Mail Screen MVP**: Build the full UI for the  screen, including tabs for Rewards, Messages, and Gifts, using the canonical  component.
    -   P1: **Phase 3.23.4 â€” Friends Screen MVP**: Build the full UI for the  screen, including tabs for Requests, Friends, and Search. Implement API wiring for accept/decline and a debounced search input.
    -   P2: **Phase 3.23.5 â€” Interaction + Desire Engine Safety**: Verify that navigating to the new screens correctly cancels any pending Desire Engine timers on the Home screen.
-   **Future Tasks:**
    -   **Fix Cinematic Videos**: A long-deferred task to fix an incompatible video codec by running the script at .

**Completed work in this session**
-   **Desire Engine Surgical Fix**: Made the Signature Moment subtitle-revert timeout cancellable using  and  to prevent UX snapping.
-   **Interaction Coverage Patch**: Implemented a small event bus () to ensure any major user interaction (tab presses, button clicks) would correctly cancel pending Desire Engine accents, making the UI feel more responsive.
-   **Phase 3.22.10 (Sensory Mastering)**: Implemented audio cues for interactions, polished the home screen's parallax effect, and added a seasonal color temperature system.
-   **Phase 3.22.11 (Home Elegance Pass)**: Refined the visual treatment of home screen components (quick links, header, tab bar) to feel more like cards and chapters, moving away from a simple grid.
-   **Phase 3.22.7 & 3.22.12 (Sanctuary Home Re-layout)**: Executed a major architectural refactor of the home screen, replacing the  with a scene layout. Created and integrated , , and  components to achieve a sanctuary feel.
-   **Phase 3.22.12.R1 (Right Rail Decoupling)**: Re-implemented the  with a clean, decoupled callback pattern and updated its visual design to be an icons-only, scrollable rail.
-   **Phase 3.22.12.R2 (Mail + Friends Scaffolding)**: Created the initial MVP files (, ) and the badge data logic () and wired them into the Home screen side rail.

**Earlier issues found/mentioned but not fixed**
-   **Issue 1**: Incompatible video codec for hero cinematics. This feature is currently broken.
    -   **Debug checklist**: Run the script at  and test playback on a device.
    -   **Why to solve this issue and what will be achieved with this?**: To restore a broken premium feature.
    -   **Should Test frontend/backend/both after fix?**: frontend
    -   **Is recurring issue?**: Y

**Known issue recurrence from previous fork**
-   None.

**Code Architecture**


**Key Technical Concepts**
-   **Sanctuary Layout**: An architectural pattern for the home screen that uses  to layer UI elements (HUD, side rail, dock) over a full-bleed background scene, replacing a traditional  stack.
-   **Decoupled Component Callbacks**: Designing components like  to emit intents via props (, ) rather than handling navigation internally, making them more reusable and placing control in the parent screen.
-   **Data-Driven UI State**: Using hooks () to fetch data from an API layer and drive UI elements like notification badges, centralizing logic and removing hardcoded values.
-   **Minimal Event Bus**: A simple, dependency-free event bus () to broadcast global UI events (like tab presses) to interested subscribers (like the Home screen) for coordinated state updates (e.g., cancelling timers).
-   **Emotional Design System**: A complex system controlling the app's tone through microcopy, animation, spacing, and rare, stateful micro-interactions (Desire Engine).
-   **File-based Routing & Auth Gating**: Using  for all navigation, with new screens for  and  being created. A root  handles the authentication gate for protected routes.

**key DB schema**
- No changes to the DB schema. Backend endpoints for Mail/Friends are assumed but not yet built.

**changes in tech stack**
- No new packages added. The work has focused on architectural patterns using existing libraries (, , ).

**All files of reference**
-   : **The file currently being edited/debugged.**
-   : Recently created, also part of the current task.
-   : The new logic for data-driven badges, central to the current task.
-   : The main Sanctuary screen that orchestrates all the new components and data hooks.
-   , : New API stub files that need to be correctly implemented.

**Areas that need refactoring**:
- The current work IS the implementation of new features, not refactoring.

**key api endpoints**
- The agent is currently creating client-side wrappers for these new (stubbed) endpoints:
  - , , , 
  - , , , 

**Critical Info for New Agent**
-   You are in the middle of a large, multi-phase feature build: **Phase 3.23 (Social + Mail Systems)**.
-   Your **immediate task (P0)** is to resolve all TypeScript compilation errors in the newly scaffolded files, particularly , , and . The last agent was fixing import paths. Start by running lib/api/mail.ts(7,36): error TS2307: Cannot find module '../../components/environment/EnvironmentDetector' or its corresponding type declarations..
-   Once the code compiles, you must proceed with the user's detailed plan for Phase 3.23 in the exact order specified: finish the data layer, then build the Mail screen UI, then the Friends screen UI.
-   Do not deviate from the Sanctuary Home philosophy. New screens are stack screens, not tabs, and should feel like entering a room from the main home scene.
-   All new UI must use the existing design system (, , etc.).

**documents created in this job**
- None.

**Last 10 User Messages and any pending HUMAN messages**
1.  **User (LATEST)**: Provided a detailed, multi-phase plan (3.23.1 to 3.23.5) for building out the Mail and Friends systems, from auth-gating and data-layer stubs to the full MVP UI for each screen.
2.  **Agent**: Summarized the completion of the  and  scaffolding (Phase 3.22.12.R2).
3.  **Agent**: Confirmed the  route is correctly auth-gated.
4.  **Agent**: Navigated to the  screen to test it.
5.  **Agent**: Showed a screenshot of the home screen with the new, data-driven badges working, completing Phase 3.22.12.R2.
6.  **User**: Asked the agent what screens it has for Mail/Friends to avoid creating duplicates, and laid out the plan for Phase 3.22.12.R2 (MVP screens + real badge wiring).
7.  **Agent**: Summarized the completion of the decoupled right rail implementation (Phase 3.22.12.R1).
8.  **User**: Provided a detailed code-first implementation plan for the final, decoupled  component, including the exact code, token values, and wiring instructions.
9.  **Agent**: Summarized the right rail update with 7 items.
10. **User**: Confirmed the final composition of the right rail (7 items including Mail and Friends, icons-only, scrollable).

**Project Health Check:**
-   **Broken**: Web video playback for cinematics (long-standing issue).
-   **Mocked**: RevenueCat (IAP), and the new Mail/Friends backend APIs are currently being stubbed on the client.
-   **In Refactoring**: The Mail and Friends features are in active, initial development.

**3rd Party Integrations**
-   **RevenueCat**: For IAP, functionally mocked.
-   **Sentry**: For crash reporting.
-   **OpenAI GPT-4**: For backend AI narration (uses Emergent LLM Key).
-   **Zustand**: For frontend state management.
-   **Expo**: Core framework, including  and .
-   **React Native Reanimated**: For animations.

**Testing status**
-   Testing agent used after significant changes: NO
-   Troubleshoot agent used after agent stuck in loop: NO
-   Test files created: None.
-   Known regressions: None.

**Credentials to test flow:**
-   **Super Admin**:
    -   Username: 
    -   Password: 

**What agent forgot to execute**
-   The agent has not forgotten anything. It is in the middle of a complex task and was actively debugging compilation errors when the session ended. The next logical step is to re-run the TypeScript checker.

</analysis>
