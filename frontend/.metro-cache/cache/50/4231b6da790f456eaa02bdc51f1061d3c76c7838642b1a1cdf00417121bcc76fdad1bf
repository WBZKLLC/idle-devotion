{"dependencies":[{"name":"react-native-web/dist/exports/Alert","data":{"asyncType":null,"isESMImport":false,"locs":[],"key":"PEUC6jrQVoAGZ2qYkvimljMOyJI=","exportNames":["*"],"imports":1}},{"name":"./api","data":{"asyncType":null,"isESMImport":true,"locs":[{"start":{"line":7,"column":0,"index":251},"end":{"line":7,"column":47,"index":298}}],"key":"FbKPDeRJ9TF3vg1eKYKz12urgic=","exportNames":["*"],"imports":1}}],"output":[{"data":{"code":"__d(function (global, require, _$$_IMPORT_DEFAULT, _$$_IMPORT_ALL, module, exports, _dependencyMap) {\n  \"use strict\";\n\n  Object.defineProperty(exports, '__esModule', {\n    value: true\n  });\n  function _interopDefault(e) {\n    return e && e.__esModule ? e : {\n      default: e\n    };\n  }\n  exports.safeMutation = safeMutation;\n  exports.isMutationSuccess = isMutationSuccess;\n  exports.createMutationExecutor = createMutationExecutor;\n  exports.preventOptimisticUpdate = preventOptimisticUpdate;\n  var _reactNativeWebDistExportsAlert = require(_dependencyMap[0], \"react-native-web/dist/exports/Alert\");\n  var Alert = _interopDefault(_reactNativeWebDistExportsAlert);\n  var _api = require(_dependencyMap[1], \"./api\");\n  // /app/frontend/lib/safeMutation.ts\n  // SAFE MUTATION WRAPPER\n  // Enforces consistent loading/success/failure patterns for all state mutations\n  // Prevents optimistic updates and ensures server-authoritative state\n\n  /**\n   * Structured result type for safeMutation\n   * Preserves server error details while providing consistent interface\n   */\n\n  /**\n   * Options for safeMutation\n   */\n\n  /**\n   * Extract error detail from various error formats\n   */\n  function getErrorDetail(error) {\n    return error?.response?.data?.detail || error?.message || 'Something went wrong';\n  }\n\n  /**\n   * Safe mutation wrapper that enforces consistent patterns:\n   * 1. Always awaits the server response\n   * 2. Optionally refreshes user state after success\n   * 3. Returns structured result { ok, data } or { ok, error, detail }\n   * 4. Never assumes success - state only updates after server confirms\n   * 5. Respects global error handling - won't duplicate alerts\n   * \n   * @param actionName - Name of the action for logging\n   * @param fn - The async mutation function to execute\n   * @param opts - Options for customizing behavior\n   * @returns Structured result with ok/data or ok/error/detail\n   * \n   * @example\n   * ```tsx\n   * const result = await safeMutation(\n   *   'pullGacha',\n   *   () => apiPullGacha(username, 'single', 'coins'),\n   *   { \n   *     refreshUser: true, \n   *     fetchUserFn: fetchUser,\n   *     onSuccess: (data) => setHeroes(data.heroes)\n   *   }\n   * );\n   * \n   * if (result.ok) {\n   *   // Use result.data\n   * } else {\n   *   // result.error and result.detail available\n   * }\n   * ```\n   */\n  async function safeMutation(actionName, fn, opts = {}) {\n    const {\n      onSuccess,\n      onError,\n      refreshUser = true,\n      fetchUserFn,\n      showErrorAlert = false,\n      errorMessage,\n      rethrow = false\n    } = opts;\n    try {\n      console.log(`[safeMutation] Starting: ${actionName}`);\n\n      // Execute the mutation - ALWAYS await server response\n      const data = await fn();\n      console.log(`[safeMutation] Success: ${actionName}`);\n\n      // Refresh user state from server (authoritative source)\n      if (refreshUser && fetchUserFn) {\n        try {\n          await fetchUserFn();\n        } catch (refreshError) {\n          console.error(`[safeMutation] Failed to refresh user after ${actionName}:`, refreshError);\n          // Don't fail the mutation if refresh fails - the mutation succeeded\n        }\n      }\n\n      // Call success callback\n      if (onSuccess) {\n        await onSuccess(data);\n      }\n      return {\n        ok: true,\n        data\n      };\n    } catch (error) {\n      const detail = getErrorDetail(error);\n      console.error(`[safeMutation] Failed: ${actionName}`, error);\n\n      // Call error callback\n      if (onError) {\n        onError(error);\n      }\n\n      // Only show alert if:\n      // 1. showErrorAlert is true\n      // 2. Error was NOT already handled by global interceptor\n      if (showErrorAlert && !(0, _api.isErrorHandledGlobally)(error)) {\n        Alert.default.alert('Error', errorMessage || detail);\n      }\n\n      // Optionally rethrow for callers that need to handle further\n      if (rethrow) {\n        throw error;\n      }\n      return {\n        ok: false,\n        error,\n        detail\n      };\n    }\n  }\n\n  /**\n   * Helper to check if a mutation result succeeded\n   * Useful for TypeScript narrowing\n   */\n  function isMutationSuccess(result) {\n    return result.ok === true;\n  }\n\n  /**\n   * Hook-friendly version that creates a bound executor\n   * \n   * @example\n   * ```tsx\n   * const execute = createMutationExecutor(fetchUser);\n   * const result = await execute('pullGacha', () => pullGacha('single', 'coins'));\n   * ```\n   */\n  function createMutationExecutor(fetchUserFn) {\n    return async function executeMutation(actionName, fn, opts = {}) {\n      return safeMutation(actionName, fn, {\n        ...opts,\n        fetchUserFn\n      });\n    };\n  }\n\n  /**\n   * NO-OP optimistic update prevention\n   * Use this to wrap any attempted optimistic updates during refactoring\n   * \n   * @deprecated Remove once all optimistic updates are eliminated\n   */\n  function preventOptimisticUpdate(actionName, _setter) {\n    console.warn(`[BLOCKED] Optimistic update attempted for \"${actionName}\". ` + `State should only update after server confirms. Use safeMutation instead.`);\n    // Do NOT call the setter - this is intentional\n  }\n});","lineCount":171,"map":[[12,2,93,0,"exports"],[12,9,93,0],[12,10,93,0,"safeMutation"],[12,22,93,0],[12,25,93,0,"safeMutation"],[12,37,93,0],[13,2,162,0,"exports"],[13,9,162,0],[13,10,162,0,"isMutationSuccess"],[13,27,162,0],[13,30,162,0,"isMutationSuccess"],[13,47,162,0],[14,2,175,0,"exports"],[14,9,175,0],[14,10,175,0,"createMutationExecutor"],[14,32,175,0],[14,35,175,0,"createMutationExecutor"],[14,57,175,0],[15,2,194,0,"exports"],[15,9,194,0],[15,10,194,0,"preventOptimisticUpdate"],[15,33,194,0],[15,36,194,0,"preventOptimisticUpdate"],[15,59,194,0],[16,2,203,1],[16,6,203,1,"_reactNativeWebDistExportsAlert"],[16,37,203,1],[16,40,203,1,"require"],[16,47,203,1],[16,48,203,1,"_dependencyMap"],[16,62,203,1],[17,2,203,1],[17,6,203,1,"Alert"],[17,11,203,1],[17,14,203,1,"_interopDefault"],[17,29,203,1],[17,30,203,1,"_reactNativeWebDistExportsAlert"],[17,61,203,1],[18,2,7,0],[18,6,7,0,"_api"],[18,10,7,0],[18,13,7,0,"require"],[18,20,7,0],[18,21,7,0,"_dependencyMap"],[18,35,7,0],[19,2,1,0],[20,2,2,0],[21,2,3,0],[22,2,4,0],[24,2,9,0],[25,0,10,0],[26,0,11,0],[27,0,12,0],[29,2,17,0],[30,0,18,0],[31,0,19,0],[33,2,52,0],[34,0,53,0],[35,0,54,0],[36,2,55,0],[36,11,55,9,"getErrorDetail"],[36,25,55,23,"getErrorDetail"],[36,26,55,24,"error"],[36,31,55,34],[36,33,55,44],[37,4,56,2],[37,11,56,9,"error"],[37,16,56,14],[37,18,56,16,"response"],[37,26,56,24],[37,28,56,26,"data"],[37,32,56,30],[37,34,56,32,"detail"],[37,40,56,38],[37,44,57,7,"error"],[37,49,57,12],[37,51,57,14,"message"],[37,58,57,21],[37,62,58,7],[37,84,58,29],[38,2,59,0],[40,2,61,0],[41,0,62,0],[42,0,63,0],[43,0,64,0],[44,0,65,0],[45,0,66,0],[46,0,67,0],[47,0,68,0],[48,0,69,0],[49,0,70,0],[50,0,71,0],[51,0,72,0],[52,0,73,0],[53,0,74,0],[54,0,75,0],[55,0,76,0],[56,0,77,0],[57,0,78,0],[58,0,79,0],[59,0,80,0],[60,0,81,0],[61,0,82,0],[62,0,83,0],[63,0,84,0],[64,0,85,0],[65,0,86,0],[66,0,87,0],[67,0,88,0],[68,0,89,0],[69,0,90,0],[70,0,91,0],[71,0,92,0],[72,2,93,7],[72,17,93,22,"safeMutation"],[72,29,93,34,"safeMutation"],[72,30,94,2,"actionName"],[72,40,94,20],[72,42,95,2,"fn"],[72,44,95,22],[72,46,96,2,"opts"],[72,50,96,30],[72,53,96,33],[72,54,96,34],[72,55,96,35],[72,57,97,30],[73,4,98,2],[73,10,98,8],[74,6,99,4,"onSuccess"],[74,15,99,13],[75,6,100,4,"onError"],[75,13,100,11],[76,6,101,4,"refreshUser"],[76,17,101,15],[76,20,101,18],[76,24,101,22],[77,6,102,4,"fetchUserFn"],[77,17,102,15],[78,6,103,4,"showErrorAlert"],[78,20,103,18],[78,23,103,21],[78,28,103,26],[79,6,104,4,"errorMessage"],[79,18,104,16],[80,6,105,4,"rethrow"],[80,13,105,11],[80,16,105,14],[81,4,106,2],[81,5,106,3],[81,8,106,6,"opts"],[81,12,106,10],[82,4,108,2],[82,8,108,6],[83,6,109,4,"console"],[83,13,109,11],[83,14,109,12,"log"],[83,17,109,15],[83,18,109,16],[83,46,109,44,"actionName"],[83,56,109,54],[83,58,109,56],[83,59,109,57],[85,6,111,4],[86,6,112,4],[86,12,112,10,"data"],[86,16,112,14],[86,19,112,17],[86,25,112,23,"fn"],[86,27,112,25],[86,28,112,26],[86,29,112,27],[87,6,114,4,"console"],[87,13,114,11],[87,14,114,12,"log"],[87,17,114,15],[87,18,114,16],[87,45,114,43,"actionName"],[87,55,114,53],[87,57,114,55],[87,58,114,56],[89,6,116,4],[90,6,117,4],[90,10,117,8,"refreshUser"],[90,21,117,19],[90,25,117,23,"fetchUserFn"],[90,36,117,34],[90,38,117,36],[91,8,118,6],[91,12,118,10],[92,10,119,8],[92,16,119,14,"fetchUserFn"],[92,27,119,25],[92,28,119,26],[92,29,119,27],[93,8,120,6],[93,9,120,7],[93,10,120,8],[93,17,120,15,"refreshError"],[93,29,120,27],[93,31,120,29],[94,10,121,8,"console"],[94,17,121,15],[94,18,121,16,"error"],[94,23,121,21],[94,24,121,22],[94,71,121,69,"actionName"],[94,81,121,79],[94,84,121,82],[94,86,121,84,"refreshError"],[94,98,121,96],[94,99,121,97],[95,10,122,8],[96,8,123,6],[97,6,124,4],[99,6,126,4],[100,6,127,4],[100,10,127,8,"onSuccess"],[100,19,127,17],[100,21,127,19],[101,8,128,6],[101,14,128,12,"onSuccess"],[101,23,128,21],[101,24,128,22,"data"],[101,28,128,26],[101,29,128,27],[102,6,129,4],[103,6,131,4],[103,13,131,11],[104,8,131,13,"ok"],[104,10,131,15],[104,12,131,17],[104,16,131,21],[105,8,131,23,"data"],[106,6,131,28],[106,7,131,29],[107,4,133,2],[107,5,133,3],[107,6,133,4],[107,13,133,11,"error"],[107,18,133,21],[107,20,133,23],[108,6,134,4],[108,12,134,10,"detail"],[108,18,134,16],[108,21,134,19,"getErrorDetail"],[108,35,134,33],[108,36,134,34,"error"],[108,41,134,39],[108,42,134,40],[109,6,135,4,"console"],[109,13,135,11],[109,14,135,12,"error"],[109,19,135,17],[109,20,135,18],[109,46,135,44,"actionName"],[109,56,135,54],[109,58,135,56],[109,60,135,58,"error"],[109,65,135,63],[109,66,135,64],[111,6,137,4],[112,6,138,4],[112,10,138,8,"onError"],[112,17,138,15],[112,19,138,17],[113,8,139,6,"onError"],[113,15,139,13],[113,16,139,14,"error"],[113,21,139,19],[113,22,139,20],[114,6,140,4],[116,6,142,4],[117,6,143,4],[118,6,144,4],[119,6,145,4],[119,10,145,8,"showErrorAlert"],[119,24,145,22],[119,28,145,26],[119,29,145,27],[119,33,145,27,"isErrorHandledGlobally"],[119,37,145,49],[119,38,145,49,"isErrorHandledGlobally"],[119,60,145,49],[119,62,145,50,"error"],[119,67,145,55],[119,68,145,56],[119,70,145,58],[120,8,146,6,"Alert"],[120,13,146,11],[120,14,146,11,"default"],[120,21,146,11],[120,22,146,12,"alert"],[120,27,146,17],[120,28,146,18],[120,35,146,25],[120,37,146,27,"errorMessage"],[120,49,146,39],[120,53,146,43,"detail"],[120,59,146,49],[120,60,146,50],[121,6,147,4],[123,6,149,4],[124,6,150,4],[124,10,150,8,"rethrow"],[124,17,150,15],[124,19,150,17],[125,8,151,6],[125,14,151,12,"error"],[125,19,151,17],[126,6,152,4],[127,6,154,4],[127,13,154,11],[128,8,154,13,"ok"],[128,10,154,15],[128,12,154,17],[128,17,154,22],[129,8,154,24,"error"],[129,13,154,29],[130,8,154,31,"detail"],[131,6,154,38],[131,7,154,39],[132,4,155,2],[133,2,156,0],[135,2,158,0],[136,0,159,0],[137,0,160,0],[138,0,161,0],[139,2,162,7],[139,11,162,16,"isMutationSuccess"],[139,28,162,33,"isMutationSuccess"],[139,29,162,37,"result"],[139,35,162,62],[139,37,162,97],[140,4,163,2],[140,11,163,9,"result"],[140,17,163,15],[140,18,163,16,"ok"],[140,20,163,18],[140,25,163,23],[140,29,163,27],[141,2,164,0],[143,2,166,0],[144,0,167,0],[145,0,168,0],[146,0,169,0],[147,0,170,0],[148,0,171,0],[149,0,172,0],[150,0,173,0],[151,0,174,0],[152,2,175,7],[152,11,175,16,"createMutationExecutor"],[152,33,175,38,"createMutationExecutor"],[152,34,175,39,"fetchUserFn"],[152,45,175,72],[152,47,175,74],[153,4,176,2],[153,11,176,9],[153,26,176,24,"executeMutation"],[153,41,176,39,"executeMutation"],[153,42,177,4,"actionName"],[153,52,177,22],[153,54,178,4,"fn"],[153,56,178,24],[153,58,179,4,"opts"],[153,62,179,53],[153,65,179,56],[153,66,179,57],[153,67,179,58],[153,69,180,32],[154,6,181,4],[154,13,181,11,"safeMutation"],[154,25,181,23],[154,26,181,24,"actionName"],[154,36,181,34],[154,38,181,36,"fn"],[154,40,181,38],[154,42,181,40],[155,8,182,6],[155,11,182,9,"opts"],[155,15,182,13],[156,8,183,6,"fetchUserFn"],[157,6,184,4],[157,7,184,5],[157,8,184,6],[158,4,185,2],[158,5,185,3],[159,2,186,0],[161,2,188,0],[162,0,189,0],[163,0,190,0],[164,0,191,0],[165,0,192,0],[166,0,193,0],[167,2,194,7],[167,11,194,16,"preventOptimisticUpdate"],[167,34,194,39,"preventOptimisticUpdate"],[167,35,195,2,"actionName"],[167,45,195,20],[167,47,196,2,"_setter"],[167,54,196,21],[167,56,197,8],[168,4,198,2,"console"],[168,11,198,9],[168,12,198,10,"warn"],[168,16,198,14],[168,17,199,4],[168,63,199,50,"actionName"],[168,73,199,60],[168,78,199,65],[168,81,200,4],[168,156,201,2],[168,157,201,3],[169,4,202,2],[170,2,203,0],[171,0,203,1],[171,3]],"functionMap":{"names":["<global>","getErrorDetail","safeMutation","isMutationSuccess","createMutationExecutor","executeMutation","preventOptimisticUpdate"],"mappings":"AAA;ACsD;CDI;OEkC;CF+D;OGM;CHE;OIW;SCC;GDS;CJC;OMQ;CNS"},"hasCjsExports":false},"type":"js/module"}]}