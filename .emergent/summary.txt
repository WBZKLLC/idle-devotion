<analysis>
**original_problem_statement**:
The user's goal is a comprehensive security and stability overhaul of the application for Production Readiness. This session focused on implementing a server-authoritative entitlements and monetization system, ensuring it is extra-strict and resilient to client-side exploits and race conditions.

Key phases implemented:
1.  **Section 3.6: Server-Authoritative Entitlements System**: Create the foundational backend and frontend for a secure, server-driven IAP and entitlements system. This includes strict server-side verification, client-side caching, and drift-prevention guards.
2.  **Section 3.7: RevenueCat Webhook Scaffold**: Implement a backend webhook to handle asynchronous entitlement updates from RevenueCat, such as renewals and expirations, ensuring the server remains the source of truth.
3.  **Section 3.8: Canonical Purchase UX Wiring**: Unify all purchase-related UI into a single, canonical component () and flow to prevent divergent implementations. This involved a repo-wide sweep and refactoring of all premium/paywall entry points.

The current task is the beginning of the next phase:
**Phase 3.9 ‚Äî AuthEpoch Expansion (strict)**: Systematically apply an  guard to every asynchronous store action that mutates state after an API call. This prevents race conditions where a late API response from a previous session (before logout) incorrectly modifies the current user's state.

**User's preferred language**: English

**what currently exists?**
The application now has a robust, extra-strict server-authoritative entitlements system.
- **Backend ()**:
    - : Returns a user's complete, server-verified entitlement state.
    - : A strict endpoint that verifies IAP receipts. It requires a  to be set in the environment to grant entitlements; otherwise, it fails safely. It is idempotent using a unique index on .
    - : An idempotent webhook handler for RevenueCat events (e.g., purchases, expirations), protected by a signature check in production.
    - **Policy Enforcement**: Legacy purchase endpoints are disabled (return ), and all simulated dev purchase endpoints are gated to run only when .
    - **Gating**: A reusable helper, , is used to enforce server-side 403 checks on premium endpoints, such as Battle Pass claims and cinematic access.
- **Frontend**:
    - **Canonical Purchase Flow**: All IAP purchases are channeled through a single  component and a  state machine. A legacy  component has been refactored to be a thin wrapper around this canonical flow.
    - **Centralized Product Definitions**: A single source of truth for product metadata exists at .
    - **State Management**:  acts as a client-side cache for the server snapshot.  manages the IAP state machine.
    - **Gating Helpers**:  and  provide a consistent way for UI components to check for permissions. The  helper now uses a single canonical gate to check access and route to a paywall if denied.
    - **Drift-Prevention Guards**: Multiple scripts in  run as part of 
> frontend@1.0.0 guard
> npm run guard:hero && npm run guard:tier && npm run guard:select-hero && npm run guard:user-heroes-map && npm run guard:feature-flags && npm run guard:hero-signature && npm run guard:no-free-cinematics && npm run guard:no-inline-power && npm run guard:no-paid-wording && npm run guard:entitlements-access && npm run guard:purchase-flow


> frontend@1.0.0 guard:hero
> node scripts/guard-no-hero-list-fallback.mjs

[guard:no-hero-list-fallback] ‚úÖ Flag is true and there is no runtime path to list fetch (fallback may exist but is unreachable).

> frontend@1.0.0 guard:tier
> node scripts/guard-no-direct-tier-imports.mjs

[guard:no-direct-tier-imports] ‚úÖ No direct tier imports found in UI.

> frontend@1.0.0 guard:select-hero
> node scripts/guard-select-user-hero-by-id.mjs

[guard:selectUserHeroById] ‚úÖ O(1) selector enforced.

> frontend@1.0.0 guard:user-heroes-map
> node scripts/guard-user-heroes-map-sync.mjs

[guard:user-heroes-map] ‚úÖ userHeroes/userHeroesById sync enforced.

> frontend@1.0.0 guard:feature-flags
> node scripts/guard-feature-flags.mjs

[guard:feature-flags] Checking feature flag architecture...
[guard:feature-flags] ‚úÖ Feature flag architecture enforced (read-only UI).

> frontend@1.0.0 guard:hero-signature
> node scripts/guard-get-user-hero-signature.mjs

[guard:get-user-hero-signature] Checking getUserHeroById call signatures...
[guard:get-user-hero-signature] ‚úÖ All getUserHeroById calls use correct signature.

> frontend@1.0.0 guard:no-free-cinematics
> node scripts/guard-no-free-cinematics.mjs

‚úÖ guard-no-free-cinematics: No free cinematic preview UI in app/ screens.

> frontend@1.0.0 guard:no-inline-power
> node scripts/guard-no-inline-power.mjs

‚úÖ guard-no-inline-power: No inline power formulas in app/ screens.

> frontend@1.0.0 guard:no-paid-wording
> node scripts/guard-no-paid-wording.mjs

‚úÖ guard-no-paid-wording: No forbidden paid wording found.

> frontend@1.0.0 guard:entitlements-access
> node scripts/guard-entitlements-access.mjs

üîí Checking entitlement store access patterns...

‚úÖ No direct entitlement store access found.
   All screens use gating helpers correctly.


> frontend@1.0.0 guard:purchase-flow
> node scripts/guard-purchase-flow.mjs

üîí Checking purchase flow patterns...

‚úÖ No purchase flow violations found.
   All screens use PurchaseButton and canonical products. to statically prevent regressions, such as direct API calls from UI, use of raw product strings, or use of legacy paywall patterns.
- **AuthEpoch System**: The  value in  is incremented on logout. Guards have been applied to  and  to invalidate stale API responses. Work has begun to expand this to all other async store actions.

**Last working item**:
    - Last item agent was working: **Phase 3.9 - AuthEpoch Expansion**. The agent was systematically auditing  to identify all asynchronous actions that perform API calls and mutate state, and then applying the  guard pattern to them. The work involved adding the epoch check at the start of the function and after any  before a  call.
    - Status: IN PROGRESS
    - Agent Testing Done: N
    - Which testing method agent to use? manual testing by curl. After the implementation is complete, the agent should test by logging in, triggering a long-running async action (like a gacha pull), quickly logging out, and ensuring no state from the previous session's action is applied to the new (empty) state.
    - User Testing Done: N

**All Pending/In progress Issue list**:
  - Issue 1: (P1) The cinematic video feature for 5+ star heroes is non-functional due to an incompatible video codec. The  script needs to be run.
  - Issue 2: (P1)  still contains some client-side logic () based on VIP level to determine premium status for the UI, which could be confusing. It should be refactored to rely solely on  for all premium-related UI states to align with the canonical system.

  Issues Detail:
  - Issue 1:
     - Attempted fixes: None in this session.
     - Next debug checklist:
       - Run the script at .
       - Verify that the cinematic videos in  play correctly on web and mobile.
     - Why fix this issue and what will be achieved with the fix? This restores a broken premium feature for players.
     - Status:  NOT STARTED
     - Is recurring issue? Y/N: N
     - Should Test frontend/backend/both after fix? frontend
     - Blocked on other issue: None
  - Issue 2:
     - Attempted fixes: The agent renamed the variable to  to distinguish it from the real entitlement and made the claim button route to the paywall. However, the underlying logic still exists.
     - Next debug checklist:
       - Open .
       - Remove all logic that checks  to determine if the battle pass is premium.
       - Use  as the single source of truth for all UI elements related to the premium track.
     - Why fix this issue and what will be achieved with the fix? To eliminate UI state drift and ensure the UI is a perfect reflection of the server-authoritative entitlement state.
     - Status: NOT STARTED
     - Is recurring issue? Y/N: N
     - Should Test frontend/backend/both after fix? frontend
     - Blocked on other issue: None

**In progress Task List**:
  - Task 1: (P0) Complete the AuthEpoch Expansion (Phase 3.9).
  
  Task Detail:
  - Task 1: 
     - Where to resume: The agent has already identified the async functions in  that need guards and has started applying the pattern. Resume by applying the  check to the remaining functions: , , , , , and .
     - What will be achieved with this? Prevents state corruption from stale in-flight API responses after a user logs out, increasing app stability.
     - Status: IN PROGRESS
     - Should Test frontend/backend/both after fix? frontend
     - Blocked on something: None

**Upcoming and Future Tasks**
*   **Upcoming Tasks:**
    *   **P0: Create Guardrail for AuthEpoch**: Implement a static analysis script () to detect async store actions that mutate state after an API call without an  check. Add this to the 
> frontend@1.0.0 guard
> npm run guard:hero && npm run guard:tier && npm run guard:select-hero && npm run guard:user-heroes-map && npm run guard:feature-flags && npm run guard:hero-signature && npm run guard:no-free-cinematics && npm run guard:no-inline-power && npm run guard:no-paid-wording && npm run guard:entitlements-access && npm run guard:purchase-flow


> frontend@1.0.0 guard:hero
> node scripts/guard-no-hero-list-fallback.mjs

[guard:no-hero-list-fallback] ‚úÖ Flag is true and there is no runtime path to list fetch (fallback may exist but is unreachable).

> frontend@1.0.0 guard:tier
> node scripts/guard-no-direct-tier-imports.mjs

[guard:no-direct-tier-imports] ‚úÖ No direct tier imports found in UI.

> frontend@1.0.0 guard:select-hero
> node scripts/guard-select-user-hero-by-id.mjs

[guard:selectUserHeroById] ‚úÖ O(1) selector enforced.

> frontend@1.0.0 guard:user-heroes-map
> node scripts/guard-user-heroes-map-sync.mjs

[guard:user-heroes-map] ‚úÖ userHeroes/userHeroesById sync enforced.

> frontend@1.0.0 guard:feature-flags
> node scripts/guard-feature-flags.mjs

[guard:feature-flags] Checking feature flag architecture...
[guard:feature-flags] ‚úÖ Feature flag architecture enforced (read-only UI).

> frontend@1.0.0 guard:hero-signature
> node scripts/guard-get-user-hero-signature.mjs

[guard:get-user-hero-signature] Checking getUserHeroById call signatures...
[guard:get-user-hero-signature] ‚úÖ All getUserHeroById calls use correct signature.

> frontend@1.0.0 guard:no-free-cinematics
> node scripts/guard-no-free-cinematics.mjs

‚úÖ guard-no-free-cinematics: No free cinematic preview UI in app/ screens.

> frontend@1.0.0 guard:no-inline-power
> node scripts/guard-no-inline-power.mjs

‚úÖ guard-no-inline-power: No inline power formulas in app/ screens.

> frontend@1.0.0 guard:no-paid-wording
> node scripts/guard-no-paid-wording.mjs

‚úÖ guard-no-paid-wording: No forbidden paid wording found.

> frontend@1.0.0 guard:entitlements-access
> node scripts/guard-entitlements-access.mjs

üîí Checking entitlement store access patterns...

‚úÖ No direct entitlement store access found.
   All screens use gating helpers correctly.


> frontend@1.0.0 guard:purchase-flow
> node scripts/guard-purchase-flow.mjs

üîí Checking purchase flow patterns...

‚úÖ No purchase flow violations found.
   All screens use PurchaseButton and canonical products. chain.
    *   **P1: Phase 3.10 ‚Äî Entitlements Cache TTL + Refresh Discipline**: Implement logic to use the  from the entitlements snapshot. Create a helper  that checks for staleness and triggers a non-blocking background refresh.
    *   **P1: Phase 3.11 ‚Äî Canonical ‚ÄúPremium Navigation‚Äù Routing**: Create a single exported helper, , and refactor all premium denial routes to use it, ensuring a single, consistent paywall entry point.
*   **Future Tasks:**
    *   **P2: Walter-required Testing**: Perform end-to-end testing on real devices, which was deferred. This includes:
        - Real device IAP purchase flow.
        - RevenueCat sandbox webhook delivery test.
        - Production environment sanity checks (, secrets are set).
    *   **P2: Fix Web Video Asset Compatibility**: Run the  script to fix broken cinematic playback.

**Completed work in this session**
- **Section 3.6 - Server-Authoritative Entitlements System**: Fully implemented. The backend is now the source of truth, with strict verification and idempotency.
- **Section 3.7 - RevenueCat Webhook Scaffold**: A secure, idempotent webhook handler for RevenueCat is in place.
- **Section 3.8 - Canonical Purchase UX & Repo-Wide Sweep**: All purchase CTAs and paywalls have been unified into a single, canonical flow using . A repo-wide sweep was conducted to find and refactor all premium entry points. Drift-prevention guards were created and are active.
- **Backend Policy Enforcement**: Legacy/insecure purchase endpoints have been disabled, and server-side entitlement gating is enforced on all relevant premium features.

**Earlier issues found/mentioned but not fixed**
   - Issue 1: The cinematic video feature for 5+ star heroes is known to be broken. The video files fail to load due to an incompatible codec. The frontend gracefully handles the error, but the feature is non-functional.
     - Why to solve this issue and what will be achieved with this? Fixing this will restore a premium cosmetic feature for players who have acquired high-tier heroes.
     - Should Test frontend/backend/both after fix: frontend
     - Is recurring issue? N

**Known issue recurrence from previous fork**
  - None.

**Code Architecture**


**Key Technical Concepts**
- **Server-Authoritative State**: The core principle that the client is a dumb renderer of server state, especially for monetization.
- **Canonical Components & Flows**: The practice of creating a single, reusable component () and logic () for a critical action to prevent implementation drift.
- **Drift-Prevention Guards**: Using static analysis scripts () to enforce architectural rules and patterns at CI/pre-commit time.
- **Idempotency**: Implemented in the backend for  and  to safely handle network retries.
- **AuthEpoch**: A client-side state-invalidation mechanism to prevent race conditions from stale async requests after a user's session changes (e.g., logout).
- **Policy as Code**: Implementing business rules (e.g., dev-only endpoints, disable legacy APIs) directly in the application logic with clear gates.

**key DB schema**
- **purchase_idempotency** collection: A unique index was created on  to ensure purchase verification is idempotent.
- **revenuecat_webhook_events** collection: A unique index was created on  to ensure webhook events are processed only once.

**changes in tech stack**
- No new packages were added. The session focused on architectural patterns and hardening using the existing stack.

**All files of reference**
- : The heart of the new strict backend logic.
- : The canonical frontend state machine for purchases.
- : The single UI component for all purchases.
- : Currently being modified for the  expansion.
- : An example of the drift-prevention guards.

**Areas that need refactoring**:
- : This file still exists but is a remnant of a previous integration. While the active  was canonicalized, this store should be audited and likely removed to prevent future confusion.
- : Still uses client-side checks () to determine premium UI state, which can drift from the server-authoritative entitlement. It should be refactored to only use .

**key api endpoints**
- : **Strictly Gated.** Verifies IAP receipts and grants entitlements. Requires .
- : **NEW & Gated.** Handles entitlement updates from RevenueCat.
- : Fetches the user's complete entitlement state.
- : **Gated.** Checks entitlement before allowing access.
- : **DEPRECATED** (returns 410 Gone).
- Various simulated purchase endpoints (e.g., ): **DEV-Only.**

**Critical Info for New Agent**
- The user is highly technical and expects extra-strict implementations. Adhere to canonical patterns and do not introduce alternative logic paths.
- The highest priority is completing the **Phase 3.9: AuthEpoch Expansion** in .
- After completing Phase 3.9, the next steps are clear: create a guard for it, then implement Phase 3.10 (TTL Refresh) and 3.11 (Canonical Navigation).
- Do not handle secrets in chat. All secrets (, etc.) are expected to be loaded from server environment variables.

**documents created in this job**
- /app/frontend/lib/entitlements/purchase-flow.ts
- /app/frontend/components/PurchaseButton.tsx
- /app/frontend/lib/entitlements/products.ts
- /app/frontend/scripts/guard-entitlements-access.mjs
- /app/frontend/scripts/guard-purchase-flow.mjs

**Last 10 User Messages and any pending HUMAN messages**
1.  **User (LATEST)**: Confirmed the repo sweep was adequate and gave the go-ahead for the next phase: **3.9 AuthEpoch expansion**, providing a detailed plan and minimum coverage list. (IN PROGRESS)
2.  **User**: Made a final revision request for  to use a single canonical gating function instead of re-implementing checks. (RESOLVED)
3.  **User**: Reviewed the agent's repo-wide sweep hardening and identified four must refactor/harden items to prevent drift. (RESOLVED)
4.  **User**: Asked for the output of two  commands to perform a repo-wide sweep review. (RESOLVED)
5.  **User**: Confirmed the paywall canonicalization was complete and approved the final summary. (RESOLVED)
6.  **User**: Pointed out that the legacy  component was a policy violation risk and must be neutralized by replacing its internals with the canonical flow. (RESOLVED)
7.  **User**: Confirmed the repo-wide sweep was complete and the summary was accurate, but noted the legacy  needed attention. (RESOLVED)
8.  **User**: Provided a set of  commands for a repo-wide sweep to find and refactor all remaining premium/paywall entry points into the canonical flow. (RESOLVED)
9.  **User**: Confirmed that the canonical purchase UX (Section 3.8) was implemented and asked for the next step, which is the repo-wide sweep. (RESOLVED)
10. **User**: Provided the full plan for Section 3.8, including creating a canonical  file, wiring  everywhere, and adding more drift-prevention guards. (RESOLVED)

**Project Health Check:**
- **Broken**:
    - Web video playback for cinematics (due to incompatible video codecs).
- **Hardened / Improved**:
    - The entire entitlements and purchase system is now server-authoritative and extra-strict.
    - Numerous drift-prevention guards are in place to maintain architectural integrity.
    - Legacy purchase/paywall systems have been neutralized.
- **Mocked**:
    - The RevenueCat integration in  is scaffolded. It checks for the presence of  but does not perform actual API calls to RevenueCat, instead returning mock success/failure.

**3rd Party Integrations**
*   **RevenueCat**: Architecturally central to the new IAP flow. The backend is built to interact with it, and a webhook handler is ready, but it's functionally mocked pending API keys.
*   **Sentry**: For crash reporting.
*   **@react-native-community/netinfo**: For network detection.
*   **OpenAI GPT-4**: For backend AI narration (via Emergent LLM Key).
*   **axios**: Used for frontend API calls.
*   **zustand**: For frontend state management.

**Testing status**
  - Testing agent used after significant changes: NO
  - Troubleshoot agent used after agent stuck in loop: NO
  - Test files created: None.
  - Known regressions: None.

**Credentials to test flow:**
- **Super Admin**:
    - Username: 
    - Password: 

**What agent forgot to execute**
- The agent has not yet implemented the recommended guardrail script for the  pattern. This was suggested by the user as part of the Phase 3.9 plan.

</analysis>
