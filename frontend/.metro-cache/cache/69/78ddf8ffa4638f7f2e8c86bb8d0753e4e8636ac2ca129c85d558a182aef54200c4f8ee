{"dependencies":[{"name":"../authStorage","data":{"asyncType":null,"isESMImport":true,"locs":[{"start":{"line":8,"column":0,"index":234},"end":{"line":8,"column":47,"index":281}}],"key":"8h7N/7sKemAZqrgZg8dH/jTl5ys=","exportNames":["*"],"imports":1}}],"output":[{"data":{"code":"__d(function (global, require, _$$_IMPORT_DEFAULT, _$$_IMPORT_ALL, module, exports, _dependencyMap) {\n  \"use strict\";\n\n  Object.defineProperty(exports, '__esModule', {\n    value: true\n  });\n  exports.getMailSummary = getMailSummary;\n  exports.getMailRewards = getMailRewards;\n  exports.getMailMessages = getMailMessages;\n  exports.getMailGifts = getMailGifts;\n  exports.claimMailReward = claimMailReward;\n  exports.claimMailGift = claimMailGift;\n  var _authStorage = require(_dependencyMap[0], \"../authStorage\");\n  // /app/frontend/lib/api/mail.ts\n  // Phase 3.23.2.P: Mail API Layer with Auth\n  //\n  // Canonical API calls for mail system.\n  // Uses auth token from gameStore for server identity.\n  // Graceful error handling â€” returns defaults on failure.\n\n  const API_BASE = process.env.EXPO_PUBLIC_API_URL || '';\n\n  /**\n   * Get auth headers for API calls\n   */\n  async function getAuthHeaders() {\n    const token = await (0, _authStorage.loadAuthToken)();\n    if (token) {\n      return {\n        Authorization: `Bearer ${token}`\n      };\n    }\n    return {};\n  }\n\n  /**\n   * Get mail summary (badge counts) - uses auth token\n   */\n  async function getMailSummary(username) {\n    try {\n      const headers = await getAuthHeaders();\n      // Use legacy route for compatibility, but server uses auth token for identity\n      const res = await fetch(`${API_BASE}/api/mail/summary/${username}`, {\n        headers\n      });\n      if (res.status === 401) {\n        // Token invalid - return defaults, let auth layer handle logout\n        return {\n          rewardsAvailable: 0,\n          unreadMessages: 0,\n          giftsAvailable: 0\n        };\n      }\n      if (!res.ok) throw new Error('Failed to fetch mail summary');\n      return await res.json();\n    } catch {\n      return {\n        rewardsAvailable: 0,\n        unreadMessages: 0,\n        giftsAvailable: 0\n      };\n    }\n  }\n\n  /**\n   * Get mail rewards list\n   */\n  async function getMailRewards(username) {\n    try {\n      const headers = await getAuthHeaders();\n      const res = await fetch(`${API_BASE}/api/mail/rewards/${username}`, {\n        headers\n      });\n      if (!res.ok) throw new Error('Failed to fetch rewards');\n      return await res.json();\n    } catch {\n      return [];\n    }\n  }\n\n  /**\n   * Get mail messages list\n   */\n  async function getMailMessages(username) {\n    try {\n      const headers = await getAuthHeaders();\n      const res = await fetch(`${API_BASE}/api/mail/messages/${username}`, {\n        headers\n      });\n      if (!res.ok) throw new Error('Failed to fetch messages');\n      return await res.json();\n    } catch {\n      return [];\n    }\n  }\n\n  /**\n   * Get mail gifts list\n   */\n  async function getMailGifts(username) {\n    try {\n      const headers = await getAuthHeaders();\n      const res = await fetch(`${API_BASE}/api/mail/gifts/${username}`, {\n        headers\n      });\n      if (!res.ok) throw new Error('Failed to fetch gifts');\n      return await res.json();\n    } catch {\n      return [];\n    }\n  }\n\n  /**\n   * Claim a mail reward (idempotent)\n   */\n  async function claimMailReward(username, rewardId) {\n    const headers = await getAuthHeaders();\n    const res = await fetch(`${API_BASE}/api/mail/rewards/${username}/${rewardId}/claim`, {\n      method: 'POST',\n      headers\n    });\n    if (!res.ok) throw new Error('Failed to claim reward');\n    return await res.json();\n  }\n\n  /**\n   * Claim a mail gift (idempotent)\n   */\n  async function claimMailGift(username, giftId) {\n    const headers = await getAuthHeaders();\n    const res = await fetch(`${API_BASE}/api/mail/gifts/${username}/${giftId}/claim`, {\n      method: 'POST',\n      headers\n    });\n    if (!res.ok) throw new Error('Failed to claim gift');\n    return await res.json();\n  }\n});","lineCount":138,"map":[[7,2,26,0,"exports"],[7,9,26,0],[7,10,26,0,"getMailSummary"],[7,24,26,0],[7,27,26,0,"getMailSummary"],[7,41,26,0],[8,2,49,0,"exports"],[8,9,49,0],[8,10,49,0,"getMailRewards"],[8,24,49,0],[8,27,49,0,"getMailRewards"],[8,41,49,0],[9,2,70,0,"exports"],[9,9,70,0],[9,10,70,0,"getMailMessages"],[9,25,70,0],[9,28,70,0,"getMailMessages"],[9,43,70,0],[10,2,90,0,"exports"],[10,9,90,0],[10,10,90,0,"getMailGifts"],[10,22,90,0],[10,25,90,0,"getMailGifts"],[10,37,90,0],[11,2,110,0,"exports"],[11,9,110,0],[11,10,110,0,"claimMailReward"],[11,25,110,0],[11,28,110,0,"claimMailReward"],[11,43,110,0],[12,2,123,0,"exports"],[12,9,123,0],[12,10,123,0,"claimMailGift"],[12,23,123,0],[12,26,123,0,"claimMailGift"],[12,39,123,0],[13,2,8,0],[13,6,8,0,"_authStorage"],[13,18,8,0],[13,21,8,0,"require"],[13,28,8,0],[13,29,8,0,"_dependencyMap"],[13,43,8,0],[14,2,1,0],[15,2,2,0],[16,2,3,0],[17,2,4,0],[18,2,5,0],[19,2,6,0],[21,2,10,0],[21,8,10,6,"API_BASE"],[21,16,10,14],[21,19,10,17,"process"],[21,26,10,24],[21,27,10,25,"env"],[21,30,10,28],[21,31,10,29,"EXPO_PUBLIC_API_URL"],[21,50,10,48],[21,54,10,52],[21,56,10,54],[23,2,12,0],[24,0,13,0],[25,0,14,0],[26,2,15,0],[26,17,15,15,"getAuthHeaders"],[26,31,15,29,"getAuthHeaders"],[26,32,15,29],[26,34,15,65],[27,4,16,2],[27,10,16,8,"token"],[27,15,16,13],[27,18,16,16],[27,24,16,22],[27,28,16,22,"loadAuthToken"],[27,40,16,35],[27,41,16,35,"loadAuthToken"],[27,54,16,35],[27,56,16,36],[27,57,16,37],[28,4,17,2],[28,8,17,6,"token"],[28,13,17,11],[28,15,17,13],[29,6,18,4],[29,13,18,11],[30,8,18,13,"Authorization"],[30,21,18,26],[30,23,18,28],[30,33,18,38,"token"],[30,38,18,43],[31,6,18,46],[31,7,18,47],[32,4,19,2],[33,4,20,2],[33,11,20,9],[33,12,20,10],[33,13,20,11],[34,2,21,0],[36,2,23,0],[37,0,24,0],[38,0,25,0],[39,2,26,7],[39,17,26,22,"getMailSummary"],[39,31,26,36,"getMailSummary"],[39,32,26,37,"username"],[39,40,26,53],[39,42,30,3],[40,4,31,2],[40,8,31,6],[41,6,32,4],[41,12,32,10,"headers"],[41,19,32,17],[41,22,32,20],[41,28,32,26,"getAuthHeaders"],[41,42,32,40],[41,43,32,41],[41,44,32,42],[42,6,33,4],[43,6,34,4],[43,12,34,10,"res"],[43,15,34,13],[43,18,34,16],[43,24,34,22,"fetch"],[43,29,34,27],[43,30,34,28],[43,33,34,31,"API_BASE"],[43,41,34,39],[43,62,34,60,"username"],[43,70,34,68],[43,72,34,70],[43,74,34,72],[44,8,34,74,"headers"],[45,6,34,82],[45,7,34,83],[45,8,34,84],[46,6,35,4],[46,10,35,8,"res"],[46,13,35,11],[46,14,35,12,"status"],[46,20,35,18],[46,25,35,23],[46,28,35,26],[46,30,35,28],[47,8,36,6],[48,8,37,6],[48,15,37,13],[49,10,37,15,"rewardsAvailable"],[49,26,37,31],[49,28,37,33],[49,29,37,34],[50,10,37,36,"unreadMessages"],[50,24,37,50],[50,26,37,52],[50,27,37,53],[51,10,37,55,"giftsAvailable"],[51,24,37,69],[51,26,37,71],[52,8,37,73],[52,9,37,74],[53,6,38,4],[54,6,39,4],[54,10,39,8],[54,11,39,9,"res"],[54,14,39,12],[54,15,39,13,"ok"],[54,17,39,15],[54,19,39,17],[54,25,39,23],[54,29,39,27,"Error"],[54,34,39,32],[54,35,39,33],[54,65,39,63],[54,66,39,64],[55,6,40,4],[55,13,40,11],[55,19,40,17,"res"],[55,22,40,20],[55,23,40,21,"json"],[55,27,40,25],[55,28,40,26],[55,29,40,27],[56,4,41,2],[56,5,41,3],[56,6,41,4],[56,12,41,10],[57,6,42,4],[57,13,42,11],[58,8,42,13,"rewardsAvailable"],[58,24,42,29],[58,26,42,31],[58,27,42,32],[59,8,42,34,"unreadMessages"],[59,22,42,48],[59,24,42,50],[59,25,42,51],[60,8,42,53,"giftsAvailable"],[60,22,42,67],[60,24,42,69],[61,6,42,71],[61,7,42,72],[62,4,43,2],[63,2,44,0],[65,2,46,0],[66,0,47,0],[67,0,48,0],[68,2,49,7],[68,17,49,22,"getMailRewards"],[68,31,49,36,"getMailRewards"],[68,32,49,37,"username"],[68,40,49,53],[68,42,56,4],[69,4,57,2],[69,8,57,6],[70,6,58,4],[70,12,58,10,"headers"],[70,19,58,17],[70,22,58,20],[70,28,58,26,"getAuthHeaders"],[70,42,58,40],[70,43,58,41],[70,44,58,42],[71,6,59,4],[71,12,59,10,"res"],[71,15,59,13],[71,18,59,16],[71,24,59,22,"fetch"],[71,29,59,27],[71,30,59,28],[71,33,59,31,"API_BASE"],[71,41,59,39],[71,62,59,60,"username"],[71,70,59,68],[71,72,59,70],[71,74,59,72],[72,8,59,74,"headers"],[73,6,59,82],[73,7,59,83],[73,8,59,84],[74,6,60,4],[74,10,60,8],[74,11,60,9,"res"],[74,14,60,12],[74,15,60,13,"ok"],[74,17,60,15],[74,19,60,17],[74,25,60,23],[74,29,60,27,"Error"],[74,34,60,32],[74,35,60,33],[74,60,60,58],[74,61,60,59],[75,6,61,4],[75,13,61,11],[75,19,61,17,"res"],[75,22,61,20],[75,23,61,21,"json"],[75,27,61,25],[75,28,61,26],[75,29,61,27],[76,4,62,2],[76,5,62,3],[76,6,62,4],[76,12,62,10],[77,6,63,4],[77,13,63,11],[77,15,63,13],[78,4,64,2],[79,2,65,0],[81,2,67,0],[82,0,68,0],[83,0,69,0],[84,2,70,7],[84,17,70,22,"getMailMessages"],[84,32,70,37,"getMailMessages"],[84,33,70,38,"username"],[84,41,70,54],[84,43,76,4],[85,4,77,2],[85,8,77,6],[86,6,78,4],[86,12,78,10,"headers"],[86,19,78,17],[86,22,78,20],[86,28,78,26,"getAuthHeaders"],[86,42,78,40],[86,43,78,41],[86,44,78,42],[87,6,79,4],[87,12,79,10,"res"],[87,15,79,13],[87,18,79,16],[87,24,79,22,"fetch"],[87,29,79,27],[87,30,79,28],[87,33,79,31,"API_BASE"],[87,41,79,39],[87,63,79,61,"username"],[87,71,79,69],[87,73,79,71],[87,75,79,73],[88,8,79,75,"headers"],[89,6,79,83],[89,7,79,84],[89,8,79,85],[90,6,80,4],[90,10,80,8],[90,11,80,9,"res"],[90,14,80,12],[90,15,80,13,"ok"],[90,17,80,15],[90,19,80,17],[90,25,80,23],[90,29,80,27,"Error"],[90,34,80,32],[90,35,80,33],[90,61,80,59],[90,62,80,60],[91,6,81,4],[91,13,81,11],[91,19,81,17,"res"],[91,22,81,20],[91,23,81,21,"json"],[91,27,81,25],[91,28,81,26],[91,29,81,27],[92,4,82,2],[92,5,82,3],[92,6,82,4],[92,12,82,10],[93,6,83,4],[93,13,83,11],[93,15,83,13],[94,4,84,2],[95,2,85,0],[97,2,87,0],[98,0,88,0],[99,0,89,0],[100,2,90,7],[100,17,90,22,"getMailGifts"],[100,29,90,34,"getMailGifts"],[100,30,90,35,"username"],[100,38,90,51],[100,40,96,4],[101,4,97,2],[101,8,97,6],[102,6,98,4],[102,12,98,10,"headers"],[102,19,98,17],[102,22,98,20],[102,28,98,26,"getAuthHeaders"],[102,42,98,40],[102,43,98,41],[102,44,98,42],[103,6,99,4],[103,12,99,10,"res"],[103,15,99,13],[103,18,99,16],[103,24,99,22,"fetch"],[103,29,99,27],[103,30,99,28],[103,33,99,31,"API_BASE"],[103,41,99,39],[103,60,99,58,"username"],[103,68,99,66],[103,70,99,68],[103,72,99,70],[104,8,99,72,"headers"],[105,6,99,80],[105,7,99,81],[105,8,99,82],[106,6,100,4],[106,10,100,8],[106,11,100,9,"res"],[106,14,100,12],[106,15,100,13,"ok"],[106,17,100,15],[106,19,100,17],[106,25,100,23],[106,29,100,27,"Error"],[106,34,100,32],[106,35,100,33],[106,58,100,56],[106,59,100,57],[107,6,101,4],[107,13,101,11],[107,19,101,17,"res"],[107,22,101,20],[107,23,101,21,"json"],[107,27,101,25],[107,28,101,26],[107,29,101,27],[108,4,102,2],[108,5,102,3],[108,6,102,4],[108,12,102,10],[109,6,103,4],[109,13,103,11],[109,15,103,13],[110,4,104,2],[111,2,105,0],[113,2,107,0],[114,0,108,0],[115,0,109,0],[116,2,110,7],[116,17,110,22,"claimMailReward"],[116,32,110,37,"claimMailReward"],[116,33,110,38,"username"],[116,41,110,54],[116,43,110,56,"rewardId"],[116,51,110,72],[116,53,110,113],[117,4,111,2],[117,10,111,8,"headers"],[117,17,111,15],[117,20,111,18],[117,26,111,24,"getAuthHeaders"],[117,40,111,38],[117,41,111,39],[117,42,111,40],[118,4,112,2],[118,10,112,8,"res"],[118,13,112,11],[118,16,112,14],[118,22,112,20,"fetch"],[118,27,112,25],[118,28,112,26],[118,31,112,29,"API_BASE"],[118,39,112,37],[118,60,112,58,"username"],[118,68,112,66],[118,72,112,70,"rewardId"],[118,80,112,78],[118,88,112,86],[118,90,112,88],[119,6,113,4,"method"],[119,12,113,10],[119,14,113,12],[119,20,113,18],[120,6,114,4,"headers"],[121,4,115,2],[121,5,115,3],[121,6,115,4],[122,4,116,2],[122,8,116,6],[122,9,116,7,"res"],[122,12,116,10],[122,13,116,11,"ok"],[122,15,116,13],[122,17,116,15],[122,23,116,21],[122,27,116,25,"Error"],[122,32,116,30],[122,33,116,31],[122,57,116,55],[122,58,116,56],[123,4,117,2],[123,11,117,9],[123,17,117,15,"res"],[123,20,117,18],[123,21,117,19,"json"],[123,25,117,23],[123,26,117,24],[123,27,117,25],[124,2,118,0],[126,2,120,0],[127,0,121,0],[128,0,122,0],[129,2,123,7],[129,17,123,22,"claimMailGift"],[129,30,123,35,"claimMailGift"],[129,31,123,36,"username"],[129,39,123,52],[129,41,123,54,"giftId"],[129,47,123,68],[129,49,123,109],[130,4,124,2],[130,10,124,8,"headers"],[130,17,124,15],[130,20,124,18],[130,26,124,24,"getAuthHeaders"],[130,40,124,38],[130,41,124,39],[130,42,124,40],[131,4,125,2],[131,10,125,8,"res"],[131,13,125,11],[131,16,125,14],[131,22,125,20,"fetch"],[131,27,125,25],[131,28,125,26],[131,31,125,29,"API_BASE"],[131,39,125,37],[131,58,125,56,"username"],[131,66,125,64],[131,70,125,68,"giftId"],[131,76,125,74],[131,84,125,82],[131,86,125,84],[132,6,126,4,"method"],[132,12,126,10],[132,14,126,12],[132,20,126,18],[133,6,127,4,"headers"],[134,4,128,2],[134,5,128,3],[134,6,128,4],[135,4,129,2],[135,8,129,6],[135,9,129,7,"res"],[135,12,129,10],[135,13,129,11,"ok"],[135,15,129,13],[135,17,129,15],[135,23,129,21],[135,27,129,25,"Error"],[135,32,129,30],[135,33,129,31],[135,55,129,53],[135,56,129,54],[136,4,130,2],[136,11,130,9],[136,17,130,15,"res"],[136,20,130,18],[136,21,130,19,"json"],[136,25,130,23],[136,26,130,24],[136,27,130,25],[137,2,131,0],[138,0,131,1],[138,3]],"functionMap":{"names":["<global>","getAuthHeaders","getMailSummary","getMailRewards","getMailMessages","getMailGifts","claimMailReward","claimMailGift"],"mappings":"AAA;ACc;CDM;OEK;CFkB;OGK;CHgB;OIK;CJe;OKK;CLe;OMK;CNQ;OOK;CPQ"},"hasCjsExports":false},"type":"js/module"}]}