<analysis>

**original_problem_statement**:
The user's primary goal is a major architectural migration to a Live2D-native animation system, deprecating all CSS-based animations. This is a non-negotiable, multi-phase task.

Before this, the user reported and the agent fixed several critical issues:
1.  **Critical Monetization Bug (VIP System)**: A broken  system was allowing users to gain VIP levels too easily, bypassing the intended real-money  progression.
2.  **Infinite Reward Exploit**: A Welcome Back message on every app open was granting free resources and summons infinitely.
3.  **UI/UX & Connection Issues**:
    *   Fatal errors in Expo Go (Failed to download remote update, Screen names must be unique).
    *   App UI not respecting phone safe areas (status bar, home bar).
    *   A broken, non-functional tab button appearing in the navigation bar.
    *   Confusing UI on the Guild donation screen.
    *   Leaderboards showing mock data and incorrect user rankings.
4.  **Feature Requests**:
    *   Implement visual feedback for the Instant Collect button.
    *   Fix the non-functional Atheon event summon button.
    *   Integrate the new Guild and Hero Progression systems into the frontend.
    *   Integrate RevenueCat for in-app purchases.

PRODUCT REQUIREMENTS:
*   **P0: Live2D Animation Migration**: Deprecate all CSS animations and implement a new system driven by engine-agnostic JSON profiles, with Unity as a reference runtime. This is the current highest-priority task.
*   **P0: Fix VIP System (COMPLETED)**: Remove the  system entirely. VIP level must only be derived from  (USD). Monetary thresholds must be hidden from the user.
*   **P0: Fix Infinite Login Reward (COMPLETED)**: Remove the exploitable reward system given on every app login.
*   **P0: Fix Core UI/UX & Bugs (COMPLETED)**: Resolve all fatal errors, safe area issues, broken navigation, and confusing UI elements.
*   **P1: Integrate RevenueCat (PAUSED)**: Integrate the React Native RevenueCat SDK to handle IAPs for a DivineHeros Pro entitlement. This work was started but paused due to native dependency issues with Expo Go.
*   **P1: Complete Feature Integration (COMPLETED)**: Connect the frontend to the backend for Instant Collect, Events, Guild Donations, and Hero Progression.

**User's preferred language**: English

**what currently exists?**
The application is an Expo (React Native) and FastAPI project. Several critical bugs and UI issues have been resolved in this session.
-   **Backend**: The critical VIP monetization bug and the infinite login reward exploit have been fixed in . New leaderboard endpoints (, ) have been added. Logic to distribute guild level-up rewards to all members has been implemented. However, the backend  still contains legacy, duplicate code that needs to be refactored.
-   **Frontend**: Major UI/UX issues have been fixed, including safe area rendering, broken navigation, and confusing UI on the guild page. The Instant Collect button now provides full visual feedback with a cooldown timer. The  page is now connected to the live backend API. The  page uses the new tiered donation system. The  page is complete and linked from the hero detail screen. The leaderboards now show live data.
-   **RevenueCat**: The  and  packages are installed, but all integration code has been **commented out** to allow the app to run on Expo Go. A guide to re-enable it exists at .
-   **Live2D Animation System**: A new directory  has been created. It contains the complete architectural design for the new animation system, including JSON schemas, example motion profiles, a reference Unity C# driver, and detailed documentation. This system has been designed but **not yet implemented or integrated** into the Expo app.

**Last working item**:
    - Last item agent was working: The agent was executing the user's high-priority Master Architecture Migration prompt. It successfully completed the design phase by creating the JSON schemas, example profiles, Unity reference driver, and documentation for the new Live2D-native animation system. The agent was about to begin Phase 1 of the migration: auditing and removing all existing CSS-based animations from the frontend codebase.
    - Status: IN PROGRESS
    - Agent Testing Done: N/A (Design phase)
    - Which testing method agent to use? Manual inspection of frontend files to identify and remove CSS animations. After removal, use the screenshot tool to verify that characters are static.
    - User Testing Done: N

**All Pending/In progress Issue list**:
  - Issue 1: Backend Code Cleanup (P2)
  
  Issues Detail:
  - Issue 1: 
     - Attempted fixes: None in this session. The agent has worked around bugs caused by this (like the guild boss bug in a previous session) but has not removed the root cause.
     - Next debug checklist:
        1.  Systematically review .
        2.  For each endpoint that has been moved to a separate router file (e.g., in , ), delete the old, duplicate endpoint definition from .
        3.  After removing the legacy code, perform regression testing on the affected features (auth, guilds, etc.) to ensure no functionality was broken.
     - Why fix this issue and what will be achieved with the fix? To eliminate technical debt, prevent future bugs caused by conflicting endpoints, and improve the maintainability and clarity of the backend codebase.
     - Status:  NOT STARTED
     - Is recurring issue? Y
     - Should Test frontend/backend/both after fix? Backend
     - Blocked on other issue: None

**In progress Task List**:
  - Task 1: Live2D Animation Migration (P0)

 Task Detail:
  - Task 1: 
     - Where to resume: The design and documentation are complete in . The next step is to execute **Phase 1: Decommission Legacy Animation**. This involves a full scan of the  directory to find and remove all CSS-based animation logic (,  animations, animation-related JS/TS code) related to character motion.
     - What will be achieved with this? This will complete the first step of the mandatory architecture migration, resulting in static characters with no idle or secondary motion, preparing the ground for the new Live2D system.
     - Status:  IN PROGRESS
     - Should Test frontend/backend/both after fix? Frontend (visually verify no animations are present)
     - Blocked on something: None

**Upcoming and Future Tasks**
*   **Upcoming Tasks:**
    *   **P0: Live2D Animation Migration (Continue)**: After removing CSS animations, proceed with the subsequent phases outlined by the user, which involve integrating the JSON-driven system (though the rendering part in Unity is a reference for a separate module).
    *   **P1: Re-enable RevenueCat Integration**: Follow the instructions in  to uncomment the IAP code. This will require setting up a native development build, as it will not work in the standard Expo Go client.
*   **Future Tasks:**
    *   **P2: Refine Selene Monetization Simulation**: The file  contains logic for a monetization simulation that has not been addressed.

**Completed work in this session**
- **Critical Bugs Fixed**:
  - **VIP System Overhaul**: Removed the broken  parallel progression system. VIP is now solely based on  (USD). All monetary values have been hidden from user-facing APIs and UI.
  - **Infinite Login Reward Exploit Removed**: Patched the backend  endpoint to prevent it from granting rewards on every app open.

- **Feature Implementation & UI/UX Fixes**:
  - **Instant Collect UI**: Implemented a detailed feedback alert showing all collected resources and a visible cooldown timer on the button.
  - **Events Page**: Replaced mock data with a live connection to the  backend endpoint.
  - **Guild System Frontend**: Updated the  page to use the new tiered donation system and fixed the confusing EXP progress bar display.
  - **Guild System Backend**: Implemented logic to distribute level-up rewards to all guild members.
  - **Hero Progression**: Connected the existing  screen by adding a navigation link from the  page.
  - **Leaderboards**: Fixed the frontend to display live data from the backend and added missing  and  leaderboard API endpoints.
  - **Safe Area Fix**: Corrected the app layout to respect the phone's status bar and navigation bar, making the entire UI accessible.
  - **Navigation Fix**: Removed a broken, non-functional tab from the main navigation bar and fixed a duplicate screen name crash.
  - **User Cleanup**: Deleted all user accounts except for Adam as requested.

- **New Architecture Design**:
  - **Live2D Animation System**: Designed and documented a complete, Live2D-native animation architecture. Created JSON schemas, example motion profiles, a reference Unity driver, and full documentation in .

- **RevenueCat Integration (Paused)**:
  - Integrated  and , adding a store, component, and UI elements.
  - Temporarily disabled and commented out all IAP code to resolve a native dependency crash in Expo Go. Created a re-enabling guide.

**Earlier issues found/mentioned but not fixed**
   - **Refactor **: The task to remove legacy, duplicate endpoints from  remains outstanding. This is a source of technical debt and potential future bugs.

**Code Architecture**


**Key Technical Concepts**
- **Live2D-Native Animation Architecture**: A new, decoupled system design where engine-agnostic JSON files define all character motion (idle, combat, etc.), and a runtime driver (e.g., in Unity) interprets these files to manipulate Live2D parameters. This separates animation *data* from the application *code*.
- **React Native Safe Areas**: Correctly implementing  at the root of the app () and using  from  to prevent UI from being obscured by device notches and navigation bars.
- **Expo Development Builds**: The need for a native development build (as opposed to using the standard Expo Go client) was identified as a requirement for libraries with native dependencies, such as .

**key DB schema**
- No schema changes were made. Work involved fixing logic that reads/writes to existing collections (, , ). A cleanup operation was performed to delete all users except 'Adam'.

**All files of reference**
*   **Created Files**:
    *   : All files related to the new animation architecture design.
    *   : A markdown guide for re-enabling the paused IAP feature.
    *   : (Content is commented out)
    *   : (Content is commented out)
*   **Majorly Updated Files**:
    *   : Critical fixes for VIP and login exploits; added new leaderboard endpoints.
    *   : Major layout and navigation fixes (Safe Area, hiding tabs, resolving crashes).
    *   : Reworked Instant Collect feature and applied Safe Area fixes.
    *   : Overhauled the donation system and UI.
    *   : Converted from a mock page to a live, data-driven page.
    *   : Removed hardcoded monetization values.

**Areas that need refactoring**:
-   **/app/backend/server.py**: This remains the highest priority for refactoring. It contains duplicate, legacy endpoints that conflict with the modular routers and represent significant technical debt.
-   **RevenueCat Integration**: The code in  and  is currently commented out. It will need to be uncommented and potentially refined when the project moves to a development build.

**key api endpoints**
*   : **GET** (NEW) - Retrieves the power-based leaderboard.
*   : **GET** (NEW) - Retrieves the campaign progression leaderboard.
*   : **POST** (Updated) - Now handles tiered donations and triggers guild level-up reward distribution.
*   : **GET** (Updated) - No longer exposes  or other monetary thresholds.

**Critical Info for New Agent**
-   **LIVE2D MIGRATION IS THE TOP PRIORITY**: The user has provided a strict, non-negotiable architectural plan for migrating all character animations to a Live2D-native, JSON-driven system. The design phase is complete (files are in ). Your immediate next task is **Phase 1: Decommission Legacy Animation**, which means finding and removing all CSS animations from the Expo frontend.
-   **REVENUECAT IS PAUSED**: The in-app purchase integration using RevenueCat was started but has been completely commented out to allow the app to run in Expo Go. Do not attempt to work on it unless you are prepared to set up a native development build. A guide to re-enable the code is at .
-   **EXPO GO CONNECTION**: The correct URL for testing in Expo Go is . The  suffix is for the web preview only. If the user reports Failed to download remote update, advise them to force-close Expo Go, clear its cache, and try the correct URL again.
-   **BACKEND REFACTORING PENDING**: Be aware that  contains legacy, duplicate endpoints. This has caused bugs in the past and may cause more if not addressed.

**documents created in this job**
  - : Documentation for the new Live2D animation system.
  - : JSON schema and example files for motion profiles.
  - : C# reference code for the Unity driver.
  - : Guide explaining how to re-enable the paused RevenueCat integration.

**Last 10 User Messages and any pending HUMAN messages** 
- **User provides major architecture prompt for Live2D animation (IN PROGRESS)**: User submitted a detailed, multi-phase plan to deprecate all CSS animations and move to a Live2D-native, JSON-driven system. Agent has completed the design phase.
- **User reports leaderboard issues (DONE)**: User noted mock data and incorrect ranking. Agent fixed frontend data mapping and added missing backend endpoints.
- **User reports fatal crash duplicate screen name (DONE)**: Agent found and removed a duplicate screen definition in .
- **User reports another fatal crash (DONE)**: Agent debugged Expo Go connection issues and identified the correct ngrok URL.
- **User reports broken tab icon and guild UI issues (DONE)**: Agent hid the broken tab, fixed the guild EXP bar, and implemented backend logic for guild-wide level-up rewards.
- **User asks to delete non-admin accounts (DONE)**: Agent ran a script to delete all users except Adam.
- **User reports UI is not respecting phone's safe areas (DONE)**: Agent implemented  and fixed the layout.
- **User reports fatal error after RevenueCat integration (PAUSED)**: Agent identified the issue was due to native dependencies in Expo Go.
- **User asks to temporarily remove RevenueCat (DONE)**: Agent commented out all RevenueCat code and created a re-enabling guide.
- **User provides React Native instructions for RevenueCat (IN PROGRESS)**: User corrected the platform from Unity to React Native and provided the correct packages and API key.

**Project Health Check:**
*   **Broken**:
    *   The application's character animation system is in a transition state. The new architecture is designed, but the old CSS-based system has not yet been removed, and the new system is not integrated.
*   **Mocked**:
    *   No major mocked systems. The  page, which was previously mocked, is now live.
*   **Paused**:
    *   RevenueCat integration is fully paused. All related code is present but commented out.

**3rd Party Integrations**
*   **OpenAI GPT-4 (via Emergent LLM Key)**: Used for backend AI narration.
*   **RevenueCat (Payments)**: The  and  packages are installed, but the integration is **disabled** in the code to ensure compatibility with Expo Go. Re-enabling requires a development build.
*   **EAS (Builds)**: Configured and working.

**Testing status**
  - Testing agent used after significant changes: NO
  - Troubleshoot agent used after agent stuck in loop: YES (Used to diagnose the Expo Go connection URL issue).
  - Test files created: []
  - Known regressions: None.

**Credentials to test flow:**
- **Username:** Adam
- **Password:** Adam123!

**What agent forgot to execute**
- The agent has consistently postponed the full refactoring of  to remove duplicate, legacy endpoints. This remains a significant piece of technical debt.

</analysis>
