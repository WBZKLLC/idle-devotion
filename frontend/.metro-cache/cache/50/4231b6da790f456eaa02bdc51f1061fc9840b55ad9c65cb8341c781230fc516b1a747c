{"dependencies":[{"name":"react-native-web/dist/exports/Alert","data":{"asyncType":null,"isESMImport":false,"locs":[],"key":"PEUC6jrQVoAGZ2qYkvimljMOyJI=","exportNames":["*"],"imports":1}}],"output":[{"data":{"code":"__d(function (global, require, _$$_IMPORT_DEFAULT, _$$_IMPORT_ALL, module, exports, _dependencyMap) {\n  \"use strict\";\n\n  Object.defineProperty(exports, '__esModule', {\n    value: true\n  });\n  function _interopDefault(e) {\n    return e && e.__esModule ? e : {\n      default: e\n    };\n  }\n  exports.safeMutation = safeMutation;\n  exports.createMutationExecutor = createMutationExecutor;\n  exports.preventOptimisticUpdate = preventOptimisticUpdate;\n  var _reactNativeWebDistExportsAlert = require(_dependencyMap[0], \"react-native-web/dist/exports/Alert\");\n  var Alert = _interopDefault(_reactNativeWebDistExportsAlert);\n  // /app/frontend/lib/safeMutation.ts\n  // SAFE MUTATION WRAPPER\n  // Enforces consistent loading/success/failure patterns for all state mutations\n  // Prevents optimistic updates and ensures server-authoritative state\n\n  /**\n   * Options for safeMutation\n   */\n\n  /**\n   * Safe mutation wrapper that enforces consistent patterns:\n   * 1. Always awaits the server response\n   * 2. Optionally refreshes user state after success\n   * 3. Handles errors with shared messaging\n   * 4. Never assumes success - state only updates after server confirms\n   * \n   * @param actionName - Name of the action for logging\n   * @param fn - The async mutation function to execute\n   * @param opts - Options for customizing behavior\n   * @returns The result of the mutation, or undefined if it failed\n   * \n   * @example\n   * ```tsx\n   * const result = await safeMutation(\n   *   'pullGacha',\n   *   () => apiPullGacha(username, 'single', 'coins'),\n   *   { \n   *     refreshUser: true, \n   *     fetchUserFn: fetchUser,\n   *     onSuccess: (data) => setHeroes(data.heroes)\n   *   }\n   * );\n   * ```\n   */\n  async function safeMutation(actionName, fn, opts = {}) {\n    const {\n      onSuccess,\n      onError,\n      refreshUser = true,\n      fetchUserFn,\n      showErrorAlert = false,\n      errorMessage\n    } = opts;\n    try {\n      console.log(`[safeMutation] Starting: ${actionName}`);\n\n      // Execute the mutation - ALWAYS await server response\n      const result = await fn();\n      console.log(`[safeMutation] Success: ${actionName}`);\n\n      // Refresh user state from server (authoritative source)\n      if (refreshUser && fetchUserFn) {\n        try {\n          await fetchUserFn();\n        } catch (refreshError) {\n          console.error(`[safeMutation] Failed to refresh user after ${actionName}:`, refreshError);\n          // Don't fail the mutation if refresh fails - the mutation succeeded\n        }\n      }\n\n      // Call success callback\n      if (onSuccess) {\n        await onSuccess(result);\n      }\n      return result;\n    } catch (error) {\n      console.error(`[safeMutation] Failed: ${actionName}`, error);\n\n      // Call error callback\n      if (onError) {\n        onError(error);\n      }\n\n      // Show error alert if requested (usually the interceptor handles this)\n      if (showErrorAlert) {\n        const message = errorMessage || error?.response?.data?.detail || error?.message || 'Something went wrong';\n        Alert.default.alert('Error', message);\n      }\n\n      // Don't re-throw - return undefined to indicate failure\n      // This allows screens to check: if (result) { ... }\n      return undefined;\n    }\n  }\n\n  /**\n   * Hook-friendly version that returns loading state\n   * Use this when you need loading indicators in components\n   * \n   * @example\n   * ```tsx\n   * const { execute, isLoading } = useSafeMutation();\n   * \n   * const handlePull = async () => {\n   *   const result = await execute('pullGacha', () => pullGacha('single', 'coins'));\n   *   if (result) setHeroes(result.heroes);\n   * };\n   * ```\n   */\n  function createMutationExecutor(fetchUserFn) {\n    return async function executeMutation(actionName, fn, opts = {}) {\n      return safeMutation(actionName, fn, {\n        ...opts,\n        fetchUserFn\n      });\n    };\n  }\n\n  /**\n   * NO-OP optimistic update prevention\n   * Use this to wrap any attempted optimistic updates during refactoring\n   * \n   * @deprecated Remove once all optimistic updates are eliminated\n   */\n  function preventOptimisticUpdate(actionName, _setter) {\n    console.warn(`[BLOCKED] Optimistic update attempted for \"${actionName}\". ` + `State should only update after server confirms. Use safeMutation instead.`);\n    // Do NOT call the setter - this is intentional\n  }\n});","lineCount":135,"map":[[12,2,59,0,"exports"],[12,9,59,0],[12,10,59,0,"safeMutation"],[12,22,59,0],[12,25,59,0,"safeMutation"],[12,37,59,0],[13,2,132,0,"exports"],[13,9,132,0],[13,10,132,0,"createMutationExecutor"],[13,32,132,0],[13,35,132,0,"createMutationExecutor"],[13,57,132,0],[14,2,151,0,"exports"],[14,9,151,0],[14,10,151,0,"preventOptimisticUpdate"],[14,33,151,0],[14,36,151,0,"preventOptimisticUpdate"],[14,59,151,0],[15,2,160,1],[15,6,160,1,"_reactNativeWebDistExportsAlert"],[15,37,160,1],[15,40,160,1,"require"],[15,47,160,1],[15,48,160,1,"_dependencyMap"],[15,62,160,1],[16,2,160,1],[16,6,160,1,"Alert"],[16,11,160,1],[16,14,160,1,"_interopDefault"],[16,29,160,1],[16,30,160,1,"_reactNativeWebDistExportsAlert"],[16,61,160,1],[17,2,1,0],[18,2,2,0],[19,2,3,0],[20,2,4,0],[22,2,8,0],[23,0,9,0],[24,0,10,0],[26,2,34,0],[27,0,35,0],[28,0,36,0],[29,0,37,0],[30,0,38,0],[31,0,39,0],[32,0,40,0],[33,0,41,0],[34,0,42,0],[35,0,43,0],[36,0,44,0],[37,0,45,0],[38,0,46,0],[39,0,47,0],[40,0,48,0],[41,0,49,0],[42,0,50,0],[43,0,51,0],[44,0,52,0],[45,0,53,0],[46,0,54,0],[47,0,55,0],[48,0,56,0],[49,0,57,0],[50,0,58,0],[51,2,59,7],[51,17,59,22,"safeMutation"],[51,29,59,34,"safeMutation"],[51,30,60,2,"actionName"],[51,40,60,20],[51,42,61,2,"fn"],[51,44,61,22],[51,46,62,2,"opts"],[51,50,62,30],[51,53,62,33],[51,54,62,34],[51,55,62,35],[51,57,63,26],[52,4,64,2],[52,10,64,8],[53,6,65,4,"onSuccess"],[53,15,65,13],[54,6,66,4,"onError"],[54,13,66,11],[55,6,67,4,"refreshUser"],[55,17,67,15],[55,20,67,18],[55,24,67,22],[56,6,68,4,"fetchUserFn"],[56,17,68,15],[57,6,69,4,"showErrorAlert"],[57,20,69,18],[57,23,69,21],[57,28,69,26],[58,6,70,4,"errorMessage"],[59,4,71,2],[59,5,71,3],[59,8,71,6,"opts"],[59,12,71,10],[60,4,73,2],[60,8,73,6],[61,6,74,4,"console"],[61,13,74,11],[61,14,74,12,"log"],[61,17,74,15],[61,18,74,16],[61,46,74,44,"actionName"],[61,56,74,54],[61,58,74,56],[61,59,74,57],[63,6,76,4],[64,6,77,4],[64,12,77,10,"result"],[64,18,77,16],[64,21,77,19],[64,27,77,25,"fn"],[64,29,77,27],[64,30,77,28],[64,31,77,29],[65,6,79,4,"console"],[65,13,79,11],[65,14,79,12,"log"],[65,17,79,15],[65,18,79,16],[65,45,79,43,"actionName"],[65,55,79,53],[65,57,79,55],[65,58,79,56],[67,6,81,4],[68,6,82,4],[68,10,82,8,"refreshUser"],[68,21,82,19],[68,25,82,23,"fetchUserFn"],[68,36,82,34],[68,38,82,36],[69,8,83,6],[69,12,83,10],[70,10,84,8],[70,16,84,14,"fetchUserFn"],[70,27,84,25],[70,28,84,26],[70,29,84,27],[71,8,85,6],[71,9,85,7],[71,10,85,8],[71,17,85,15,"refreshError"],[71,29,85,27],[71,31,85,29],[72,10,86,8,"console"],[72,17,86,15],[72,18,86,16,"error"],[72,23,86,21],[72,24,86,22],[72,71,86,69,"actionName"],[72,81,86,79],[72,84,86,82],[72,86,86,84,"refreshError"],[72,98,86,96],[72,99,86,97],[73,10,87,8],[74,8,88,6],[75,6,89,4],[77,6,91,4],[78,6,92,4],[78,10,92,8,"onSuccess"],[78,19,92,17],[78,21,92,19],[79,8,93,6],[79,14,93,12,"onSuccess"],[79,23,93,21],[79,24,93,22,"result"],[79,30,93,28],[79,31,93,29],[80,6,94,4],[81,6,96,4],[81,13,96,11,"result"],[81,19,96,17],[82,4,98,2],[82,5,98,3],[82,6,98,4],[82,13,98,11,"error"],[82,18,98,21],[82,20,98,23],[83,6,99,4,"console"],[83,13,99,11],[83,14,99,12,"error"],[83,19,99,17],[83,20,99,18],[83,46,99,44,"actionName"],[83,56,99,54],[83,58,99,56],[83,60,99,58,"error"],[83,65,99,63],[83,66,99,64],[85,6,101,4],[86,6,102,4],[86,10,102,8,"onError"],[86,17,102,15],[86,19,102,17],[87,8,103,6,"onError"],[87,15,103,13],[87,16,103,14,"error"],[87,21,103,19],[87,22,103,20],[88,6,104,4],[90,6,106,4],[91,6,107,4],[91,10,107,8,"showErrorAlert"],[91,24,107,22],[91,26,107,24],[92,8,108,6],[92,14,108,12,"message"],[92,21,108,19],[92,24,108,22,"errorMessage"],[92,36,108,34],[92,40,108,38,"error"],[92,45,108,43],[92,47,108,45,"response"],[92,55,108,53],[92,57,108,55,"data"],[92,61,108,59],[92,63,108,61,"detail"],[92,69,108,67],[92,73,108,71,"error"],[92,78,108,76],[92,80,108,78,"message"],[92,87,108,85],[92,91,108,89],[92,113,108,111],[93,8,109,6,"Alert"],[93,13,109,11],[93,14,109,11,"default"],[93,21,109,11],[93,22,109,12,"alert"],[93,27,109,17],[93,28,109,18],[93,35,109,25],[93,37,109,27,"message"],[93,44,109,34],[93,45,109,35],[94,6,110,4],[96,6,112,4],[97,6,113,4],[98,6,114,4],[98,13,114,11,"undefined"],[98,22,114,20],[99,4,115,2],[100,2,116,0],[102,2,118,0],[103,0,119,0],[104,0,120,0],[105,0,121,0],[106,0,122,0],[107,0,123,0],[108,0,124,0],[109,0,125,0],[110,0,126,0],[111,0,127,0],[112,0,128,0],[113,0,129,0],[114,0,130,0],[115,0,131,0],[116,2,132,7],[116,11,132,16,"createMutationExecutor"],[116,33,132,38,"createMutationExecutor"],[116,34,132,39,"fetchUserFn"],[116,45,132,72],[116,47,132,74],[117,4,133,2],[117,11,133,9],[117,26,133,24,"executeMutation"],[117,41,133,39,"executeMutation"],[117,42,134,4,"actionName"],[117,52,134,22],[117,54,135,4,"fn"],[117,56,135,24],[117,58,136,4,"opts"],[117,62,136,53],[117,65,136,56],[117,66,136,57],[117,67,136,58],[117,69,137,28],[118,6,138,4],[118,13,138,11,"safeMutation"],[118,25,138,23],[118,26,138,24,"actionName"],[118,36,138,34],[118,38,138,36,"fn"],[118,40,138,38],[118,42,138,40],[119,8,139,6],[119,11,139,9,"opts"],[119,15,139,13],[120,8,140,6,"fetchUserFn"],[121,6,141,4],[121,7,141,5],[121,8,141,6],[122,4,142,2],[122,5,142,3],[123,2,143,0],[125,2,145,0],[126,0,146,0],[127,0,147,0],[128,0,148,0],[129,0,149,0],[130,0,150,0],[131,2,151,7],[131,11,151,16,"preventOptimisticUpdate"],[131,34,151,39,"preventOptimisticUpdate"],[131,35,152,2,"actionName"],[131,45,152,20],[131,47,153,2,"_setter"],[131,54,153,21],[131,56,154,8],[132,4,155,2,"console"],[132,11,155,9],[132,12,155,10,"warn"],[132,16,155,14],[132,17,156,4],[132,63,156,50,"actionName"],[132,73,156,60],[132,78,156,65],[132,81,157,4],[132,156,158,2],[132,157,158,3],[133,4,159,2],[134,2,160,0],[135,0,160,1],[135,3]],"functionMap":{"names":["<global>","safeMutation","createMutationExecutor","executeMutation","preventOptimisticUpdate"],"mappings":"AAA;OC0D;CDyD;OEgB;SCC;GDS;CFC;OIQ;CJS"},"hasCjsExports":false},"type":"js/module"}]}